{% extends 'base.html' %}

{% block title %}AI 챗봇 - 문서 질의응답{% endblock %}

{% block extra_css %}
<style>
    .chat-container { height: 70vh; max-height: 600px; }
    .chat-messages { height: 100%; overflow-y: auto; padding: 20px; background: linear-gradient(to bottom, #f8f9fa, #ffffff); }
    .message { margin-bottom: 20px; display: flex; align-items: flex-start; animation: fadeInUp 0.3s ease-out; }
    .message.user { flex-direction: row-reverse; }
    .message-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; flex-shrink: 0; }
    .message.user .message-avatar { background: linear-gradient(135deg, #007bff, #0056b3); margin-left: 10px; }
    .message.assistant .message-avatar { background: linear-gradient(135deg, #28a745, #1e7e34); margin-right: 10px; }
    .message-content { max-width: 70%; padding: 12px 16px; border-radius: 18px; position: relative; word-wrap: break-word; }
    .message.user .message-content { background: linear-gradient(135deg, #007bff, #0056b3); color: white; margin-right: 10px; border-bottom-right-radius: 4px; }
    .message.assistant .message-content { background: white; border: 1px solid #e9ecef; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-bottom-left-radius: 4px; }
    .chat-input-container { background: white; border-top: 1px solid #e9ecef; padding: 20px; }
    .chat-input { border: 2px solid #e9ecef; border-radius: 25px; padding: 12px 20px; font-size: 16px; resize: none; transition: all 0.3s ease; }
    .chat-input:focus { border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
    .btn-send { border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border: none; background: linear-gradient(135deg, #007bff, #0056b3); color: white; transition: all 0.3s ease; }
    .btn-send:hover:not(:disabled) { background: linear-gradient(135deg, #0056b3, #004494); transform: scale(1.05); }
    .btn-send:disabled { opacity: 0.6; cursor: not-allowed; }
    .typing-indicator { display: none; align-items: center; padding: 10px 16px; background: white; border: 1px solid #e9ecef; border-radius: 18px; margin-left: 50px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .typing-dots { display: flex; gap: 4px; }
    .typing-dots span { width: 8px; height: 8px; border-radius: 50%; background-color: #007bff; animation: typing 1.4s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-10px); opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .empty-state { text-align: center; padding: 40px 20px; color: #6c757d; }
    .empty-state i { font-size: 48px; margin-bottom: 20px; opacity: 0.5; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card card-shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-gradient">
                        <i class="fas fa-robot me-2"></i>AI 챗봇
                    </h5>
                    <div class="d-flex gap-2">
                        <span class="badge bg-success" id="connection-status">연결됨</span>
                        <button class="btn btn-sm btn-outline-secondary" id="clear-chat-btn">
                            <i class="fas fa-trash me-1"></i>채팅 지우기
                        </button>
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="empty-state">
                            <i class="fas fa-robot"></i>
                            <h4>안녕하세요! 👋</h4>
                            <p class="text-muted">
                                무엇을 도와드릴까요?<br>
                                문서에 관한 질문이나 일반적인 대화를 나눌 수 있습니다.
                            </p>
                        </div>
                    </div>
                    
                    <div class="typing-indicator" id="typing-indicator">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="ms-2 text-muted">AI가 답변을 생성하고 있습니다...</span>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="d-flex gap-3">
                        <textarea 
                            class="form-control chat-input" 
                            id="message-input" 
                            placeholder="메시지를 입력하세요..." 
                            rows="1"
                            maxlength="1000"
                        ></textarea>
                        <button class="btn btn-send" id="send-btn" type="button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="mt-2 d-flex justify-content-between">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter로 전송, Shift+Enter로 줄바꿈
                        </small>
                        <small class="text-muted">
                            <span id="char-count">0</span>/1000
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSessionId = null;
let isTyping = false;

const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const typingIndicator = document.getElementById('typing-indicator');
const charCount = document.getElementById('char-count');
const clearChatBtn = document.getElementById('clear-chat-btn');
const connectionStatus = document.getElementById('connection-status');

document.addEventListener('DOMContentLoaded', () => {
    initializeChat();
    setupEventListeners();
});

function initializeChat() {
    messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
        charCount.textContent = messageInput.value.length;
    });
    
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

function setupEventListeners() {
    sendBtn.addEventListener('click', sendMessage);
    clearChatBtn.addEventListener('click', clearCurrentChat);
    setInterval(checkConnectionStatus, 30000);
}

async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || isTyping) return;
    
    addMessage('user', message);
    messageInput.value = '';
    messageInput.style.height = 'auto';
    charCount.textContent = '0';
    showTypingIndicator();
    
    try {
        const response = await fetch('/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: message,
                session_id: currentSessionId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (!currentSessionId) {
                currentSessionId = data.session_id;
            }
            addMessage('assistant', data.response, {
                queryType: data.query_type,
                retrievedDocsCount: data.retrieved_docs_count,
                responseTime: data.response_time
            });
        } else {
            throw new Error(data.error || '응답 오류');
        }
        
    } catch (error) {
        console.error('Send message error:', error);
        addMessage('assistant', '죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.');
        showToast('메시지 전송 실패', 'error');
    } finally {
        hideTypingIndicator();
    }
}

function addMessage(type, content, meta = {}) {
    const emptyState = chatMessages.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    messageContent.textContent = content;
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(messageContent);
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    isTyping = true;
    sendBtn.disabled = true;
    typingIndicator.style.display = 'flex';
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
    isTyping = false;
    sendBtn.disabled = false;
    typingIndicator.style.display = 'none';
}

function clearCurrentChat() {
    if (!confirm('현재 채팅을 지우시겠습니까?')) return;
    
    chatMessages.innerHTML = `
        <div class="empty-state">
            <i class="fas fa-robot"></i>
            <h4>채팅이 지워졌습니다</h4>
            <p class="text-muted">새로운 대화를 시작해보세요!</p>
        </div>
    `;
    currentSessionId = null;
    showToast('채팅이 지워졌습니다', 'info');
}

async function checkConnectionStatus() {
    try {
        const response = await fetch('/health/', { 
            method: 'GET',
            signal: AbortSignal.timeout(5000)
        });
        
        if (response.ok) {
            connectionStatus.textContent = '연결됨';
            connectionStatus.className = 'badge bg-success';
        } else {
            throw new Error('Connection failed');
        }
    } catch (error) {
        connectionStatus.textContent = '연결 끊김';
        connectionStatus.className = 'badge bg-danger';
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 