<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¬ MCP ë„êµ¬ í™œìš© ì—ì´ì „íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Streamlitê³¼ ìœ ì‚¬í•œ ìŠ¤íƒ€ì¼ë§ */
        .sidebar {
            background-color: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }
        .chat-container {
            height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- CSRF í† í°ì„ ë©”íƒ€ íƒœê·¸ë¡œ ì¶”ê°€ -->
    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    
    <div class="flex h-screen">
        <!-- ì‚¬ì´ë“œë°” (Streamlit sidebarì™€ ë™ì¼í•œ êµ¬ì¡°) -->
        <div class="sidebar w-1/4 p-4 overflow-y-auto">
            <div class="mb-4">
                <h3 class="text-lg font-bold">âœï¸ Made by <a href="https://youtube.com/c/teddynote" class="text-blue-600">í…Œë””ë…¸íŠ¸</a> ğŸš€</h3>
                <p class="text-sm">ğŸ’» <a href="https://github.com/teddynote-lab/langgraph-mcp-agents" class="text-blue-600">Project Page</a></p>
            </div>
            
            <hr class="my-4">
            
            <!-- ì‹œìŠ¤í…œ ì„¤ì • -->
            <div class="mb-6">
                <h4 class="font-bold mb-2">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h4>
                <select id="modelSelect" class="w-full p-2 border rounded">
                    {% for model in available_models %}
                    <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </select>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium">â±ï¸ ì‘ë‹µ ìƒì„± ì œí•œ ì‹œê°„(ì´ˆ)</label>
                    <input type="range" id="timeoutSlider" min="60" max="300" value="120" class="w-full">
                    <span id="timeoutValue">120</span>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- ë„êµ¬ ì„¤ì • -->
            <div class="mb-6">
                <h4 class="font-bold mb-2">ğŸ”§ ë„êµ¬ ì„¤ì •</h4>
                <details class="border rounded p-2">
                    <summary class="cursor-pointer">ğŸ§° MCP ë„êµ¬ ì¶”ê°€</summary>
                    <div class="mt-2">
                        <textarea id="toolConfig" class="w-full h-40 p-2 border rounded text-sm" 
                                  placeholder='{"ë„êµ¬ì´ë¦„": {"command": "...", "args": [...]}}'></textarea>
                        <button onclick="addTool()" class="w-full mt-2 bg-blue-500 text-white p-2 rounded">ë„êµ¬ ì¶”ê°€</button>
                    </div>
                </details>
                
                <!-- ë“±ë¡ëœ ë„êµ¬ ëª©ë¡ -->
                <div class="mt-4">
                    <h5 class="font-medium">ğŸ“‹ ë“±ë¡ëœ ë„êµ¬ ëª©ë¡</h5>
                    <div id="toolList">
                        {% for tool in mcp_tools %}
                        <div class="flex justify-between items-center py-1">
                            <span>- <strong>{{ tool.name }}</strong></span>
                            <button onclick="deleteTool('{{ tool.name }}')" class="text-red-500 text-sm">ì‚­ì œ</button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- ì‹œìŠ¤í…œ ì •ë³´ ë° ì‘ì—… ë²„íŠ¼ -->
            <div>
                <h4 class="font-bold mb-2">ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´</h4>
                <p class="text-sm">ğŸ› ï¸ MCP ë„êµ¬ ìˆ˜: <span id="toolCount">{{ mcp_tools.count }}</span></p>
                <p class="text-sm">ğŸ§  í˜„ì¬ ëª¨ë¸: <span id="currentModel">claude-3-7-sonnet-latest</span></p>
                
                <button onclick="applySettings()" id="applySettingsBtn" class="w-full mt-4 bg-green-500 text-white p-2 rounded">ì„¤ì • ì ìš©í•˜ê¸°</button>
                <button onclick="clearChat()" class="w-full mt-2 bg-gray-500 text-white p-2 rounded">ëŒ€í™” ì´ˆê¸°í™”</button>
            </div>
        </div>
        
        <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
        <div class="flex-1 flex flex-col">
            <header class="bg-white shadow-sm p-4">
                <h1 class="text-2xl font-bold">ğŸ’¬ MCP ë„êµ¬ í™œìš© ì—ì´ì „íŠ¸</h1>
                <p class="text-gray-600">âœ¨ MCP ë„êµ¬ë¥¼ í™œìš©í•œ ReAct ì—ì´ì „íŠ¸ì—ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”.</p>
            </header>
            
            <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="chatMessages" class="chat-container flex-1 p-4 space-y-4">
                <!-- ì±„íŒ… ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            
            <!-- ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ -->
            <div class="bg-white border-t p-4">
                <div class="flex space-x-2">
                    <input type="text" id="messageInput" 
                           placeholder="ğŸ’¬ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" 
                           class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="sendMessage()" 
                            class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function initializeMCP() {
            try {
                const response = await fetch('/initialize-mcp/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('toolCount').textContent = data.tool_count;
                    console.log('âœ… MCP initialized:', data.tools);
                    
                    // ë„êµ¬ ëª©ë¡ ì—…ë°ì´íŠ¸
                    updateToolList(data.tools);
                } else {
                    console.error('âŒ MCP initialization failed:', data.error);
                    alert('MCP ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
            } catch (error) {
                console.error('âŒ MCP initialization error:', error);
                alert('MCP ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function addTool() {
            const configText = document.getElementById('toolConfig').value;
            
            try {
                const config = JSON.parse(configText);
                
                const response = await fetch('/save-config/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('ë„êµ¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ë„êµ¬ ì¶”ê°€ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (error) {
                alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function deleteTool(toolName) {
            if (confirm(`${toolName} ë„êµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                try {
                    const response = await fetch('/delete-tool/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({tool_name: toolName})
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('ë„êµ¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        location.reload();
                    } else {
                        alert('ë„êµ¬ ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
                    }
                } catch (error) {
                    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }

        // ì„¤ì • ì ìš© í•¨ìˆ˜ (í•˜ë‚˜ë§Œ ìœ ì§€, ì¤‘ë³µ ì œê±°)
        async function applySettings() {
            const btn = document.getElementById('applySettingsBtn');
            if (!btn) {
                console.error('âŒ applySettingsBtnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const originalText = btn.textContent;
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            btn.disabled = true;
            btn.textContent = 'ì ìš© ì¤‘...';
            btn.className = 'w-full mt-4 bg-gray-400 text-white p-2 rounded cursor-not-allowed';
            
            try {
                console.log('ğŸ”„ ì„¤ì • ì ìš© ì‹œì‘...');
                
                // ì‚¬ìš©ì ì„ íƒ ì„¤ì • ì •ë³´ ìˆ˜ì§‘ (ì¤‘ìš”: ëª¨ë¸ ì„ íƒ ì •ë³´ í¬í•¨)
                const selectedModel = document.getElementById('modelSelect').value;
                const timeoutSeconds = parseInt(document.getElementById('timeoutSlider').value);
                
                console.log(`ğŸ¯ ì„ íƒëœ ëª¨ë¸: ${selectedModel}`);
                
                // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
                const csrftoken = getCookie('csrftoken') || 
                                document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (csrftoken) {
                    headers['X-CSRFToken'] = csrftoken;
                }
                
                const response = await fetch('/apply-settings/', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        'action': 'apply_settings',
                        'selected_model': selectedModel,  // ì„ íƒëœ ëª¨ë¸ ì •ë³´ ì „ì†¡
                        'timeout_seconds': timeoutSeconds,
                        'timestamp': new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
                }
                
                const data = await response.json();
                console.log('âœ… ì„œë²„ ì‘ë‹µ:', data);
                
                if (data.success) {
                    alert('âœ… ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    document.getElementById('toolCount').textContent = data.tool_count || 0;
                    
                    // í˜„ì¬ ëª¨ë¸ ì •ë³´ ì—…ë°ì´íŠ¸ (ì„¸ì…˜ì—ì„œ ëª¨ë¸ ì„ íƒ ì •ë³´ ìœ ì§€ í™•ì¸)
                    if (data.user_settings && data.user_settings.selected_model) {
                        document.getElementById('currentModel').textContent = data.user_settings.selected_model;
                        document.getElementById('modelSelect').value = data.user_settings.selected_model;
                        console.log(`âœ… ëª¨ë¸ ì„ íƒ ì •ë³´ ìœ ì§€ í™•ì¸: ${data.user_settings.selected_model}`);
                    }
                    
                } else {
                    throw new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('âŒ ì„¤ì • ì ìš© ì˜¤ë¥˜:', error);
                alert('âŒ ì„¤ì • ì ìš© ì‹¤íŒ¨: ' + error.message);
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                btn.disabled = false;
                btn.textContent = originalText;
                btn.className = 'w-full mt-4 bg-green-500 text-white p-2 rounded hover:bg-green-600';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì„¤ì • ë³µì›
        document.addEventListener('DOMContentLoaded', function() {
            // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
            fetch('/get-user-settings/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.user_settings) {
                        console.log('ğŸ”„ ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì„¤ì • ë³µì›:', data.user_settings);
                        
                        // ëª¨ë¸ ì„ íƒ ë³µì› (ì¤‘ìš”!)
                        const modelSelect = document.getElementById('modelSelect');
                        if (modelSelect && data.user_settings.selected_model) {
                            modelSelect.value = data.user_settings.selected_model;
                            document.getElementById('currentModel').textContent = data.user_settings.selected_model;
                            console.log(`âœ… ëª¨ë¸ ì„ íƒ ë³µì›: ${data.user_settings.selected_model}`);
                        }
                        
                        // íƒ€ì„ì•„ì›ƒ ì„¤ì • ë³µì›
                        if (data.user_settings.timeout_seconds) {
                            document.getElementById('timeoutSlider').value = data.user_settings.timeout_seconds;
                            document.getElementById('timeoutValue').textContent = data.user_settings.timeout_seconds;
                        }
                        
                        // ë„êµ¬ ìˆ˜ ë³µì›
                        if (data.user_settings.tool_count) {
                            document.getElementById('toolCount').textContent = data.user_settings.tool_count;
                        }
                    }
                })
                .catch(error => console.error('ì‚¬ìš©ì ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error));
            
            // MCP ì´ˆê¸°í™”
            initializeMCP();
        });

        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        function updateToolList(tools) {
            const toolListDiv = document.getElementById('toolList');
            toolListDiv.innerHTML = '';
            
            tools.forEach(toolName => {
                const toolDiv = document.createElement('div');
                toolDiv.className = 'flex justify-between items-center py-1';
                toolDiv.innerHTML = `
                    <span>- <strong>${toolName}</strong></span>
                    <button onclick="deleteTool('${toolName}')" class="text-red-500 text-sm">ì‚­ì œ</button>
                `;
                toolListDiv.appendChild(toolDiv);
            });
        }

        // WebSocket ì—°ê²° ë° ì±„íŒ… ë¡œì§
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/'
        );
        
        let messages = [];
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            displayMessage(data);
        };
        
        // WebSocket ëŒ€ì‹  HTTP ê¸°ë°˜ ì±„íŒ…ìœ¼ë¡œ ë³€ê²½
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                return;
            }
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            displayMessage({
                role: 'user',
                content: message
            });
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            input.value = '';
            
            // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="bg-white border p-3 rounded-lg max-w-md">
                    <div class="flex items-center mb-1">
                        <span class="mr-2">ğŸ¤–</span>
                        <span class="font-medium">ì–´ì‹œìŠ¤í„´íŠ¸</span>
                    </div>
                    <p>ìƒê°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            `;
            document.getElementById('chatMessages').appendChild(loadingDiv);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            
            try {
                // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
                const csrftoken = getCookie('csrftoken') || 
                                document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (csrftoken) {
                    headers['X-CSRFToken'] = csrftoken;
                }
                
                // HTTP POSTë¡œ ë©”ì‹œì§€ ì „ì†¡
                const response = await fetch('/chat-message/', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        'message': message
                    })
                });
                
                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                const loadingElement = document.getElementById('loading-message');
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // ì–´ì‹œìŠ¤í„´íŠ¸ ì‘ë‹µ í‘œì‹œ
                    displayMessage({
                        role: 'assistant',
                        content: data.response || 'ì‘ë‹µì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.'
                    });
                } else {
                    throw new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                const loadingElement = document.getElementById('loading-message');
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                console.error('âŒ ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
                displayMessage({
                    role: 'assistant',
                    content: `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`
                });
            }
        }

        
        function displayMessage(data) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            if (data.role === 'user') {
                messageDiv.className = 'flex justify-end';
                messageDiv.innerHTML = `
                    <div class="bg-blue-500 text-white p-3 rounded-lg max-w-md">
                        <div class="flex items-center mb-1">
                            <span class="mr-2">ğŸ§‘â€ğŸ’»</span>
                            <span class="font-medium">ì‚¬ìš©ì</span>
                        </div>
                        <p>${data.content}</p>
                    </div>
                `;
            } else {
                messageDiv.className = 'flex justify-start';
                messageDiv.innerHTML = `
                    <div class="bg-white border p-3 rounded-lg max-w-md">
                        <div class="flex items-center mb-1">
                            <span class="mr-2">ğŸ¤–</span>
                            <span class="font-medium">ì–´ì‹œìŠ¤í„´íŠ¸</span>
                        </div>
                        <p>${data.content}</p>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function addTool() {
            const config = document.getElementById('toolConfig').value;
            // AJAXë¡œ ë„êµ¬ ì¶”ê°€ ë¡œì§
        }
        
        async function clearChat() {
            try {
                const response = await fetch('/clear-chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('chatMessages').innerHTML = '';
                    alert('ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ëŒ€í™” ì´ˆê¸°í™” ì‹¤íŒ¨: ' + data.error);
                }
            } catch (error) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
