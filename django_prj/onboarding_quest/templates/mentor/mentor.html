{% extends 'base.html' %}
{% load static %}

{% block title %}ë©˜í†  ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/mentor/mentor.css' %}">
{% endblock %}

{% block content %}
  <div class="main-content">
    <div class="bg-white rounded-xl shadow-sm p-8 mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">ì•ˆë…•í•˜ì„¸ìš” {{ request.user.last_name }}{{ request.user.first_name }}ë‹˜ ğŸŒŸ</h1>
      <p class="text-lg text-gray-600">ì˜¤ëŠ˜ë„ ë©˜í‹°ë¶„ë“¤ê³¼ í•¨ê»˜ ì„±ì¥í•˜ëŠ” ì—¬ì •ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
    </div>

    <div class="mentor-section bg-white rounded-xl shadow-sm p-8">
      <div class="flex justify-between items-center mb-8">
        <div class="flex gap-4">
          <div class="relative">
            <input type="text" id="searchInput" placeholder="ë©˜í‹° ì´ë¦„ì„ ê²€ìƒ‰í•´ì£¼ì„¸ìš”..." 
              class="pl-10 pr-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 w-64 text-base">
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <button id="searchBtn" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors text-base font-medium">
            ê²€ìƒ‰
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="mentorshipCards">
        <!-- ë©˜í† ì‹­ ì¹´ë“œë“¤ì´ JavaScriptë¡œ ë™ì  ë¡œë“œë©ë‹ˆë‹¤ -->
      </div>
      
      <!-- ë¡œë”© ìƒíƒœ -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-gray-600">ë©˜í† ì‹­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
      
      <!-- ë¹ˆ ìƒíƒœ -->
      <div id="emptyState" class="col-span-full text-center py-12" style="display: none;">
        <div class="text-gray-400 text-6xl mb-4">ğŸ“š</div>
        <h3 class="text-xl font-medium text-gray-500 mb-2">ê´€ë¦¬ ì¤‘ì¸ ë©˜í† ì‰½ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="text-gray-400">ìƒˆë¡œìš´ ë©˜í† ì‰½ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
        <a href="{% url 'mentor:manage_mentee' %}" class="mt-4 inline-block bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
          ë©˜í† ì‰½ ìƒì„±í•˜ê¸°
        </a>
      </div>
      
      <!-- ì˜¤ë¥˜ ìƒíƒœ -->
      <div id="errorState" class="col-span-full text-center py-12" style="display: none;">
        <div class="text-red-400 text-6xl mb-4">âš ï¸</div>
        <h3 class="text-xl font-medium text-red-500 mb-2">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="text-gray-400" id="errorMessage">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
        <button onclick="loadMentorships()" class="mt-4 inline-block bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
          ë‹¤ì‹œ ì‹œë„
        </button>
      </div>
    </div>
  </div>

<script>
// ì „ì—­ ë³€ìˆ˜
let mentorId = null;
const FASTAPI_BASE_URL = 'http://localhost:8001';

// í˜ì´ì§€ ë¡œë“œì‹œ ë©˜í† ì‹­ ë°ì´í„° ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    // ì„¸ì…˜ì—ì„œ user_id ê°€ì ¸ì˜¤ê¸°
    mentorId = getMentorIdFromSession();
    console.log('ë©˜í†  ID:', mentorId);
    
    if (mentorId) {
        loadMentorships();
    } else {
        showError('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    }
    
    // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMentees();
            }
        });
    }
    
    if (searchBtn) {
        searchBtn.addEventListener('click', searchMentees);
    }
});

// ì„¸ì…˜ì—ì„œ ë©˜í†  ID ê°€ì ¸ì˜¤ê¸°
function getMentorIdFromSession() {
    // Django í…œí”Œë¦¿ì—ì„œ ì „ë‹¬ëœ ì‚¬ìš©ì ì •ë³´
    return {{ user_id|default:"null" }};
}

// FastAPIì—ì„œ ë©˜í† ì‹­ ë°ì´í„° ë¡œë“œ
async function loadMentorships() {
    try {
        showLoading(true);
        console.log('ë©˜í† ì‹­ ë¡œë”© ì‹œì‘...');
        console.log('ë©˜í†  ID:', mentorId);
        
        const url = `/fastapi/mentorship/?mentor_id=${mentorId}`;
        console.log('ìš”ì²­ URL:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'  // CSRF í† í°ì„ ìœ„í•´ ì¶”ê°€
        });
        
        console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
        console.log('ì‘ë‹µ í—¤ë”:', response.headers);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('ì‘ë‹µ ì˜¤ë¥˜ ë‚´ìš©:', errorText);
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('ë°›ì€ ë°ì´í„°:', data);
        renderMentorshipCards(data);
        
    } catch (error) {
        console.error('Error loading mentorships:', error);
        
        // ë” ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ ì œê³µ
        let errorMessage = 'ë©˜í† ì‹­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        
        if (error instanceof TypeError && error.message.includes('fetch')) {
            errorMessage += ' ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
        } else if (error.message.includes('404')) {
            errorMessage += ' API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        } else if (error.message.includes('500')) {
            errorMessage += ' ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        } else {
            errorMessage += ` (${error.message})`;
        }
        
        showError(errorMessage);
    } finally {
        showLoading(false);
    }
}

// ë©˜í† ì‹­ ì¹´ë“œ ë Œë”ë§
function renderMentorshipCards(mentorships) {
    const cardsContainer = document.getElementById('mentorshipCards');
    
    if (!mentorships || mentorships.length === 0) {
        showEmptyState();
        return;
    }
    
    const cardsHTML = mentorships.map(mentorship => {
        const progress = calculateProgress(mentorship);
        const dday = calculateDday(mentorship);
        
        return `
            <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-lg transition-shadow cursor-pointer" 
                 onclick="navigateToTaskList(${mentorship.id})">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-blue-600 font-bold text-lg">${mentorship.mentee_name.charAt(0)}</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl text-gray-900 mb-1">${mentorship.mentee_name}</h3>
                            <div class="flex items-center gap-2">
                                ${mentorship.tags ? mentorship.tags.map(tag => 
                                    `<span class="bg-blue-50 text-blue-600 text-sm px-3 py-1.5 rounded-full font-medium">${tag}</span>`
                                ).join('') : ''}
                            </div>
                        </div>
                    </div>
                    ${dday ? `<span class="bg-red-50 text-red-600 text-base font-medium px-4 py-2 rounded-full">${dday}</span>` : ''}
                </div>
                
                <div class="flex items-center gap-4 mb-4 bg-gray-50 rounded-lg p-4">
                    <div class="flex-1">
                        <span class="text-base font-medium text-gray-600">ì»¤ë¦¬í˜ëŸ¼</span>
                        <p class="text-gray-900 font-medium text-lg">${mentorship.curriculum_title || 'ê¸°ë³¸ ì»¤ë¦¬í˜ëŸ¼'}</p>
                    </div>
                    <div class="border-l border-gray-200 pl-4">
                        <span class="text-base font-medium text-gray-600">ì´ ì£¼ì°¨</span>
                        <p class="text-gray-900 font-medium text-lg">${mentorship.total_weeks || 12}ì£¼</p>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-base font-medium text-gray-600">ì§„ì²™ë„</span>
                        <span class="text-base font-bold text-gray-900">${progress}%</span>
                    </div>
                    <div class="bg-gray-100 rounded-full h-3">
                        <div class="bg-blue-500 h-3 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    cardsContainer.innerHTML = cardsHTML;
    hideAllStates();
}

// ì§„ì²™ë„ ê³„ì‚°
function calculateProgress(mentorship) {
    if (mentorship.completed_tasks && mentorship.total_tasks) {
        return Math.round((mentorship.completed_tasks / mentorship.total_tasks) * 100);
    }
    return 0;
}

// D-DAY ê³„ì‚°
function calculateDday(mentorship) {
    if (!mentorship.end_date) return null;
    
    const endDate = new Date(mentorship.end_date);
    const today = new Date();
    const diffTime = endDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays > 0) {
        return `D-${diffDays}`;
    } else if (diffDays === 0) {
        return 'D-DAY';
    } else {
        return `D+${Math.abs(diffDays)}`;
    }
}

// íƒœìŠ¤í¬ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
function navigateToTaskList(mentorshipId) {
    window.location.href = `/mentee/task_list/?mentorship_id=${mentorshipId}`;
}

// ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ë“¤
function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showEmptyState() {
    document.getElementById('emptyState').style.display = 'block';
    hideOtherStates(['emptyState']);
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorState').style.display = 'block';
    hideOtherStates(['errorState']);
}

function hideAllStates() {
    ['loading', 'emptyState', 'errorState'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
}

function hideOtherStates(except) {
    ['loading', 'emptyState', 'errorState', 'mentorshipCards'].forEach(id => {
        if (!except.includes(id)) {
            document.getElementById(id).style.display = 'none';
        }
    });
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ê²€ìƒ‰ í•¨ìˆ˜ (FastAPI ì—°ë™)
async function searchMentees() {
    const searchInput = document.getElementById('searchInput');
    const query = searchInput ? searchInput.value.trim() : '';
    
    if (!mentorId) {
        showError('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    try {
        showLoading(true);
        
        const url = `/fastapi/mentorship/?mentor_id=${mentorId}${query ? `&search=${encodeURIComponent(query)}` : ''}`;
        console.log('ê²€ìƒ‰ URL:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        
        const data = await response.json();
        renderMentorshipCards(data);
        
    } catch (error) {
        console.error('Error searching mentorships:', error);
        let errorMessage = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        
        if (error instanceof TypeError && error.message.includes('fetch')) {
            errorMessage += ' ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
        } else {
            errorMessage += ` (${error.message})`;
        }
        
        showError(errorMessage);
    } finally {
        showLoading(false);
    }
}
</script>
{% endblock %}