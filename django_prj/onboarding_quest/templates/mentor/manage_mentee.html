{% extends 'base.html' %}
{% load static %}

{% block title %}멘티 관리 페이지{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/mentor/manage_mentee.css' %}">
<style>
.mentee-container {
  display: flex;
  gap: 40px;
  width: 100%;
  min-height: 700px;
  margin-top: 40px;
}
.mentee-list-area {
  flex: none;
  width: 260px;
  background: #fafbfc;
  border-radius: 16px;
  padding: 32px 18px 32px 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  display: flex;
  flex-direction: column;
  height: fit-content;
}
.mentee-list-search {
  margin-bottom: 18px;
}
.mentee-list-search input {
  width: 100%;
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 1em;
}
.mentee-list-ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.mentee-list-ul li {
  margin-bottom: 8px;
}
.mentee-list-ul li:last-child { margin-bottom: 0; }
.mentee-list-ul a {
  display: block;
  padding: 10px 14px;
  border-radius: 8px;
  background: #fff;
  color: #222;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
}
.mentee-list-ul a.selected, .mentee-list-ul a:hover {
  background: #ffd600;
  color: #222;
}
.mentee-profile-area {
  flex: 1 1 0;
  background: #fff;
  border-radius: 16px;
  padding: 24px 32px;
  min-width: 340px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  display: flex;
  flex-direction: column;
  align-items: center;
  height: fit-content;
}
.mentee-avatar {
  width: 80px; height: 80px;
  border-radius: 50%;
  background: #e6f9e6;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.8em;
  margin-bottom: 18px;
  border: 2px solid #b2e5b2;
}
.mentee-name {
  font-size: 1.3em;
  font-weight: bold;
  margin-bottom: 6px;
}
.mentee-role {
  color: #4caf50;
  font-size: 1em;
  margin-bottom: 10px;
}
.mentee-extra {
  color: #555;
  font-size: 1em;
  background: #fafbfc;
  border-radius: 8px;
  padding: 12px 18px;
  margin-bottom: 0;
  min-width: 180px;
  text-align: center;
}
.mentoring-settings-area {
  flex: none;
  width: 320px;
  background: #fff;
  border-radius: 16px;
  padding: 32px 28px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  display: flex;
  flex-direction: column;
  height: fit-content;
}
.mentoring-settings-area h4 {
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 18px;
}
.mentoring-settings-area label {
  font-size: 0.98em;
  font-weight: 500;
  margin-bottom: 4px;
  display: block;
}
.mentoring-settings-area input[type="text"],
.mentoring-settings-area input[type="date"],
.mentoring-settings-area select {
  width: 100%;
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 1em;
  margin-bottom: 14px;
}
.mentoring-settings-area button[type="submit"] {
  width: 100%;
  background: #ffd600;
  color: #222;
  border: none;
  border-radius: 8px;
  padding: 12px 0;
  font-size: 1.1em;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
}
.mentoring-settings-area .end-date-label {
  margin-top: 8px;
  font-size: 0.97em;
  color: #888;
}
.curriculum-toggle {
  background-color: #f4f4f4;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 8px;
  text-align: center;
  font-size: 0.95em;
}

.curriculum-option-list {
  list-style: none;
  padding: 0;
  margin: 0 0 8px 0;
  border: 1px solid #ccc;
  border-radius: 8px;
  max-height: 140px;
  overflow-y: auto;
  background: white;
}

.curriculum-option-list li {
  padding: 8px 12px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

.curriculum-option-list li:hover {
  background-color: #f2f2f2;
}

.selected-curriculum-list {
  list-style: none;
  margin: 0 0 8px 0;
  padding-left: 0;
}

.selected-curriculum-list li {
  background: #f9f9f9;
  padding: 6px 10px;
  margin-bottom: 4px;
  border-radius: 6px;
  font-size: 0.92em;
}

.hidden {
  display: none;
}


</style>

{% endblock %}

{% block content %}
<div class="mentee-container">
  <!-- 1. 멘티(신입사원) 검색/리스트 -->
  <div class="mentee-list-area">
    <div class="mentee-list-search">
      <input type="text" id="mentee-search" placeholder="사원명 검색...">
    </div>
    <ul class="mentee-list-ul" id="mentee-list">
      {% for mentee in mentees %}
      <li><a href="#" 
        data-id="{{ mentee.user_id }}"
        data-emp="{{ mentee.employee_number }}"
        data-admin="{{ mentee.is_admin }}"
        data-mentorship="{{ mentee.mentorship_id }}"
        data-company="{{ mentee.company.company_name|default:'' }}"
        data-dept="{{ mentee.department.department_name|default:'' }}"
        data-tag="{{ mentee.tag }}"
        data-role="{{ mentee.role }}"
        data-join="{{ mentee.join_date }}"
        data-position="{{ mentee.position }}"
        data-job="{{ mentee.job_part }}"
        data-email="{{ mentee.email }}"
        data-password="{{ mentee.password }}"
        data-lastname="{{ mentee.last_name }}"
        data-firstname="{{ mentee.first_name }}"
        data-lastlogin="{{ mentee.last_login }}"
        data-active="{{ mentee.is_active }}"
        data-staff="{{ mentee.is_staff }}"
      >{{ mentee.last_name }}{{ mentee.first_name }}</a></li>
      {% empty %}
      <li><span>멘티가 없습니다.</span></li>
      {% endfor %}
    </ul>
  </div>
  <!-- 2. 멘티 정보 -->
  <div class="mentee-profile-area" id="mentee-profile">
    <div class="mentee-avatar" id="mentee-avatar">👤</div>
    <div class="mentee-name" id="mentee-name"></div>
    <div class="mentee-tags" id="mentee-tags" style="margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center;"></div>
    <div class="mentee-info-table" style="margin-top:8px; width:100%;">
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">사원번호</div><textarea id="mentee-id" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">이메일</div><textarea id="mentee-email" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">부서</div><textarea id="mentee-dept" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">직무</div><textarea id="mentee-job" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">직급</div><textarea id="mentee-position" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">입사일</div><textarea id="mentee-join" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">태그</div><textarea id="mentee-tag" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">멘토쉽ID</div><textarea id="mentee-mentorship" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">회사</div><textarea id="mentee-company" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">성</div><textarea id="mentee-lastname" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">이름</div><textarea id="mentee-firstname" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">마지막 로그인</div><textarea id="mentee-lastlogin" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">활성화</div><textarea id="mentee-active" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
      <div style="margin-bottom:10px;"><div class="font-bold text-sm mb-1">스태프</div><textarea id="mentee-staff" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm" rows="1" readonly></textarea></div>
    </div>
  </div>
  <!-- 3. 멘토링 설정 -->
  <div class="mentoring-settings-area">
    <h4>멘토링 설정</h4>
    <form id="mentoring-form">
      {% csrf_token %}
      <label>선택된 멘티</label>
      <input type="text" id="selected-mentee" value="" readonly>
      <label>멘토쉽 시작일자</label>
      <input type="date" id="start-date" value="2025-07-16">
      <label>커리큘럼 선택</label>
      <div id="curriculum-checkbox-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 14px;">
        {% for curriculum in curriculums %}
        <div style="margin-bottom: 8px;">
          <label style="display: flex; align-items: center; font-weight: normal; margin-bottom: 0;">
            <input type="checkbox" name="curriculum" value="{{ curriculum.curriculum_id }}" data-weeks="{{ curriculum.total_weeks }}" style="margin-right: 8px;">
            <span>{{ curriculum.curriculum_title }} ({{ curriculum.total_weeks }}주)</span>
          </label>
        </div>
        {% endfor %}
      </div>
      <div class="end-date-label" id="end-date-label">종료일: 2025-08-05</div>
      <button type="submit" id="mentoring-submit-btn">
        <span class="btn-text">생성</span>
        <span class="btn-loading" style="display: none;">
          <div class="loading-spinner"></div>
          생성중...
        </span>
      </button>
    </form>
  </div>
</div>
<script>
// 실시간 검색 필터링
const menteeSearch = document.getElementById('mentee-search');
const menteeList = document.getElementById('mentee-list');
const menteeProfile = document.getElementById('mentee-profile');
const menteeName = document.getElementById('mentee-name');
const menteeRole = document.getElementById('mentee-role');
const menteeExtra = document.getElementById('mentee-extra');
const selectedMentee = document.getElementById('selected-mentee');

function bindMenteeEvents() {
  const menteeLinks = menteeList.querySelectorAll('a');
  menteeLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      menteeLinks.forEach(l => l.classList.remove('selected'));
      link.classList.add('selected');
      updateMenteeDetail(link.dataset.id);
    });
  });
}

menteeSearch.addEventListener('input', function() {
  const val = menteeSearch.value.trim().toLowerCase();
  const menteeLinks = menteeList.querySelectorAll('a');
  menteeLinks.forEach(link => {
    // 성+이름 기준으로 검색
    const name = (link.textContent || '').toLowerCase();
    if (name.includes(val)) {
      link.parentElement.style.display = '';
    } else {
      link.parentElement.style.display = 'none';
    }
  });
});
bindMenteeEvents();
// 커리큘럼/시작일 변경 시 종료일 자동 계산
const startDateInput = document.getElementById('start-date');
const curriculumCheckboxes = document.querySelectorAll('input[name="curriculum"]');
const endDateLabel = document.getElementById('end-date-label');
function updateEndDate() {
  const start = new Date(startDateInput.value);
  const checkedBoxes = Array.from(curriculumCheckboxes).filter(cb => cb.checked);
  const weekValues = checkedBoxes.map(cb => parseInt(cb.getAttribute('data-weeks'))).filter(w => !isNaN(w));
  const maxWeeks = Math.max(...weekValues, 0);

  if (!isNaN(start.getTime()) && maxWeeks > 0) {
    const end = new Date(start);
    end.setDate(end.getDate() + maxWeeks * 7 - 1);
    const yyyy = end.getFullYear();
    const mm = String(end.getMonth() + 1).padStart(2, '0');
    const dd = String(end.getDate()).padStart(2, '0');
    endDateLabel.textContent = `종료일: ${yyyy}-${mm}-${dd}`;
  } else {
    endDateLabel.textContent = '종료일: 커리큘럼을 선택하세요';
  }
}

startDateInput.addEventListener('change', updateEndDate);
curriculumCheckboxes.forEach(cb => {
  cb.addEventListener('change', updateEndDate);
});
window.addEventListener('DOMContentLoaded', updateEndDate);
// 서버에서 내려준 멘티 정보를 JS 객체로 구성
const menteeData = {};
document.querySelectorAll('#mentee-list a').forEach(link => {
  menteeData[link.dataset.id] = {
    id: link.dataset.id || '',
    emp: link.dataset.emp || '',
    admin: link.dataset.admin || '',
    mentorship: link.dataset.mentorship || '',
    company: link.dataset.company || '',
    dept: link.dataset.dept || '',
    tag: link.dataset.tag || '',
    role: link.dataset.role || '',
    join: link.dataset.join || '',
    position: link.dataset.position || '',
    job: link.dataset.job || '',
    email: link.dataset.email || '',
    password: link.dataset.password || '',
    lastname: link.dataset.lastname || '',
    firstname: link.dataset.firstname || '',
    lastlogin: link.dataset.lastlogin || '',
    active: link.dataset.active || '',
    staff: link.dataset.staff || ''
  };
});
const menteeId = document.getElementById('mentee-id');
const menteeEmail = document.getElementById('mentee-email');
const menteeDept = document.getElementById('mentee-dept');
const menteeJob = document.getElementById('mentee-job');
const menteePosition = document.getElementById('mentee-position');
const menteeJoin = document.getElementById('mentee-join');
const menteeTag = document.getElementById('mentee-tag');
const menteeMentorship = document.getElementById('mentee-mentorship');
const menteeCompany = document.getElementById('mentee-company');
const menteeLastname = document.getElementById('mentee-lastname');
const menteeFirstname = document.getElementById('mentee-firstname');
const menteeLastlogin = document.getElementById('mentee-lastlogin');
const menteeActive = document.getElementById('mentee-active');
const menteeStaff = document.getElementById('mentee-staff');
const menteeTags = document.getElementById('mentee-tags');
function updateMenteeDetail(id) {
  const d = menteeData[id];
  if (d) {
    menteeName.textContent = d.lastname + d.firstname;
    selectedMentee.value = d.lastname + d.firstname;
    menteeId.value = d.emp;
    menteeEmail.value = d.email;
    menteeDept.value = d.dept;
    menteeJob.value = d.job;
    menteePosition.value = d.position;
    menteeJoin.value = d.join;
    menteeTag.value = d.tag;
    menteeMentorship.value = d.mentorship;
    menteeCompany.value = d.company;
    menteeLastname.value = d.lastname;
    menteeFirstname.value = d.firstname;
    menteeLastlogin.value = d.lastlogin;
    menteeActive.value = d.active;
    menteeStaff.value = d.staff;
    // 태그 렌더링
    menteeTags.innerHTML = '';
    (d.tag || '').split(' ').filter(Boolean).forEach(tag => {
      const span = document.createElement('span');
      span.className = 'tag bg-gray-100 text-sm px-2 py-1 rounded';
      span.textContent = tag;
      menteeTags.appendChild(span);
    });
  } else {
    menteeName.textContent = '';
    selectedMentee.value = '';
    menteeId.value = '';
    menteeEmail.value = '';
    menteeDept.value = '';
    menteeJob.value = '';
    menteePosition.value = '';
    menteeJoin.value = '';
    menteeTag.value = '';
    menteeMentorship.value = '';
    menteeCompany.value = '';
    menteeLastname.value = '';
    menteeFirstname.value = '';
    menteeLastlogin.value = '';
    menteeActive.value = '';
    menteeStaff.value = '';
    menteeTags.innerHTML = '';
  }
}
// (위에서 bindMenteeEvents로 대체)
// 최초 로드 시 첫 번째 멘티 정보 표시
window.addEventListener('DOMContentLoaded', function() {
  const first = document.querySelector('#mentee-list a');
  if (first) {
    first.classList.add('selected');
    updateMenteeDetail(first.dataset.id);
  }
  updateEndDate();
});
// 생성 버튼 클릭 시 mentor 페이지로 이동
const mentoringForm = document.getElementById('mentoring-form');
mentoringForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  // 선택된 멘티의 user_id 추출
  const selected = document.querySelector('#mentee-list a.selected');
  if (!selected) {
    alert('멘티를 선택하세요.');
    return;
  }
  const menteeId = selected.dataset.id;
  const scheduledStartDate = document.getElementById('start-date').value;
  const checkedCurriculums = Array.from(document.querySelectorAll('input[name="curriculum"]:checked'));
  const curriculumIds = checkedCurriculums.map(cb => cb.value);
  
  if (curriculumIds.length === 0) {
    alert('최소 하나의 커리큘럼을 선택하세요.');
    return;
  }
  
  // 종료일 계산: 화면에 표시된 종료일 텍스트에서 추출
  const endDateLabel = document.getElementById('end-date-label');
  let scheduledEndDate = '';
  if (endDateLabel && endDateLabel.textContent.includes('종료일:')) {
    scheduledEndDate = endDateLabel.textContent.replace('종료일:', '').trim();
  }
  
  // 각 커리큘럼별로 멘토쉽 생성 (다중 커리큘럼 지원)
  try {
    // 로딩 상태 시작
    const submitBtn = document.getElementById('mentoring-submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline-flex';
    submitBtn.disabled = true;
    
    const res = await fetch('/mentor/create_mentorship/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ 
        mentee_id: menteeId, 
        start_date: scheduledStartDate, 
        end_date: scheduledEndDate, 
        curriculum_ids: curriculumIds // 다중 커리큘럼 ID 배열 전송
      })
    });
    const data = await res.json();
    if (data.success) {
      // 성공 메시지 표시
      showMessage('멘토쉽이 성공적으로 생성되었습니다!');
      
      // 2초 후 리다이렉트
      setTimeout(() => {
        window.location.href = '/mentor/';
      }, 2000);
    } else {
      throw new Error(data.message || '멘토쉽 생성에 실패했습니다.');
    }
  } catch (err) {
    console.error('멘토쉽 생성 오류:', err);
    showMessage(err.message || '멘토쉽 생성 중 오류가 발생했습니다.', 'error');
    
    // 로딩 상태 종료
    const submitBtn = document.getElementById('mentoring-submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    btnText.style.display = 'inline';
    btnLoading.style.display = 'none';
    submitBtn.disabled = false;
  }
});

// 메시지 표시 함수
function showMessage(message, type = 'success') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        transform: translateX(100%);
        transition: all 0.3s ease;
        ${type === 'success' ? 'background-color: #28a745;' : 'background-color: #dc3545;'}
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    // 슬라이드 인 애니메이션
    setTimeout(() => {
        messageDiv.style.transform = 'translateX(0)';
    }, 10);
    
    // 3초 후 자동 제거
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateX(100%)';
        setTimeout(() => messageDiv.remove(), 300);
    }, 3000);
}

// 로딩 스피너 스타일 추가
const style = document.createElement('style');
style.textContent = `
.loading-spinner {
    width: 12px;
    height: 12px;
    border: 2px solid #ffffff33;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 5px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.btn-loading {
    display: inline-flex;
    align-items: center;
}
`;
document.head.appendChild(style);
</script>
{% endblock %}
