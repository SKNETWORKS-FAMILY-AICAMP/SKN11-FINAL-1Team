{% extends 'base.html' %}
{% load static %}

{% block title %}ë©˜í‹° ê´€ë¦¬ í˜ì´ì§€{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/mentor/manage_mentee.css' %}">
<style>
.mentee-container {
  display: flex;
  gap: 20px;
  width: 100%;
  min-height: 700px;
  margin-top: 20px;
  background-color: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
}

.mentee-list-area {
  flex: none;
  width: 300px;
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border: 1px solid #e9ecef;
  display: flex;
  flex-direction: column;
  height: fit-content;
}

.mentee-list-area h3 {
  margin: 0 0 16px 0;
  font-size: 1.1em;
  font-weight: 600;
  color: #343a40;
  border-bottom: 1px solid #e9ecef;
  padding-bottom: 8px;
}

.mentee-list-search {
  margin-bottom: 16px;
}

.mentee-list-search input {
  width: 100%;
  padding: 10px 12px;
  border-radius: 4px;
  border: 1px solid #ced4da;
  font-size: 0.9em;
  background: white;
  transition: border-color 0.2s ease;
  color: #495057;
}

.mentee-list-search input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.mentee-list-ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.mentee-list-ul li {
  margin-bottom: 4px;
}

.mentee-list-ul li:last-child { 
  margin-bottom: 0; 
}

.mentee-list-ul a {
  display: block;
  padding: 10px 12px;
  border-radius: 4px;
  background: #f8f9fa;
  color: #495057;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid transparent;
  text-decoration: none;
}

.mentee-list-ul a.selected {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

.mentee-list-ul a:hover:not(.selected) {
  background: #e9ecef;
  border-color: #ced4da;
}

.mentee-profile-area {
  flex: 1 1 0;
  background: white;
  border-radius: 8px;
  padding: 24px;
  min-width: 400px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border: 1px solid #e9ecef;
  display: flex;
  flex-direction: column;
  height: fit-content;
}

.mentee-profile-header {
  display: flex;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e9ecef;
}

.mentee-avatar {
  width: 60px; 
  height: 60px;
  border-radius: 50%;
  background: #DBEAFE;
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-size: 1.5em;
  margin-right: 16px;
  color: #2563EB;
}

.mentee-basic-info {
  flex: 1;
}

.mentee-name {
  font-size: 1.3em;
  font-weight: 600;
  margin-bottom: 4px;
  color: #343a40;
}

.mentee-role {
  color: #6c757d;
  font-size: 0.9em;
  margin-bottom: 8px;
}

.mentee-tags {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.mentee-info-table {
  width: 100%;
}

.mentee-info-table h4 {
  font-size: 1.1em;
  font-weight: 600;
  margin-bottom: 16px;
  color: #343a40;
}

.info-row {
  display: flex;
  margin-bottom: 12px;
  align-items: flex-start;
}

.info-label {
  font-weight: 600;
  font-size: 0.9em;
  color: #495057;
  width: 100px;
  flex-shrink: 0;
  margin-right: 12px;
  padding-top: 8px;
}

.info-value {
  flex: 1;
  min-width: 0;
}

.info-value textarea {
  width: 100%;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  color: #495057;
  border-radius: 4px;
  padding: 8px 10px;
  font-size: 0.9em;
  resize: none;
  min-height: 36px;
}

.mentoring-settings-area {
  flex: none;
  width: 340px;
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border: 1px solid #e9ecef;
  display: flex;
  flex-direction: column;
  height: fit-content;
}

.mentoring-settings-area h4 {
  font-size: 1.1em;
  font-weight: 600;
  margin-bottom: 20px;
  color: #343a40;
  padding-bottom: 8px;
  border-bottom: 1px solid #e9ecef;
}

.mentoring-settings-area label {
  font-size: 0.9em;
  font-weight: 600;
  margin-bottom: 6px;
  display: block;
  color: #495057;
}

.mentoring-settings-area input[type="text"],
.mentoring-settings-area input[type="date"],
.mentoring-settings-area select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 4px;
  border: 1px solid #ced4da;
  font-size: 0.9em;
  margin-bottom: 16px;
  background: white;
  color: #495057;
  transition: border-color 0.2s ease;
}

.mentoring-settings-area input[type="text"]:focus,
.mentoring-settings-area input[type="date"]:focus,
.mentoring-settings-area select:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.button-group {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.mentoring-settings-area button[type="submit"] {
  flex: 1;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 12px 0;
  font-size: 0.9em;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.mentoring-settings-area button[type="submit"]:hover {
  background: #0056b3;
}

.mentoring-settings-area button[type="button"] {
  flex: 1;
  background: white;
  color: #6c757d;
  border: 1px solid #ced4da;
  border-radius: 4px;
  padding: 12px 0;
  font-size: 0.9em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.mentoring-settings-area button[type="button"]:hover {
  background: #f8f9fa;
  border-color: #adb5bd;
}

.mentoring-settings-area .end-date-label {
  margin-top: 8px;
  font-size: 0.9em;
  color: #495057;
  font-weight: 500;
  background: #f8f9fa;
  padding: 10px 12px;
  border-radius: 4px;
  border: 1px solid #e9ecef;
  text-align: center;
}

#curriculum-checkbox-container {
  max-height: 200px; 
  overflow-y: auto; 
  border: 1px solid #ced4da; 
  border-radius: 4px; 
  padding: 12px; 
  margin-bottom: 16px;
  background: #f8f9fa;
}

#curriculum-checkbox-container label {
  display: flex; 
  align-items: center; 
  font-weight: normal; 
  margin-bottom: 10px;
  color: #495057;
  cursor: pointer;
  padding: 6px 8px;
  border-radius: 4px;
  transition: background 0.2s ease;
}

#curriculum-checkbox-container label:hover {
  background: white;
}

#curriculum-checkbox-container label:last-child {
  margin-bottom: 0;
}

#curriculum-checkbox-container input[type="checkbox"] {
  margin-right: 10px;
  width: 16px;
  height: 16px;
  accent-color: #007bff;
}

.tag {
  background: #e9ecef;
  color: #495057;
  border: 1px solid #ced4da;
  font-weight: 500;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8em;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 1200px) {
  .mentee-container {
    flex-direction: column;
    gap: 16px;
  }
  
  .mentee-list-area,
  .mentoring-settings-area {
    width: 100%;
  }
}
</style>

{% endblock %}

{% block content %}
<div class="mentee-container">
  <!-- 1. ë©˜í‹°(ì‹ ì…ì‚¬ì›) ê²€ìƒ‰/ë¦¬ìŠ¤íŠ¸ -->
  <div class="mentee-list-area">
    <h3>ë©˜í‹° ëª©ë¡</h3>
    <div class="mentee-list-search">
      <input type="text" id="mentee-search" placeholder="ì‚¬ì›ëª… ê²€ìƒ‰">
    </div>
    <ul class="mentee-list-ul" id="mentee-list">
      {% for mentee in mentees %}
      <li><a href="#" 
        data-id="{{ mentee.user_id }}"
        data-emp="{{ mentee.employee_number }}"
        data-admin="{{ mentee.is_admin }}"
        data-mentorship="{{ mentee.mentorship_id }}"
        data-company="{{ mentee.company.company_name|default:'' }}"
        data-dept="{{ mentee.department.department_name|default:'' }}"
        data-tag="{{ mentee.tag }}"
        data-role="{{ mentee.role }}"
        data-join="{{ mentee.join_date }}"
        data-position="{{ mentee.position }}"
        data-job="{{ mentee.job_part }}"
        data-email="{{ mentee.email }}"
        data-password="{{ mentee.password }}"
        data-lastname="{{ mentee.last_name }}"
        data-firstname="{{ mentee.first_name }}"
        data-lastlogin="{{ mentee.last_login }}"
        data-active="{{ mentee.is_active }}"
        data-staff="{{ mentee.is_staff }}"
      >{{ mentee.last_name }}{{ mentee.first_name }}</a></li>
      {% empty %}
      <li><span>ë©˜í‹°ê°€ ì—†ìŠµë‹ˆë‹¤.</span></li>
      {% endfor %}
    </ul>
  </div>

  <!-- 2. ë©˜í‹° ì •ë³´ -->
  <div class="mentee-profile-area" id="mentee-profile">
    <div class="mentee-profile-header">
      <div class="mentee-avatar" id="mentee-avatar">ğŸ‘¤</div>
      <div class="mentee-basic-info">
        <div class="mentee-name" id="mentee-name">ë©˜í‹°ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        <div class="mentee-role" id="mentee-role">ì‹ ì…ì‚¬ì›</div>
        <div class="mentee-tags" id="mentee-tags"></div>
      </div>
    </div>
    
    <div class="mentee-info-table">
      <h4>ìƒì„¸ ì •ë³´</h4>
      <div class="info-row">
        <div class="info-label">ì‚¬ì›ë²ˆí˜¸</div>
        <div class="info-value">
          <textarea id="mentee-id" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ì´ë©”ì¼</div>
        <div class="info-value">
          <textarea id="mentee-email" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ë¶€ì„œ</div>
        <div class="info-value">
          <textarea id="mentee-dept" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ì§ë¬´</div>
        <div class="info-value">
          <textarea id="mentee-job" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ì§ê¸‰</div>
        <div class="info-value">
          <textarea id="mentee-position" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ì…ì‚¬ì¼</div>
        <div class="info-value">
          <textarea id="mentee-join" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">íƒœê·¸</div>
        <div class="info-value">
          <textarea id="mentee-tag" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ë©˜í† ì‰½ID</div>
        <div class="info-value">
          <textarea id="mentee-mentorship" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">íšŒì‚¬</div>
        <div class="info-value">
          <textarea id="mentee-company" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ì„±</div>
        <div class="info-value">
          <textarea id="mentee-lastname" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ì´ë¦„</div>
        <div class="info-value">
          <textarea id="mentee-firstname" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ìµœê·¼ ë¡œê·¸ì¸</div>
        <div class="info-value">
          <textarea id="mentee-lastlogin" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ê³„ì • ìƒíƒœ</div>
        <div class="info-value">
          <textarea id="mentee-active" rows="1" readonly></textarea>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">ìŠ¤íƒœí”„ ê¶Œí•œ</div>
        <div class="info-value">
          <textarea id="mentee-staff" rows="1" readonly></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- 3. ë©˜í† ë§ ì„¤ì • -->
  <div class="mentoring-settings-area">
    <h4>ë©˜í† ë§ ì„¤ì •</h4>
    <form id="mentoring-form">
      {% csrf_token %}
      <label>ì„ íƒëœ ë©˜í‹°</label>
      <input type="text" id="selected-mentee" value="" readonly>
      
      <label>ì‹œì‘ì¼ì</label>
      <input type="date" id="start-date" value="2025-07-16">
      
      <label>ì»¤ë¦¬í˜ëŸ¼ ì„ íƒ</label>
      <div id="curriculum-checkbox-container">
        {% for curriculum in curriculums %}
        <div>
          <label>
            <input type="checkbox" name="curriculum" value="{{ curriculum.curriculum_id }}" data-weeks="{{ curriculum.total_weeks }}">
            <span>{{ curriculum.curriculum_title }} ({{ curriculum.total_weeks }}ì£¼)</span>
          </label>
        </div>
        {% endfor %}
      </div>
      
      <div class="end-date-label" id="end-date-label">ì¢…ë£Œì¼: ì»¤ë¦¬í˜ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
      
      <div class="button-group">
        <button type="button" onclick="resetForm()">ì´ˆê¸°í™”</button>
        <button type="submit">ë©˜í† ì‰½ ìƒì„±</button>
      </div>
    </form>
  </div>
</div>

<script>
// ì‹¤ì‹œê°„ ê²€ìƒ‰ í•„í„°ë§
const menteeSearch = document.getElementById('mentee-search');
const menteeList = document.getElementById('mentee-list');
const menteeProfile = document.getElementById('mentee-profile');
const menteeName = document.getElementById('mentee-name');
const menteeRole = document.getElementById('mentee-role');
const menteeExtra = document.getElementById('mentee-extra');
const selectedMentee = document.getElementById('selected-mentee');

function bindMenteeEvents() {
  const menteeLinks = menteeList.querySelectorAll('a');
  menteeLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      menteeLinks.forEach(l => l.classList.remove('selected'));
      link.classList.add('selected');
      updateMenteeDetail(link.dataset.id);
    });
  });
}

menteeSearch.addEventListener('input', function() {
  const val = menteeSearch.value.trim().toLowerCase();
  const menteeLinks = menteeList.querySelectorAll('a');
  menteeLinks.forEach(link => {
    const name = (link.textContent || '').toLowerCase();
    if (name.includes(val)) {
      link.parentElement.style.display = '';
    } else {
      link.parentElement.style.display = 'none';
    }
  });
});

bindMenteeEvents();

// ì»¤ë¦¬í˜ëŸ¼/ì‹œì‘ì¼ ë³€ê²½ ì‹œ ì¢…ë£Œì¼ ìë™ ê³„ì‚°
const startDateInput = document.getElementById('start-date');
const curriculumCheckboxes = document.querySelectorAll('input[name="curriculum"]');
const endDateLabel = document.getElementById('end-date-label');

function updateEndDate() {
  const start = new Date(startDateInput.value);
  const checkedBoxes = Array.from(curriculumCheckboxes).filter(cb => cb.checked);
  const weekValues = checkedBoxes.map(cb => parseInt(cb.getAttribute('data-weeks'))).filter(w => !isNaN(w));
  const maxWeeks = Math.max(...weekValues, 0);

  if (!isNaN(start.getTime()) && maxWeeks > 0) {
    const end = new Date(start);
    end.setDate(end.getDate() + maxWeeks * 7 - 1);
    const yyyy = end.getFullYear();
    const mm = String(end.getMonth() + 1).padStart(2, '0');
    const dd = String(end.getDate()).padStart(2, '0');
    endDateLabel.textContent = `ì¢…ë£Œì¼: ${yyyy}-${mm}-${dd}`;
  } else {
    endDateLabel.textContent = 'ì¢…ë£Œì¼: ì»¤ë¦¬í˜ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”';
  }
}

startDateInput.addEventListener('change', updateEndDate);
curriculumCheckboxes.forEach(cb => {
  cb.addEventListener('change', updateEndDate);
});

// ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë©˜í‹° ì •ë³´ë¥¼ JS ê°ì²´ë¡œ êµ¬ì„±
const menteeData = {};
document.querySelectorAll('#mentee-list a').forEach(link => {
  menteeData[link.dataset.id] = {
    id: link.dataset.id || '',
    emp: link.dataset.emp || '',
    admin: link.dataset.admin || '',
    mentorship: link.dataset.mentorship || '',
    company: link.dataset.company || '',
    dept: link.dataset.dept || '',
    tag: link.dataset.tag || '',
    role: link.dataset.role || '',
    join: link.dataset.join || '',
    position: link.dataset.position || '',
    job: link.dataset.job || '',
    email: link.dataset.email || '',
    password: link.dataset.password || '',
    lastname: link.dataset.lastname || '',
    firstname: link.dataset.firstname || '',
    lastlogin: link.dataset.lastlogin || '',
    active: link.dataset.active || '',
    staff: link.dataset.staff || ''
  };
});

const menteeId = document.getElementById('mentee-id');
const menteeEmail = document.getElementById('mentee-email');
const menteeDept = document.getElementById('mentee-dept');
const menteeJob = document.getElementById('mentee-job');
const menteePosition = document.getElementById('mentee-position');
const menteeJoin = document.getElementById('mentee-join');
const menteeTag = document.getElementById('mentee-tag');
const menteeMentorship = document.getElementById('mentee-mentorship');
const menteeCompany = document.getElementById('mentee-company');
const menteeLastname = document.getElementById('mentee-lastname');
const menteeFirstname = document.getElementById('mentee-firstname');
const menteeLastlogin = document.getElementById('mentee-lastlogin');
const menteeActive = document.getElementById('mentee-active');
const menteeStaff = document.getElementById('mentee-staff');
const menteeTags = document.getElementById('mentee-tags');

function updateMenteeDetail(id) {
  const d = menteeData[id];
  if (d) {
    const fullName = d.lastname + d.firstname;
    menteeName.textContent = fullName;
    selectedMentee.value = fullName;
    
    // í”„ë¡œí•„ ì•„ë°”íƒ€ë¥¼ ì´ë¦„ì˜ ì²« ê¸€ìë¡œ ë³€ê²½
    const menteeAvatar = document.getElementById('mentee-avatar');
    menteeAvatar.textContent = fullName.charAt(0);
    
    menteeId.value = d.emp;
    menteeEmail.value = d.email;
    menteeDept.value = d.dept;
    menteeJob.value = d.job;
    menteePosition.value = d.position;
    menteeJoin.value = d.join;
    menteeTag.value = d.tag;
    menteeMentorship.value = d.mentorship;
    menteeCompany.value = d.company;
    menteeLastname.value = d.lastname;
    menteeFirstname.value = d.firstname;
    menteeLastlogin.value = d.lastlogin;
    menteeActive.value = d.active;
    menteeStaff.value = d.staff;
    
    // íƒœê·¸ ë Œë”ë§
    menteeTags.innerHTML = '';
    (d.tag || '').split(' ').filter(Boolean).forEach(tag => {
      const span = document.createElement('span');
      span.className = 'tag';
      span.textContent = tag;
      menteeTags.appendChild(span);
    });
  } else {
    menteeName.textContent = 'ë©˜í‹°ë¥¼ ì„ íƒí•˜ì„¸ìš”';
    selectedMentee.value = '';
    
    // ê¸°ë³¸ ì•„ë°”íƒ€ë¡œ ë˜ëŒë¦¬ê¸°
    const menteeAvatar = document.getElementById('mentee-avatar');
    menteeAvatar.textContent = 'ğŸ‘¤';
    
    menteeId.value = '';
    menteeEmail.value = '';
    menteeDept.value = '';
    menteeJob.value = '';
    menteePosition.value = '';
    menteeJoin.value = '';
    menteeTag.value = '';
    menteeMentorship.value = '';
    menteeCompany.value = '';
    menteeLastname.value = '';
    menteeFirstname.value = '';
    menteeLastlogin.value = '';
    menteeActive.value = '';
    menteeStaff.value = '';
    menteeTags.innerHTML = '';
  }
}

// ìµœì´ˆ ë¡œë“œ ì‹œ ì²« ë²ˆì§¸ ë©˜í‹° ì •ë³´ í‘œì‹œ
window.addEventListener('DOMContentLoaded', function() {
  const first = document.querySelector('#mentee-list a');
  if (first) {
    first.classList.add('selected');
    updateMenteeDetail(first.dataset.id);
  }
  updateEndDate();
});

// ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ mentor í˜ì´ì§€ë¡œ ì´ë™
const mentoringForm = document.getElementById('mentoring-form');
mentoringForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const selected = document.querySelector('#mentee-list a.selected');
  if (!selected) {
    alert('ë©˜í‹°ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }
  
  const menteeId = selected.dataset.id;
  const scheduledStartDate = document.getElementById('start-date').value;
  const checkedCurriculums = Array.from(document.querySelectorAll('input[name="curriculum"]:checked'));
  const curriculumIds = checkedCurriculums.map(cb => cb.value);
  
  if (curriculumIds.length === 0) {
    alert('ìµœì†Œ í•˜ë‚˜ì˜ ì»¤ë¦¬í˜ëŸ¼ì„ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }
  
  // ì¢…ë£Œì¼ ê³„ì‚°
  const endDateLabel = document.getElementById('end-date-label');
  let scheduledEndDate = '';
  if (endDateLabel && endDateLabel.textContent.includes('ì¢…ë£Œì¼:')) {
    scheduledEndDate = endDateLabel.textContent.replace('ì¢…ë£Œì¼:', '').trim();
  }
  
  try {
    const res = await fetch('/mentor/create_mentorship/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ 
        mentee_id: menteeId, 
        start_date: scheduledStartDate, 
        end_date: scheduledEndDate, 
        curriculum_ids: curriculumIds
      })
    });
    
    const data = await res.json();
    if (data.success) {
      window.location.href = '/mentor/';
    } else {
      alert('ìƒì„± ì‹¤íŒ¨: ' + (data.message || ''));
    }
  } catch (err) {
    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    console.error(err);
  }
});

// ì´ˆê¸°í™” ë²„íŠ¼ ê¸°ëŠ¥
function resetForm() {
  document.getElementById('start-date').value = '2025-07-16';
  document.querySelectorAll('input[name="curriculum"]').forEach(cb => cb.checked = false);
  document.getElementById('selected-mentee').value = '';
  document.querySelector('#mentee-list a.selected')?.classList.remove('selected');
  updateEndDate();
  updateMenteeDetail(null);
}
</script>
{% endblock %}