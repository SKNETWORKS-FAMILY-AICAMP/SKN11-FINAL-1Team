{% extends 'base.html' %}
{% load static %}

{% block title %}ì»¤ë¦¬í˜ëŸ¼ ìƒì„±{% endblock %}

{% block extra_head %}
<style>
  .public-curriculum-indicator {
    margin-bottom: 18px;
  }
  .template-form-row {
    margin-bottom: 22px;
  }
  .template-form-row:last-child {
    margin-bottom: 0;
  }
  .public-curriculum-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    font-size: 1.1em;
    color: #1976d2;
    font-weight: bold;
  }
  /* ì»¤ë¦¬í˜ëŸ¼ ì œëª© ì…ë ¥ ë””ìì¸ ê°œì„  */
  .tasklist-search {
    width: 100%;
    border: 1.5px solid #90caf9;
    border-radius: 8px;
    padding: 12px 14px;
    font-size: 1.08em;
    color: #222;
    background: #f7fbff;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-shadow: 0 1px 4px rgba(144,202,249,0.08);
    outline: none;
  }
  .tasklist-search:focus {
    border-color: #1976d2;
    box-shadow: 0 2px 8px rgba(25,118,210,0.12);
    background: #fff;
  }
  /* ì»¤ë¦¬í˜ëŸ¼ ì„¤ëª… textarea ë””ìì¸ ê°œì„  */
  #curriculum-desc,
  #curriculum-textarea {
    width: 100%;
    border: 1.5px solid #90caf9;
    border-radius: 8px;
    padding: 12px 14px;
    font-size: 1.05em;
    color: #222;
    background: #f7fbff;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-shadow: 0 1px 4px rgba(144,202,249,0.08);
    outline: none;
    resize: vertical;
    min-height: 180px;
  }
  #curriculum-desc:focus,
  #curriculum-textarea:focus {
    border-color: #1976d2;
    box-shadow: 0 2px 8px rgba(25,118,210,0.12);
    background: #fff;
  }
  .week-section {
    background: #e3f2fd;
    border-radius: 10px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.03);
    margin-bottom: 18px;
    padding: 16px 18px 10px 18px;
    border-left: 6px solid #90caf9;
  }
  .template-container {
    display: flex;
    gap: 32px;
    width: 100%;
    min-height: 600px;
  }
  .template-left {
    flex: 1;
    padding: 15px 15px 15px 15px;
    background: #fafbfc;
    border-radius: 12px 0 0 12px;
    min-width: 340px;
    max-width: 500px;
    overflow-y: auto;
  }
  .template-title {
    font-size: 1.3em;
    font-weight: bold;
    margin-bottom: 18px;
    color: #222;
  }
  .template-desc {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 18px 20px 14px 20px;
    margin-bottom: 18px;
    color: #555;
    font-size: 15px;
    white-space: pre-line;
  }
  .template-task-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .template-task-item {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 12px 16px;
    font-size: 15px;
    color: #222;
    margin-bottom: 0;
    border-left: 5px solid #aa00ff;
    display: flex;
    align-items: flex-start;
    gap: 8px;
    cursor: grab;
    transition: background 0.2s;
    flex: 1;
  }
  .template-task-item.drag-over {
    background: #fffbe6;
    border-color: #ffecb3;
  }
  .template-task-item.dragging {
    opacity: 0.5;
  }
  .task-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .task-badges {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-shrink: 0;
    margin-bottom: 4px;
  }
  .task-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    color: white;
  }
  .status-badge {
    background: #9e9e9e;
  }
  .difficulty-high {
    background: #f44336;
  }
  .difficulty-medium {
    background: #4caf50;
  }
  .difficulty-low {
    background: #ffc107;
    color: #222;
  }
  .exp-badge {
    background: #2196f3;
    font-size: 11px;
  }
  .add-task-btn {
    background: #1976d2;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 18px;
    font-weight: bold;
    cursor: pointer;
    margin-bottom: 18px;
    margin-top: 8px;
  }
  .template-right {
    flex: 2;
    background: #fff;
    border-radius: 0 16px 16px 0;
    padding: 25px 25px 25px 25px;
    min-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 10;
  }
  .template-form-row {
    margin-bottom: 18px;
  }
  .template-form-label {
    font-weight: bold;
    color: #000000;
    margin-bottom: 6px;
    display: block;
    font-size: 1.05em;
  }
  .template-form-textarea {
    width: 100%;
    min-height: 180px;
    border: 1px solid #bbb;
    border-radius: 8px;
    padding: 12px;
    font-size: 1.05em;
    color: #555;
    background: #fafbfc;
    resize: none;
  }
  /* ëª¨ë‹¬ ìš°ì„ ìˆœìœ„ select í…ìŠ¤íŠ¸ ëª…í™•í•˜ê²Œ */
  select.template-form-textarea {
    color: #222;
    background: #fafbfc;
  }
  .template-form-actions {
    display: flex;
    gap: 18px;
    justify-content: flex-end;
    margin-top: 30px;
  }
  .template-btn {
    background: #1976d2;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 32px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
  }
  .template-btn:hover { background: #1565c0; }
  
  /* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .delete-btn {
    background: white;
    color: #f44336;
    border: none;
    border-radius: 4px;
    padding: 8px 10px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 36px;
  }
  .delete-btn:hover {
    background: rgba(244, 67, 54, 0.1);
    transform: scale(1.1);
  }
  
  /* ì£¼ì°¨ ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .week-delete-btn {
    background: transparent;
    color: #f44336;
    border: none;
    border-radius: 4px;
    padding: 4px 6px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .week-delete-btn:hover {
    background: rgba(244, 67, 54, 0.1);
    transform: scale(1.1);
  }
</style>
  <style>
    /* ì¢Œì¸¡ í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .fixed-bottom-actions {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100vw;
      background: rgba(255,255,255,0.98);
      box-shadow: 0 -2px 12px rgba(0,0,0,0.06);
      display: flex;
      gap: 18px;
      justify-content: flex-start;
      align-items: center;
      padding: 18px 48px 18px 48px;
      z-index: 10000;
    }
    
    /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      display: inline-block;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .btn-loading {
      display: none;
      align-items: center;
    }
    
    .template-btn:disabled {
      background: #999 !important;
      cursor: not-allowed;
    }
  </style>
{% endblock %}

{% block content %}
<div class="template-container" style="padding:0; background:none;">
  <!-- ì „ì²´ë¥¼ ìš°ì¸¡ 2ë‹¨ êµ¬ì¡°ë¡œë§Œ êµ¬ì„± -->
  <div class="template-left">
    <form class="template-form" id="create-form">
      <!-- ê³µìš© ì»¤ë¦¬í˜ëŸ¼ ì—¬ë¶€ í‘œì‹œ -->
      <div class="public-curriculum-indicator">
        <input type="checkbox" id="is-public-curriculum">
        <label for="is-public-curriculum">ê³µìš© ì»¤ë¦¬í˜ëŸ¼</label>
      </div>
      <div class="template-form-row">
        <label class="template-form-label">ì»¤ë¦¬í˜ëŸ¼ ì œëª©</label>
        <input type="text" class="tasklist-search" placeholder="ì»¤ë¦¬í˜ëŸ¼ ì œëª© ì…ë ¥" style="font-size: 14px;">
      </div>
      <div class="template-form-row">
        <label class="template-form-label">ì»¤ë¦¬í˜ëŸ¼ ì„¤ëª…</label>
        <textarea class="template-form-textarea" id="curriculum-desc" placeholder="ì˜ˆì‹œ : 

ì„¤ëª… : ì‹ ì… AI ì—”ì§€ë‹ˆì–´ë¥¼ ìœ„í•œ 6ì£¼ ì˜¨ë³´ë”©ìœ¼ë¡œ, ì‹¤ìŠµ ì¤‘ì‹¬ì´ë©° í”„ë¡œì íŠ¸ ê¸°ë°˜ìœ¼ë¡œ êµ¬ì„±ë¨.
ì§ë¬´ : AI ì—”ì§€ë‹ˆì–´
ì£¼ì°¨ : 6
ëª©ì  : ì‹ ì…ì‚¬ì›ì˜ ê¸°ìˆ  ì ì‘ê³¼ í”„ë¡œì íŠ¸ ìˆ˜í–‰ ì—­ëŸ‰ í‰ê°€í•˜ê¸° ìœ„í•¨" style="min-height: 250px; font-size: 14px;"></textarea>
        <div style="display: flex; justify-content: flex-end;">
          <button type="button" class="template-btn" id="generate-draft-btn" style="margin-top: 12px; padding: 8px 24px; font-size: 14px; background: #2196f3; color: white;">
            <span class="btn-text">âœ¨AI ì»¤ë¦¬í˜ëŸ¼ ìƒì„±</span>
            <span class="btn-loading" style="display: none;">
              <div class="loading-spinner"></div>
              ìƒì„±ì¤‘...
            </span>
          </button>
        </div>
      </div>
      <div class="template-form-row" id="draft-section">
        <label class="template-form-label">ì£¼ì°¨ë³„ ì»¤ë¦¬í˜ëŸ¼ ì¼ì •</label>
        <textarea class="template-form-textarea" id="curriculum-textarea" style="min-height: 400px; font-size:15px; white-space:pre-line;" placeholder="ì˜ˆì‹œ:

# week1 ì¡°ì§ë¬¸í™” ì´í•´ ë° ê´€ì°°
# week2 ì¡°ì§ë¬¸í™” ì‹¤ì²œ ì²´í—˜
# week3 ì¡°ì§ë¬¸í™” ì‹¤ì²œ ì²´í—˜ ë°œí‘œ ë° í”¼ë“œë°±
# week4 íŒ€ì›Œí¬ í–¥ìƒ í”„ë¡œê·¸ë¨ ì°¸ì—¬
# ...

ìœ„ì™€ ê°™ì€ í˜•íƒœë¡œ ì£¼ì°¨ë³„ ì»¤ë¦¬í˜ëŸ¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
        <div style="display: flex; justify-content: flex-end;">
          <button type="button" class="template-btn" id="generate-task-btn" style="margin-top: 12px; padding: 8px 24px; font-size: 14px; background: #2196f3; color: white;">
            <span class="btn-text">âœ¨AI ì„¸ë¶€ Task ìƒì„±</span>
            <span class="btn-loading" style="display: none;">
              <div class="loading-spinner"></div>
              ìƒì„±ì¤‘...
            </span>
          </button>
        </div>
      </div>
    </form>
  </div>
  <div class="template-right">
      
    <div class="template-task-list" style="width:100%; display: none; flex-direction:column; gap:18px;" id="task-list">
      <!-- JSë¡œ ì£¼ì°¨ë³„ ê·¸ë£¹í•‘ëœ Task ì¹´ë“œê°€ ë Œë”ë§ë©ë‹ˆë‹¤. -->      
    </div>
    <div class="template-form-actions" style="display:flex; gap:18px; justify-content:flex-end; margin-top:30px;">
      <button class="add-task-btn" id="add-week-btn" type="button" style="margin-bottom:0; margin-top:0;">ì£¼ì°¨ ì¶”ê°€</button>
      <button type="button" class="template-btn" id="save-curriculum-btn">
        <span class="btn-text">ì €ì¥</span>
        <span class="btn-loading" style="display: none;">
          <div class="loading-spinner"></div>
          ì €ì¥ ì¤‘...
        </span>
      </button>
      <button type="button" class="template-btn" onclick="window.location.href='/mentor/manage_template'">ì·¨ì†Œ</button>
    </div>
    <!-- Task ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="task-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:#fff; border-radius:12px; min-width:340px; max-width:420px; padding:32px 28px 24px 28px; box-shadow:0 4px 24px rgba(0,0,0,0.18); position:relative;">
        <button id="close-modal-btn" style="position:absolute; right:18px; top:14px; background:none; border:none; font-size:1.5em; color:#888; cursor:pointer;">&times;</button>
        <form id="task-form">
          <input type="hidden" name="edit-index" id="modal-edit-index">
          <input type="hidden" name="week" id="modal-week">
          <div style="margin-bottom:14px;">
            <label>ì œëª©</label>
            <input type="text" name="title" id="modal-title" class="template-form-textarea" style="min-height:unset; height:32px;">
          </div>
          <div style="margin-bottom:14px;">
            <label>ê°€ì´ë“œë¼ì¸</label>
            <input type="text" name="guideline" id="modal-guideline" class="template-form-textarea" style="min-height:unset; height:32px;">
          </div>
                    <div style="margin-bottom:14px;">
            <label>ì„¸ë¶€ ë‚´ìš©</label>
            <textarea name="description" id="modal-description" class="template-form-textarea"></textarea>
          </div>
          <div style="margin-bottom:14px; display:flex; gap:10px; align-items:flex-end;">
            <div style="flex:1;">
              <label>ì£¼ì°¨</label>
              <input type="number" name="week" id="modal-week-input" class="template-form-textarea" style="min-height:unset; height:32px;">
            </div>
            <div style="flex:1;">
              <label>ê¸°ê°„(ì¼)</label>
              <input type="number" name="period" id="modal-period" class="template-form-textarea" style="min-height:unset; height:32px;">
            </div>
            <div style="flex:1;">
              <label>ìš°ì„ ìˆœìœ„</label>
              <select name="priority" id="modal-priority" style="min-height:unset; height:32px; width:100%; border:1px solid #bbb; border-radius:8px; padding:5px; font-size:0.8em; color:#222; background:#fafbfc; appearance:auto;">
                <option value="ìƒ">ìƒ</option>
                <option value="ì¤‘">ì¤‘</option>
                <option value="í•˜" selected>í•˜</option>
              </select>
            </div>
          </div>
          <div style="display:flex; gap:16px; justify-content:flex-end; margin-top:18px;">
            <button type="submit" class="template-btn" id="modal-save-btn">
              <span class="btn-text">ì €ì¥</span>
              <span class="btn-loading" style="display: none;">
                <div class="loading-spinner"></div>
                ì €ì¥ ì¤‘...
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
function showMessage(message, type = 'success') {
  const messageDiv = document.createElement('div');
  messageDiv.className = `alert alert-${type}`;
  messageDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    z-index: 10000;
    transform: translateX(100%);
    transition: all 0.3s ease;
    ${type === 'success' ? 'background-color: #28a745;' : 'background-color: #dc3545;'}
  `;
  messageDiv.textContent = message;
  
  document.body.appendChild(messageDiv);
  
  // ìŠ¬ë¼ì´ë“œ ì¸ ì• ë‹ˆë©”ì´ì…˜
  setTimeout(() => {
    messageDiv.style.transform = 'translateX(0)';
  }, 10);
  
  // 3ì´ˆ í›„ ìë™ ì œê±°
  setTimeout(() => {
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateX(100%)';
    setTimeout(() => messageDiv.remove(), 300);
  }, 3000);
}

// ê³µìš© ì»¤ë¦¬í˜ëŸ¼ ì²´í¬ë°•ìŠ¤ ì²´í¬ ìƒíƒœ JSë¡œ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
  // ì»¤ë¦¬í˜ëŸ¼ ì´ˆì•ˆ ìƒì„± ë²„íŠ¼ì— AJAX ê¸°ëŠ¥ ì¶”ê°€
  document.getElementById('generate-draft-btn').addEventListener('click', async function() {
    const titleInput = document.querySelector('.tasklist-search');
    const descInput = document.getElementById('curriculum-desc');

    // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
    const title = titleInput.value.trim();
    const description = descInput.value.trim();

    if (!title || !description) {
      showMessage('ì»¤ë¦¬í˜ëŸ¼ ì œëª©ê³¼ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }

    // ë¡œë”© ìƒíƒœ ì‹œì‘
    const btnText = this.querySelector('.btn-text');
    const btnLoading = this.querySelector('.btn-loading');
    
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline-flex';
    this.disabled = true;

    try {
      // API í˜¸ì¶œ - FastAPIë¡œ ì§ì ‘ ìš”ì²­
      const response = await fetch('{{ FASTAPI_BASE_URL }}/api/tasks/generate_draft/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title: title,
          description: description,
          job_role: 'ì‹ ì…ì‚¬ì›',
          weeks: 12,
          goal: 'ì‹ ì…ì‚¬ì›ì˜ ì„±ê³µì ì¸ ì˜¨ë³´ë”©ê³¼ ì¡°ì§ ì ì‘'
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const result = await response.text();
      
      // ê²°ê³¼ê°’ì„ textareaì— ì‚½ì…
      const draftTextarea = document.getElementById('curriculum-textarea');
      draftTextarea.value = result;

      showMessage('ì»¤ë¦¬í˜ëŸ¼ ì´ˆì•ˆì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (error) {
      console.error('Error:', error);
      showMessage(`ì»¤ë¦¬í˜ëŸ¼ ì´ˆì•ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
    } finally {
      // ë¡œë”© ìƒíƒœ í•´ì œ
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      this.disabled = false;
    }
  });
  
  // ì„¸ë¶€ Task ìƒì„± ë²„íŠ¼ì— AJAX ê¸°ëŠ¥ ì¶”ê°€
  document.getElementById('generate-task-btn').addEventListener('click', async function() {
    const titleInput = document.querySelector('.tasklist-search');
    const descInput = document.getElementById('curriculum-desc');
    const weekSchedule = document.getElementById('curriculum-textarea').value.trim();
    
    const title = titleInput.value.trim();
    const description = descInput.value.trim();
    
    if (!title || !description) {
      showMessage('ì»¤ë¦¬í˜ëŸ¼ ì œëª©ê³¼ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }
    
    if (!weekSchedule) {
      showMessage('ì£¼ì°¨ë³„ ì»¤ë¦¬í˜ëŸ¼ ì¼ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }
    
    // ë¡œë”© ìƒíƒœ ì‹œì‘
    const btnText = this.querySelector('.btn-text');
    const btnLoading = this.querySelector('.btn-loading');
    
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline-flex';
    this.disabled = true;
    
    try {
      // API í˜¸ì¶œí•˜ì—¬ ì„¸ë¶€ Task ìƒì„± - FastAPIë¡œ ì§ì ‘ ìš”ì²­
      const response = await fetch('{{ FASTAPI_BASE_URL }}/api/tasks/generate_tasks_from_draft/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title: title,
          description: description,
          job_role: 'ì‹ ì…ì‚¬ì›',
          weeks: 12,
          goal: 'ì‹ ì…ì‚¬ì›ì˜ ì„±ê³µì ì¸ ì˜¨ë³´ë”©ê³¼ ì¡°ì§ ì ì‘'
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();
      
      // ì—ëŸ¬ ì‘ë‹µì¸ì§€ í™•ì¸
      if (result.error) {
        throw new Error(`API Error: ${result.error}`);
      }
      
      const tasks = result.tasks;
      
      // ìƒì„±ëœ tasksë¥¼ window.tasks_jsonì— ì €ì¥
      window.tasks_json = tasks;
      
      // Task ëª©ë¡ ë Œë”ë§
      renderTasksByWeek(tasks);
      showMessage('ì„¸ë¶€ Taskê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
      
    } catch (error) {
      console.error('Task ìƒì„± ì˜¤ë¥˜:', error);
      showMessage(`Task ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
    } finally {
      // ë¡œë”© ìƒíƒœ ì¢…ë£Œ
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      this.disabled = false;
    }
  });

  // 'ì£¼ì°¨ ì¶”ê°€' ë²„íŠ¼ ë™ì‘ êµ¬í˜„
  document.getElementById('add-week-btn').addEventListener('click', function(e) {
    e.preventDefault();
    // í˜„ì¬ tasks_jsonì—ì„œ ê°€ì¥ í° week ê°’ ì°¾ê¸°
    let maxWeek = 0;
    if (Array.isArray(window.tasks_json) && window.tasks_json.length > 0) {
      maxWeek = Math.max(...window.tasks_json.map(t => Number(t.week) || 0));
    }
    
    // ì´ë¯¸ ë Œë”ëœ ì£¼ì°¨ ì¤‘ ê°€ì¥ í° ê°’ë„ ê³ ë ¤
    if (window.persistedWeeks && window.persistedWeeks.length > 0) {
      const maxPersistedWeek = Math.max(...window.persistedWeeks);
      maxWeek = Math.max(maxWeek, maxPersistedWeek);
    }
    
    const newWeek = Math.max(maxWeek + 1, 1); // ìµœì†Œ 1ì£¼ì°¨
    
    // window.persistedWeeksì— ìƒˆ ì£¼ì°¨ ì¶”ê°€
    if (!window.persistedWeeks) {
      window.persistedWeeks = [];
    }
    if (!window.persistedWeeks.includes(newWeek)) {
      window.persistedWeeks.push(newWeek);
    }
    
    // ë‹¤ì‹œ ë Œë”ë§
    renderTasksByWeek(window.tasks_json);
  });
  
  if (window.edit_mode && window.curriculum && window.curriculum.is_common) {
    document.getElementById('is-public-curriculum').checked = true;
  } else {
    document.getElementById('is-public-curriculum').checked = false;
  }
});

// ì£¼ì°¨ë³„ ì»¤ë¦¬í˜ëŸ¼ì—ì„œ ê¸°ë³¸ Task ìƒì„±
function generateTasksFromSchedule(schedule) {
  const lines = schedule.split('\n').filter(line => line.trim());
  const weekPattern = /^#\s*week(\d+)\s+(.+)$/i;
  
  // ê¸°ì¡´ tasks_json í´ë¦¬ì–´
  window.tasks_json = [];
  
  lines.forEach(line => {
    const match = line.match(weekPattern);
    if (match) {
      const week = parseInt(match[1]);
      const weekTitle = match[2].trim();
      
      // ê° ì£¼ì°¨ë³„ë¡œ ê¸°ë³¸ Task ìƒì„±
      window.tasks_json.push({
        week: week,
        title: `${weekTitle} - ì‹¤ìŠµ`,
        description: `${weekTitle}ì— ëŒ€í•œ ì‹¤ìŠµ ê³¼ì œì…ë‹ˆë‹¤.`,
        guideline: 'ì‹¤ìŠµ ê°€ì´ë“œë¼ì¸ì„ ì°¸ê³ í•˜ì—¬ ìˆ˜í–‰í•˜ì„¸ìš”.',
        order: 1,
        period: '7',
        priority: 'ì¤‘'
      });
      
      window.tasks_json.push({
        week: week,
        title: `${weekTitle} - ë³´ê³ ì„œ ì‘ì„±`,
        description: `${weekTitle} í™œë™ì— ëŒ€í•œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`,
        guideline: 'ë³´ê³ ì„œ ì–‘ì‹ì— ë§ì¶° ì‘ì„±í•˜ì„¸ìš”.',
        order: 2,
        period: '3',
        priority: 'í•˜'
      });
    }
  });
  
  // Task ëª©ë¡ ë Œë”ë§
  if (window.tasks_json.length > 0) {
    renderTasksByWeek(window.tasks_json);
    toggleTaskSection(); // Task ì„¹ì…˜ ë³´ì´ê¸°
  }
}

// edit_mode, curriculum, tasks_jsonì´ contextë¡œ ì „ë‹¬ë  ê²½ìš° windowì— í• ë‹¹
// edit_modeê°€ 'True', 'true', '1' ë“± ë‹¤ì–‘í•œ ê°’ìœ¼ë¡œ ì˜¬ ìˆ˜ ìˆìœ¼ë‹ˆ ëª¨ë‘ Trueë¡œ ì¸ì‹
window.edit_mode = ["true", "True", "1"].includes("{{ edit_mode|default:'false' }}");
window.curriculum = JSON.parse('{{ curriculum|escapejs|default:"null" }}');
// curriculum_idê°€ ì—†ìœ¼ë©´ pk, id ì¤‘ í•˜ë‚˜ë¡œ ë³´ì •
if (window.curriculum && !window.curriculum.curriculum_id) {
  if (window.curriculum.pk) {
    window.curriculum.curriculum_id = window.curriculum.pk;
  } else if (window.curriculum.curriculum_id) {
    // ì´ë¯¸ ì˜¬ë°”ë¥¸ í•„ë“œê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    window.curriculum.curriculum_id = window.curriculum.curriculum_id;
  }
}
window.tasks_json = JSON.parse('{{ tasks_json|escapejs|default:"[]" }}');

// ì»¤ë¦¬í˜ëŸ¼ ì´ˆì•ˆ ìƒì„± í•¨ìˆ˜ (í…ìŠ¤íŠ¸ ì¶”ê°€)
function generateDraftContent() {
  const curriculumTextarea = document.getElementById('curriculum-textarea');
  const draftContent = `# week1 ì¡°ì§ë¬¸í™” ì´í•´ ë° ê´€ì°°
# week2 ì¡°ì§ë¬¸í™” ì‹¤ì²œ ì²´í—˜
# week3 ì¡°ì§ë¬¸í™” ì‹¤ì²œ ì²´í—˜ ë°œí‘œ ë° í”¼ë“œë°±
# week4 íŒ€ì›Œí¬ í–¥ìƒ í”„ë¡œê·¸ë¨ ì°¸ì—¬
# week5 ì¡°ì§ ë‚´ ë¹„ê³µì‹ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ íƒìƒ‰
# week6 ì‚¬ë‚´ ì´ë²¤íŠ¸ ì°¸ì—¬ í›„ê¸° ì‘ì„±
# week7 ë™ë£Œ í”¼ë“œë°± ìˆ˜ë ´ ë° ìê¸°ì„±ì°°
# week8 ì‚¬ë‚´ ì´ìŠˆ ë¸Œë¦¬í•‘ ì°¸ì—¬
# week9 ë¶€ì„œ ê°„ í˜‘ì—… ì—…ë¬´ ì°¸ì—¬
# week10 íšŒì‚¬ ë¯¸ì…˜/ë¹„ì „ ì¬í•´ì„ í™œë™
# week11 ì—­ë©˜í† ë§ í™œë™
# week12 í‰ìƒ ì‹ ì…ì‚¬ì› ë˜ê¸° í”„ë¡œì íŠ¸`;
  curriculumTextarea.value = draftContent;
}

// ì„¸ë¶€ Task ìƒì„± í† ê¸€ í•¨ìˆ˜
function toggleTaskSection() {
  const taskList = document.getElementById('task-list');
  if (taskList.style.display === 'none') {
    taskList.style.display = 'flex';
  } else {
    taskList.style.display = 'none';
  }
}

// Task ì„¹ì…˜ì„ í™•ì‹¤íˆ ë³´ì´ê²Œ í•˜ëŠ” í•¨ìˆ˜
function showTaskSection() {
  const taskList = document.getElementById('task-list');
  taskList.style.display = 'flex';
}

// Drag & Drop for task list (ì£¼ì°¨ë³„ ì´ë™ ë° ì£¼ì°¨ ë‚´ ìˆœì„œë§Œ ë³€ê²½)
function initTaskListDnD() {
  const taskList = document.getElementById('task-list');
  let draggingIdx = null;
  let draggingWeek = null;
  let draggingEl = null;

  // ë“œë˜ê·¸ ì‹œì‘/ì¢…ë£Œ ì´ë²¤íŠ¸ë¥¼ ê° ì¹´ë“œì— ë“±ë¡
  Array.from(taskList.querySelectorAll('.template-task-item')).forEach(item => {
    item.addEventListener('dragstart', e => {
      // ì´ë¯¸ draggingElì´ ìˆìœ¼ë©´ ë¬´ì‹œ (í•œ ë²ˆì— í•˜ë‚˜ë§Œ)
      if (draggingEl) {
        e.preventDefault();
        return false;
      }
      draggingEl = item;
      draggingIdx = Number(item.dataset.idx);
      draggingWeek = Number(item.dataset.week);
      item.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    item.addEventListener('dragend', e => {
      draggingEl = null;
      draggingIdx = null;
      draggingWeek = null;
      item.classList.remove('dragging');
      Array.from(taskList.querySelectorAll('.template-task-item')).forEach(i => i.classList.remove('drag-over'));
    });
  });

  // ê° ì£¼ì°¨ë³„ ì˜ì—­ì— drop ì´ë²¤íŠ¸ ë“±ë¡
  Array.from(taskList.querySelectorAll('.week-section')).forEach(weekSection => {
    weekSection.addEventListener('dragover', e => {
      e.preventDefault();
      // ë“œë¡­ ìœ„ì¹˜ ì‹œê°í™”(ì„ íƒì )
    });
    weekSection.addEventListener('drop', e => {
      e.preventDefault();
      if (draggingIdx === null) return;
      const targetWeek = Number(weekSection.dataset.week);
      // ë“œë¡­ ìœ„ì¹˜ ê³„ì‚° (ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê¸°ì¤€)
      const items = Array.from(weekSection.querySelectorAll('.template-task-item'));
      let insertIdx = items.length;
      for (let i = 0; i < items.length; i++) {
        const rect = items[i].getBoundingClientRect();
        if (e.clientY < rect.top + rect.height / 2) {
          insertIdx = i;
          break;
        }
      }
      // draggingIdxëŠ” window.tasks_jsonì˜ ì¸ë±ìŠ¤
      const movingTask = window.tasks_json[draggingIdx];
      if (!movingTask) return;
      // ì‹¤ì œ ë°ì´í„°ì—ì„œ ì œê±° (spliceëŠ” ì›ë³¸ ë°°ì—´ì„ ë³€ê²½í•˜ë¯€ë¡œ, ì œê±° í›„ ì¸ë±ìŠ¤ê°€ ë°”ë€œ)
      window.tasks_json.splice(draggingIdx, 1);
      // ì£¼ì°¨ ë³€ê²½
      movingTask.week = targetWeek;
      // targetWeekì˜ Taskë“¤ë§Œ ì¶”ì¶œ (ì´ë™ í›„ ê¸°ì¤€)
      const weekTasks = window.tasks_json.filter(t => Number(t.week) === targetWeek);
      // insertIdx ìœ„ì¹˜ ê³„ì‚° (weekTasks ë‚´ì—ì„œ)
      // window.tasks_jsonì—ì„œ targetWeekì˜ insertIdxë²ˆì§¸ ìœ„ì¹˜ë¥¼ ì°¾ìŒ
      let realInsertIdx = -1;
      let cnt = 0;
      for (let i = 0; i <= window.tasks_json.length; i++) {
        if (i === window.tasks_json.length) {
          // ëê¹Œì§€ ë„ë‹¬í•˜ë©´ ë§ˆì§€ë§‰ì— ì‚½ì…
          realInsertIdx = window.tasks_json.length;
          break;
        }
        if (Number(window.tasks_json[i].week) === targetWeek) {
          if (cnt === insertIdx) {
            realInsertIdx = i;
            break;
          }
          cnt++;
        }
      }
      // í•´ë‹¹ ìœ„ì¹˜ì— ì‚½ì…
      if (realInsertIdx === -1) realInsertIdx = window.tasks_json.length;
      window.tasks_json.splice(realInsertIdx, 0, movingTask);
      // ë Œë”ë§ ê°±ì‹ 
      renderTasksByWeek(window.tasks_json);
      // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì¬ë“±ë¡
      setTimeout(initTaskListDnD, 0);
    });
  });
}

// edit_modeì¼ ë•Œ í¼ ìë™ ì±„ìš°ê¸°
document.addEventListener('DOMContentLoaded', function() {
  const taskList = document.getElementById('task-list');

  // ì£¼ì°¨ë³„ë¡œ ê·¸ë£¹í•‘í•˜ì—¬ ì¹´ë“œ ë Œë”ë§
  function renderTasksByWeek(tasks) {
    // ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ windowì— í• ë‹¹
    window.renderTasksByWeek = renderTasksByWeek;
    // ëª¨ë“  ì£¼ì°¨ ë²ˆí˜¸ë¥¼ êµ¬í•¨ (tasksì— ìˆëŠ” week + ë¹ˆ ì£¼ì°¨ë„ ìœ ì§€)
    // 1. í˜„ì¬ tasksì— ìˆëŠ” week
    const weekSet = new Set();
    tasks.forEach(task => {
      const week = task.week || 1;
      weekSet.add(Number(week));
    });
    // 2. ì´ë¯¸ ë Œë”ëœ week-sectionì˜ ì£¼ì°¨ë„ ìœ ì§€ (ì¹´ë“œê°€ 0ê°œê°€ ë˜ì–´ë„ ì˜ì—­ ìœ ì§€)
    if (window.persistedWeeks) {
      window.persistedWeeks.forEach(w => weekSet.add(Number(w)));
    }
    // 3. ì£¼ì°¨ ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€ëœ ë¹ˆ ì£¼ì°¨ë„ ìœ ì§€
    // (tasks_jsonì— ë¹ˆ Taskë¡œ ì¶”ê°€ë˜ë¯€ë¡œ ìœ„ì—ì„œ ì´ë¯¸ í¬í•¨ë¨)
    
    // 4. í¸ì§‘ ëª¨ë“œì—ì„œ ì£¼ì°¨ê°€ ì—†ìœ¼ë©´ ìµœì†Œ 1ì£¼ì°¨ëŠ” í‘œì‹œ
    if (weekSet.size === 0) {
      weekSet.add(1);
    }

    // ì£¼ì°¨ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
    const sortedWeeks = Array.from(weekSet).sort((a, b) => a - b);
    // ë Œë”ëœ ì£¼ì°¨ë¥¼ window.persistedWeeksì— ì €ì¥
    window.persistedWeeks = sortedWeeks;

    // week ê¸°ì¤€ ê·¸ë£¹í•‘
    const weekMap = {};
    tasks.forEach(task => {
      const week = task.week || 1;
      if (!weekMap[week]) weekMap[week] = [];
      weekMap[week].push(task);
    });

    taskList.innerHTML = '';
    sortedWeeks.forEach(week => {
      const weekTasks = weekMap[week] || [];
      // ì£¼ì°¨ë³„ ì˜ì—­
      const weekSection = document.createElement('div');
      weekSection.className = 'week-section';
      weekSection.dataset.week = week;
      // ì£¼ì°¨ í—¤ë” + Task ì¶”ê°€ ë²„íŠ¼
      const weekHeader = document.createElement('div');
      weekHeader.style = 'font-weight:bold; font-size:1.1em; margin-bottom:10px; color:#000000; display:flex; align-items:center; justify-content:space-between;';
      // Task ì¶”ê°€ ë²„íŠ¼ê³¼ ì£¼ì°¨ ì‚­ì œ ë²„íŠ¼ (1ì£¼ì°¨ê°€ ì•„ë‹ ë•Œë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ)
      weekHeader.innerHTML = `
        <span>${week}ì£¼ì°¨</span>
        <div style="display:flex; align-items:center;">
          <button class='template-btn add-task-modal-btn' style='padding:6px 18px; font-size:14px; margin-left:10px;' data-week="${week}">Task ì¶”ê°€</button>
          ${week !== 1 ? `<button class='week-delete-btn' style='background-color:white' data-week="${week}" title="ì£¼ì°¨ ì‚­ì œ">ğŸ—‘ï¸</button>` : ''}
        </div>
      `;
      weekSection.appendChild(weekHeader);
      // ê° Task ì¹´ë“œ
      weekTasks.forEach((task, idx) => {
        // tasks ë°°ì—´ì—ì„œ í˜„ì¬ taskì˜ ì‹¤ì œ ì¸ë±ìŠ¤ë¥¼ ì°¾ê¸°
        let globalTaskIdx = -1;
        for (let i = 0; i < window.tasks_json.length; i++) {
          if (window.tasks_json[i] === task) {
            globalTaskIdx = i;
            break;
          }
        }
        
        // ë§Œì•½ ì°¾ì§€ ëª»í–ˆë‹¤ë©´ titleê³¼ weekë¡œ ë§¤ì¹­ ì‹œë„
        if (globalTaskIdx === -1) {
          globalTaskIdx = window.tasks_json.findIndex(t => 
            t.title === task.title && 
            t.week === task.week && 
            t.description === task.description
          );
        }
        
        console.log('Task:', task.title, 'Global index:', globalTaskIdx);
        
        // Task ì¹´ë“œì™€ ì‚­ì œ ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ìƒì„±
        const taskContainer = document.createElement('div');
        taskContainer.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 4px;';
        
        const item = document.createElement('div');
        item.className = 'template-task-item';
        item.setAttribute('draggable', 'true');
        item.dataset.idx = globalTaskIdx;
        item.dataset.week = week;
        item.innerHTML = `
          <div class="task-content">
            <div class="task-badges">
              <span class="task-badge difficulty-${task.priority === 'ìƒ' ? 'high' : (task.priority === 'ì¤‘' ? 'medium' : 'low')}">${task.priority || 'í•˜'}</span>
              ${task.period ? `<span class='task-badge exp-badge'>${task.period}ì¼</span>` : ''}
            </div>
            <div style="font-weight:bold; color:#222;">${task.title || ''}</div>
            ${task.guideline ? `<div style='color:#1976d2; font-size:13px;'>ê°€ì´ë“œ: ${task.guideline}</div>` : ''}
            ${task.description ? `<div style='color:#555; font-size:13px;'>ì„¤ëª…: ${task.description}</div>` : ''}
          </div>
        `;
        
        // ì‚­ì œ ë²„íŠ¼ì„ ë³„ë„ë¡œ ìƒì„±
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn task-delete-btn';
        deleteBtn.setAttribute('data-task-idx', globalTaskIdx);
        deleteBtn.setAttribute('title', 'Task ì‚­ì œ');
        deleteBtn.textContent = 'âŒ';
        deleteBtn.style.cssText = 'flex-shrink: 0; margin-left: 0;';
        
        // ì¹´ë“œ í´ë¦­ ì‹œ ëª¨ë‹¬ ì˜¤í”ˆ (ì‚­ì œ ë²„íŠ¼ ì œì™¸)
        item.addEventListener('click', function(e) {
          e.stopPropagation();
          openTaskModal({ ...task, idx: globalTaskIdx }, week);
        });
        
        // ì»¨í…Œì´ë„ˆì— ì¹´ë“œì™€ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
        taskContainer.appendChild(item);
        taskContainer.appendChild(deleteBtn);
        weekSection.appendChild(taskContainer);
      });
      taskList.appendChild(weekSection);
    });
    taskList.style.display = 'flex';
    // ë“œë˜ê·¸&ë“œë¡­ ì´ë²¤íŠ¸ ì¬ë“±ë¡
    setTimeout(initTaskListDnD, 0);
  }

  // ì´ë²¤íŠ¸ ìœ„ì„: Task ì¶”ê°€ ë²„íŠ¼ ë° ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
  taskList.addEventListener('click', async function(e) {
    console.log('Click event target:', e.target);
    console.log('Target classes:', e.target.classList);
    console.log('Target data-task-idx:', e.target.getAttribute('data-task-idx'));
    
    // Task ì¶”ê°€ ë²„íŠ¼ í´ë¦­
    if (e.target.classList.contains('add-task-modal-btn')) {
      e.preventDefault();
      e.stopPropagation();
      const week = Number(e.target.getAttribute('data-week'));
      openTaskModal(null, week);
    }
    // Task ì‚­ì œ ë²„íŠ¼ í´ë¦­ - ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ê°ì§€
    else if (e.target.classList.contains('task-delete-btn') || 
             e.target.classList.contains('delete-btn') || 
             e.target.hasAttribute('data-task-idx')) {
      console.log('Task delete button clicked');
      e.preventDefault();
      e.stopPropagation();
      
      const taskIdx = Number(e.target.getAttribute('data-task-idx'));
      console.log('Task index from data attribute:', taskIdx);
      
      if (!isNaN(taskIdx) && taskIdx >= 0 && await showCustomConfirm('ì´ Taskë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        deleteTask(taskIdx);
      }
    }
    // ì£¼ì°¨ ì‚­ì œ ë²„íŠ¼ í´ë¦­
    else if (e.target.classList.contains('week-delete-btn')) {
      e.preventDefault();
      e.stopPropagation();
      const week = Number(e.target.getAttribute('data-week'));
      if (await showCustomConfirm(`${week}ì£¼ì°¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•´ë‹¹ ì£¼ì°¨ì˜ ëª¨ë“  Taskê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
        deleteWeek(week);
      }
    }
  });

// Task ì‚­ì œ í•¨ìˆ˜
function deleteTask(taskIdx) {
  console.log('deleteTask called with index:', taskIdx);
  console.log('Current tasks_json length:', window.tasks_json ? window.tasks_json.length : 'undefined');
  console.log('Current tasks_json:', window.tasks_json);
  
  // window.tasks_jsonì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
  if (!window.tasks_json || !Array.isArray(window.tasks_json)) {
    console.error('tasks_json is not defined or not an array');
    showMessage('Task ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  // taskIdxê°€ ìœ íš¨í•œ ìˆ«ìì¸ì§€ í™•ì¸
  if (isNaN(taskIdx) || taskIdx < 0 || taskIdx >= window.tasks_json.length) {
    console.error('Invalid task index:', taskIdx, 'Array length:', window.tasks_json.length);
    showMessage('ì‚­ì œí•  Taskë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  const taskToDelete = window.tasks_json[taskIdx];
  console.log('Task to delete:', taskToDelete);
  
  // Task ì‚­ì œ
  window.tasks_json.splice(taskIdx, 1);
  console.log('Task deleted. New array length:', window.tasks_json.length);
  
  // í™”ë©´ ë‹¤ì‹œ ë Œë”ë§
  renderTasksByWeek(window.tasks_json);
  showMessage('Taskê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ì£¼ì°¨ ì‚­ì œ í•¨ìˆ˜
function deleteWeek(week) {
  // í•´ë‹¹ ì£¼ì°¨ì˜ ëª¨ë“  Task ì‚­ì œ
  window.tasks_json = window.tasks_json.filter(task => Number(task.week) !== week);
  
  // persistedWeeksì—ì„œë„ í•´ë‹¹ ì£¼ì°¨ ì œê±°
  if (window.persistedWeeks) {
    window.persistedWeeks = window.persistedWeeks.filter(w => Number(w) !== week);
  }
  
  renderTasksByWeek(window.tasks_json);
  showMessage(`${week}ì£¼ì°¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// Task ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
function openTaskModal(task, week) {
  const modal = document.getElementById('task-modal');
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  // ê°’ ì„¸íŒ…
  document.getElementById('modal-title').value = task?.title || '';
  document.getElementById('modal-description').value = task?.description || '';
  document.getElementById('modal-guideline').value = task?.guideline || '';
  document.getElementById('modal-week-input').value = week || task?.week || '';
  document.getElementById('modal-period').value = task?.period || '';
  // ìš°ì„ ìˆœìœ„ select ê°’ ì„¸íŒ… (optionê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê°’ë§Œ í—ˆìš©, ê¸°ë³¸ê°’ 'í•˜')
  const prioritySelect = document.getElementById('modal-priority');
  const validPriorities = ['ìƒ', 'ì¤‘', 'í•˜'];
  let priorityValue = (task?.priority || 'í•˜');
  if (!validPriorities.includes(priorityValue)) priorityValue = 'í•˜';
  prioritySelect.value = priorityValue;
  document.getElementById('modal-edit-index').value = task?.idx ?? '';
  document.getElementById('modal-week').value = week || task?.week || '';
}
function closeTaskModal() {
  document.getElementById('task-modal').style.display = 'none';
  document.body.style.overflow = '';
}
document.getElementById('close-modal-btn').onclick = closeTaskModal;
document.getElementById('task-modal').addEventListener('click', function(e) {
  if (e.target === this) closeTaskModal();
});
document.getElementById('task-form').onsubmit = function(e) {
  e.preventDefault();
  
  const modalSaveBtn = document.getElementById('modal-save-btn');
  const btnText = modalSaveBtn.querySelector('.btn-text');
  const btnLoading = modalSaveBtn.querySelector('.btn-loading');
  
  // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
  const title = document.getElementById('modal-title').value.trim();
  const description = document.getElementById('modal-description').value.trim();
  const guideline = document.getElementById('modal-guideline').value.trim();
  const week = Number(document.getElementById('modal-week-input').value);
  // ìˆœì„œ ì…ë ¥ë€ ì œê±°ë¨
  const order = 1;
  const period = document.getElementById('modal-period').value.trim();
  const priority = document.getElementById('modal-priority').value;
  const editIdx = document.getElementById('modal-edit-index').value;

  if (!title) {
    showMessage('ê³¼ì œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
    return;
  }

  // ë¡œë”© ìƒíƒœ ì‹œì‘
  btnText.style.display = 'none';
  btnLoading.style.display = 'inline-flex';
  modalSaveBtn.disabled = true;

  try {
    // ìˆ˜ì • ëª¨ë“œ: editIdxê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì¸ë±ìŠ¤ ìˆ˜ì •
    if (editIdx !== '') {
      const idx = Number(editIdx);
      if (window.tasks_json[idx]) {
        window.tasks_json[idx] = { title, description, guideline, week, order, period, priority };
      }
    } else {
      // ì¶”ê°€ ëª¨ë“œ: í•´ë‹¹ ì£¼ì°¨ì— ì¶”ê°€
      window.tasks_json.push({ title, description, guideline, week, order, period, priority });
    }
    
    // ì„±ê³µ ë©”ì‹œì§€
    showMessage(editIdx !== '' ? 'Taskê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'Taskê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
    
    renderTasksByWeek(window.tasks_json);
    closeTaskModal();
  } catch (error) {
    console.error('Task ì €ì¥ ì˜¤ë¥˜:', error);
    showMessage('Task ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  } finally {
    // ë¡œë”© ìƒíƒœ ì¢…ë£Œ
    btnText.style.display = 'inline';
    btnLoading.style.display = 'none';
    modalSaveBtn.disabled = false;
  }
};

// ì €ì¥ ë²„íŠ¼ AJAX í•¸ë“¤ëŸ¬
document.getElementById('save-curriculum-btn').onclick = async function() {
  const btnText = this.querySelector('.btn-text');
  const btnLoading = this.querySelector('.btn-loading');
  
  // ì»¤ë¦¬í˜ëŸ¼ ì •ë³´
  const curriculum_title = document.querySelector('input.tasklist-search').value.trim();
  const curriculum_description = document.getElementById('curriculum-desc').value.trim();
  const week_schedule = document.getElementById('curriculum-textarea').value.trim();
  const is_common = document.getElementById('is-public-curriculum').checked;

  // ì…ë ¥ ê²€ì¦
  if (!curriculum_title) {
    showMessage('ì»¤ë¦¬í˜ëŸ¼ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }

  if (!curriculum_description) {
    showMessage('ì»¤ë¦¬í˜ëŸ¼ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }

  if (!week_schedule) {
    showMessage('ì£¼ì°¨ë³„ ì»¤ë¦¬í˜ëŸ¼ ì¼ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }

  // ë¡œë”© ìƒíƒœ ì‹œì‘
  btnText.style.display = 'none';
  btnLoading.style.display = 'inline-flex';
  this.disabled = true;

  try {
    // Task ë¦¬ìŠ¤íŠ¸: ì£¼ì°¨ë³„, ì¹´ë“œ ìˆœì„œëŒ€ë¡œ order ë¶€ì—¬
    let tasks = [];
    // task-listì˜ DOMì—ì„œ ì£¼ì°¨ë³„, ì¹´ë“œ ìˆœì„œëŒ€ë¡œ ì¶”ì¶œ
    const taskList = document.getElementById('task-list');
    const weekSections = taskList.querySelectorAll('.week-section');
    weekSections.forEach(weekSection => {
      const week = Number(weekSection.dataset.week);
      const cards = weekSection.querySelectorAll('.template-task-item');
      cards.forEach((card, idx) => {
        // ì¹´ë“œì˜ idxì— í•´ë‹¹í•˜ëŠ” window.tasks_jsonì—ì„œ ì •ë³´ ì¶”ì¶œ
        // titleë¡œ ë§¤ì¹­ (title+week+description+guideline+period+priority)
        const title = card.querySelector('.task-content > div[style*="font-weight:bold"]')?.textContent.trim() || '';
        const badge = card.querySelector('.task-badge');
        const priority = badge ? badge.textContent.trim() : 'í•˜';
        const period = card.querySelector('.exp-badge') ? (card.querySelector('.exp-badge').textContent.replace('ì¼','').trim()) : '';
        const guideline = card.querySelector('div[style*="color:#1976d2"]') ? card.querySelector('div[style*="color:#1976d2"]').textContent.replace('ê°€ì´ë“œ:','').trim() : '';
        const description = card.querySelector('div[style*="color:#555"]') ? card.querySelector('div[style*="color:#555"]').textContent.replace('ì„¤ëª…:','').trim() : '';
        tasks.push({
          week,
          order: idx + 1,
          title,
          guideline,
          description,
          period,
          priority
        });
      });
    });

    // edit_modeì™€ curriculumì´ ìˆìœ¼ë©´ curriculum_idë„ ì „ì†¡
    let curriculum_id = null;
    if (window.edit_mode && window.curriculum) {
      curriculum_id = window.curriculum.curriculum_id || window.curriculum.pk;
    }
    
    console.log('Edit mode:', window.edit_mode);
    console.log('Curriculum:', window.curriculum);
    console.log('Curriculum ID to send:', curriculum_id);

    const csrftoken = getCookie('csrftoken');

    // AJAX POST
    const resp = await fetch('/mentor/api/save_curriculum/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        curriculum_id,
        curriculum_title,
        curriculum_description,
        week_schedule,
        is_common,
        tasks
      })
    });

    if (resp.ok) {
      const data = await resp.json();
      if (data.success) {
        showMessage('ì»¤ë¦¬í˜ëŸ¼ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        setTimeout(() => {
          window.location.href = '/mentor/manage_template';
        }, 1500);
      } else {
        throw new Error(data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } else {
      throw new Error('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('ì €ì¥ ì˜¤ë¥˜:', error);
    showMessage(error.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  } finally {
    // ë¡œë”© ìƒíƒœ ì¢…ë£Œ
    btnText.style.display = 'inline';
    btnLoading.style.display = 'none';
    this.disabled = false;
  }
};

  // edit_modeê°€ ì•„ë‹ ë•Œ: 1ì£¼ì°¨ ì˜ì—­ë§Œ ë³´ì´ê³ , Task ì¹´ë“œëŠ” ì—†ìŒ
  // edit_modeê°€ ì•„ë‹ ë•Œ: 1ì£¼ì°¨ ì˜ì—­ë§Œ ë³´ì´ê³ , Task ì¹´ë“œëŠ” ì—†ìŒ
  function renderExampleTasks() {
    // 1ì£¼ì°¨ ì˜ì—­ë§Œ ë¹ˆ ìƒíƒœë¡œ ë Œë”ë§ & ë‚´ë¶€ ìƒíƒœë„ 1ì£¼ì°¨ë§Œ ìˆë„ë¡ ì´ˆê¸°í™”
    window.tasks_json = [];
    window.persistedWeeks = [1];
    renderTasksByWeek(window.tasks_json);
  }

  if (window.edit_mode && window.curriculum) {
    document.querySelector('input.tasklist-search').value = window.curriculum.curriculum_title || '';
    document.getElementById('curriculum-desc').value = window.curriculum.curriculum_description || '';
    document.getElementById('curriculum-textarea').value = window.curriculum.week_schedule || '';

    // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” Task ì„¹ì…˜ì„ ë°”ë¡œ ë³´ì´ê²Œ í•¨
    showTaskSection();

    if (Array.isArray(window.tasks_json) && window.tasks_json.length > 0) {
      renderTasksByWeek(window.tasks_json);
    } else {
      // Taskê°€ ì—†ì–´ë„ ê¸°ë³¸ 1ì£¼ì°¨ëŠ” í‘œì‹œí•˜ê³  Task ì„¹ì…˜ë„ ë³´ì´ê²Œ
      window.tasks_json = [];
      renderTasksByWeek(window.tasks_json);
    }
    initTaskListDnD();
  } else {
    // edit_modeê°€ ì•„ë‹ ë•ŒëŠ” 1ì£¼ì°¨ ë¹ˆ ì˜ì—­ë§Œ ë³´ì´ê²Œ (Task ì¹´ë“œ ì—†ìŒ)
    renderExampleTasks();
    initTaskListDnD();
  }
});
</script>
{% endblock %}