{% extends 'base.html' %}
{% load static %}

{% block title %}íƒœìŠ¤í¬ ëª©ë¡ - í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„±{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/common/mentee_task_list.css' %}">
<style>
.create-subtask-btn {
    font-size: 13px !important;
    background: #28a745 !important;
    color: white !important;
    border: none !important;
    padding: 4px 12px !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    font-weight: 500 !important;
    margin-left: 8px !important;
}
.create-subtask-btn:hover {
    background: #218838 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="tasklist-container">
  <div class="tasklist-left" id="tasklist-left">
    {% for week, tasks in week_tasks.items %}
      <div style="font-weight:bold; margin:18px 0 8px 0;">{{ week }}ì£¼ì°¨</div>
      {% for task in tasks %}
        {% if not task.parent %}
        <div class="task-card" data-task-id="{{ task.task_id }}">
          <div class="task-card-header">
            <span class="task-title">{{ task.title }}</span>
          </div>
          <div class="task-desc-row">
            <div class="task-desc">{{ task.description }}</div>
          </div>
          
          <!-- í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ë²„íŠ¼ -->
          <button type="button" 
                  class="create-subtask-btn" 
                  onclick="openSubtaskModal({{ task.task_id }}, '{{ task.title|escapejs }}')">
            + í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„±
          </button>
        </div>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
  
  <div class="tasklist-right">
    <div id="detail-title">íƒœìŠ¤í¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
    <div id="detail-desc">ì„¤ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
    <div id="guideline-content">ê°€ì´ë“œë¼ì¸ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
    <div id="chat-messages">ë©”ëª¨ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
  </div>
</div>

<!-- í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ëª¨ë‹¬ -->
<div id="subtask-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000;">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border-radius:12px; padding:24px; width:500px;">
    <h3>í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„±</h3>
    <button onclick="closeSubtaskModal()" style="float:right;">Ã—</button>
    
    <form id="subtask-form" onsubmit="createSubtask(event)">
      <div style="margin-bottom:16px;">
        <label>ìƒìœ„ Task</label>
        <input id="parent-task-title" type="text" readonly style="width:100%; padding:10px;">
        <input id="parent-task-id" type="hidden">
      </div>
      
      <div style="margin-bottom:16px;">
        <label>ì œëª© *</label>
        <input id="subtask-title" type="text" required style="width:100%; padding:10px;">
      </div>
      
      <div style="margin-bottom:16px;">
        <label>ê°€ì´ë“œë¼ì¸</label>
        <textarea id="subtask-guideline" style="width:100%; height:60px; padding:10px;"></textarea>
      </div>
      
      <div style="margin-bottom:16px;">
        <label>ì„¸ë¶€ë‚´ìš©</label>
        <textarea id="subtask-description" style="width:100%; height:80px; padding:10px;"></textarea>
      </div>
      
      <div style="text-align:right;">
        <button type="button" onclick="closeSubtaskModal()">ì·¨ì†Œ</button>
        <button type="submit" style="background:#28a745; color:white; margin-left:10px;">ìƒì„±</button>
      </div>
    </form>
  </div>
</div>

<script>
// ê°„ë‹¨í•œ JavaScript í•¨ìˆ˜ë“¤
function openSubtaskModal(parentId, parentTitle) {
    console.log('ëª¨ë‹¬ ì—´ê¸°:', parentId, parentTitle);
    document.getElementById('subtask-modal').style.display = 'block';
    document.getElementById('parent-task-title').value = parentTitle;
    document.getElementById('parent-task-id').value = parentId;
}

function closeSubtaskModal() {
    document.getElementById('subtask-modal').style.display = 'none';
    document.getElementById('subtask-form').reset();
}

async function createSubtask(event) {
    event.preventDefault();
    
    const parentId = document.getElementById('parent-task-id').value;
    const title = document.getElementById('subtask-title').value;
    const guideline = document.getElementById('subtask-guideline').value;
    const description = document.getElementById('subtask-description').value;
    
    console.log('í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„±:', {parentId, title, guideline, description});
    
    try {
        // URLì—ì„œ mentorship_id ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const mentorshipId = urlParams.get('mentorship_id');
        console.log('ğŸ” URLì—ì„œ ê°€ì ¸ì˜¨ ë©˜í† ì‹­ ID:', mentorshipId);
        
        if (!mentorshipId) {
            alert('URLì— mentorship_idê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        
        const response = await fetch(`/mentee/create_subtask/${parentId}/?mentorship_id=${mentorshipId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                title: title,
                guideline: guideline,
                description: description,
                mentorship_id: parseInt(mentorshipId),
                status: 'ì§„í–‰ì „'
            })
        });
        
        const data = await response.json();
        console.log('ì‘ë‹µ:', data);
        
        if (data.success) {
            alert('í•˜ìœ„ íƒœìŠ¤í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeSubtaskModal();
            location.reload();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        console.error('ì˜¤ë¥˜:', error);
        alert('ìƒì„± ì‹¤íŒ¨: ' + error.message);
    }
}
</script>
{% endblock %} 