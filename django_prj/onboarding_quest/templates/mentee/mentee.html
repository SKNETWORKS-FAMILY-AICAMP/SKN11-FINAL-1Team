{% extends 'base.html' %}
{% load static %}

{% block title %}멘티 대시보드{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/mentee/mentee.css' %}">
<style>
.kanban-board { display: flex; gap: 25px; min-height: 600px; }

/* 기본 칸반 컬럼 스타일 */
.kanban-column { 
  border-radius: 16px; 
  padding: 20px 15px 20px 15px; 
  min-height: 500px; 
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border: 1px solid #e5e7eb;
}

/* 각 컬럼별 배경색 */
.todo-column { 
  background: #f8f9fa; 
}
.processing-column { 
  background: #fefce8; 
}
.review-request-column { 
  background: #fef2f2; 
}
.success-column { 
  background: #f0fdf4; 
}

.kanban-header { 
  font-weight: 600; 
  font-size: 1.1em; 
  margin-bottom: 16px; 
  color: #374151;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 8px;
}

/* 기본 카드 스타일 - 모든 카드는 화이트 */
.kanban-card { 
  background: #ffffff; 
  border-radius: 12px; 
  box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06); 
  margin-bottom: 16px; 
  padding: 16px 18px 14px 18px; 
  border-left: 4px solid transparent; 
  transition: all 0.2s ease; 
  position: relative; 
  cursor: pointer; 
  border: 1px solid #f3f4f6;
}

/* 카드 호버 및 선택 효과 */
.kanban-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}

.kanban-card:active,
.kanban-card.selected {
  border-left: 4px solid #3b82f6;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

/* 컬럼별 카드 좌측 테두리 색상 (선택 시) */
.todo-column .kanban-card:active,
.todo-column .kanban-card.selected {
  border-left-color: #6b7280;
}

.processing-column .kanban-card:active,
.processing-column .kanban-card.selected {
  border-left-color: #f59e0b;
}

.review-request-column .kanban-card:active,
.review-request-column .kanban-card.selected {
  border-left-color: #dc2626;
}

.success-column .kanban-card:active,
.success-column .kanban-card.selected {
  border-left-color: #10b981;
}

/* 드래그 효과 */
.kanban-card.dragging {
  opacity: 0.6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3), 0 8px 24px rgba(0,0,0,0.15);
  border-left-color: #3b82f6;
  z-index: 10;
}

.kanban-column.drop-hover {
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
  transition: all 0.2s ease;
}

.kanban-card-row { 
  display: flex; 
  align-items: center; 
  gap: 8px; 
  justify-content: space-between; 
  margin-bottom: 6px; 
}

.d-day-badge { 
  font-weight: 600; 
  color: #dc2626; 
  background: #fef2f2; 
  border: 1px solid #fecaca;
  border-radius: 8px; 
  padding: 3px 8px; 
  font-size: 12px; 
  min-width: 54px; 
  text-align: center; 
}

.kanban-title { 
  font-weight: 600; 
  color: #1f2937; 
  font-size: 15px; 
  flex: 1; 
  margin-left: 6px; 
  line-height: 1.4;
}

.kanban-diff { 
  font-size: 12px; 
  font-weight: 600; 
  border-radius: 6px; 
  padding: 3px 8px; 
  margin-left: 6px; 
}

.diff-high { background: #dc2626; color: #ffffff; }
.diff-mid { background: #10b981; color: #ffffff; }
.diff-low { background: #f59e0b; color: #ffffff; }

.kanban-desc { 
  color: #6b7280; 
  font-size: 13px; 
  margin-top: 4px; 
  line-height: 1.5;
}

/* 완료된 카드 스타일 */
.success-column .kanban-card { 
  text-decoration: line-through; 
  color: #9ca3af; 
  opacity: 0.7;
}

.success-task {
  text-decoration: line-through;
  color: #9ca3af;
  opacity: 0.7;
}
</style>
{% endblock %}

{% block content %}
  <div class="main-content bg-gray-50 p-8 rounded-lg">
    <div class="welcome-section bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-8 flex items-center gap-6">
      <img src="{% if request.user.is_authenticated and request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}{% static 'img/default_profile.png' %}{% endif %}" alt="프로필" class="w-16 h-16 rounded-full object-cover border-2 border-green-200 bg-white shadow-sm" />
      <div class="flex flex-col flex-1">
        <div class="flex items-center gap-3 mb-2">
          <span class="text-xl font-bold text-gray-900">완료율: <span id="userLevelTop">{{ completion_percentage|default:0 }}%</span></span>
          <span class="text-sm text-green-700 bg-green-50 px-3 py-1 rounded-full border border-green-200 font-medium">신입 멘티</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
          <div id="expBarTop" class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width: {{ completion_percentage|default:0 }}%"></div>
        </div>
        <div class="text-sm text-gray-600 font-medium">완료 Task: <span id="userExpTop">{{ completed_tasks|default:0 }}</span> / <span id="userExpMaxTop">{{ total_tasks|default:0 }}</span></div>
      </div>      
    </div>

    <div class="kanban-section bg-white rounded-xl shadow-md border border-gray-200 p-3 mb-8" style="display: flex;">
      <div class="kanban-column todo-column" style="flex:1; min-width:280px;" ondrop="drop(event)" ondragover="allowDrop(event)">
        <div class="kanban-header">진행 전</div>
        {% for task in status_tasks.진행전 %}
        <div class="kanban-card" data-date="{{ task.scheduled_end_date|date:'Y-m-d' }}" draggable="true" id="task{{ task.id }}">
          <div class="kanban-card-row" style="margin-bottom:2px; justify-content:space-between;">
            <div class="kanban-meta-left" style="display:flex;align-items:center;gap:8px;">
              {% if task.dday_text %}
                <span class="d-day-badge">{{ task.dday_text }}</span>
              {% endif %}
              <span class="kanban-diff {% if task.priority == '상' %}diff-high{% elif task.priority == '중' %}diff-mid{% else %}diff-low{% endif %}">{{ task.priority }}</span>
            </div>
          </div>
          <div class="kanban-card-row">
            <span class="kanban-title">{{ task.title }}</span>
          </div>
          <div class="kanban-desc">{{ task.description|default:"설명이 없습니다." }}</div>
        </div>
        {% empty %}
        <div style="text-align: center; color: #9ca3af; padding: 20px; font-style: italic;">
          진행 전인 태스크가 없습니다.
        </div>
        {% endfor %}
      </div>
      
      <div class="kanban-column processing-column" style="flex:1; min-width:280px;" ondrop="drop(event)" ondragover="allowDrop(event)">
        <div class="kanban-header">진행 중</div>
        {% for task in status_tasks.진행중 %}
        <div class="kanban-card" data-date="{{ task.scheduled_end_date|date:'Y-m-d' }}" draggable="true" id="task{{ task.id }}">
          <div class="kanban-card-row" style="margin-bottom:2px; justify-content:space-between;">
            <div class="kanban-meta-left" style="display:flex;align-items:center;gap:8px;">
              {% if task.dday_text %}
                <span class="d-day-badge">{{ task.dday_text }}</span>
              {% endif %}
              <span class="kanban-diff {% if task.priority == '상' %}diff-high{% elif task.priority == '중' %}diff-mid{% else %}diff-low{% endif %}">{{ task.priority }}</span>
            </div>
          </div>
          <div class="kanban-card-row">
            <span class="kanban-title">{{ task.title }}</span>
          </div>
          <div class="kanban-desc">{{ task.description|default:"설명이 없습니다." }}</div>
        </div>
        {% empty %}
        <div style="text-align: center; color: #9ca3af; padding: 20px; font-style: italic;">
          진행 중인 태스크가 없습니다.
        </div>
        {% endfor %}
      </div>
      
      <div class="kanban-column review-request-column" style="flex:1; min-width:280px;" ondrop="drop(event)" ondragover="allowDrop(event)">
        <div class="kanban-header">검토요청</div>
        {% for task in status_tasks.검토요청 %}
        <div class="kanban-card" data-date="{{ task.scheduled_end_date|date:'Y-m-d' }}" draggable="true" id="task{{ task.id }}">
          <div class="kanban-card-row" style="margin-bottom:2px; justify-content:space-between;">
            <div class="kanban-meta-left" style="display:flex;align-items:center;gap:8px;">
              {% if task.dday_text %}
                <span class="d-day-badge">{{ task.dday_text }}</span>
              {% endif %}
              <span class="kanban-diff {% if task.priority == '상' %}diff-high{% elif task.priority == '중' %}diff-mid{% else %}diff-low{% endif %}">{{ task.priority }}</span>
            </div>
          </div>
          <div class="kanban-card-row">
            <span class="kanban-title">{{ task.title }}</span>
          </div>
          <div class="kanban-desc">{{ task.description|default:"설명이 없습니다." }}</div>
        </div>
        {% empty %}
        <div style="text-align: center; color: #9ca3af; padding: 20px; font-style: italic;">
          검토 요청한 태스크가 없습니다.
        </div>
        {% endfor %}
      </div>
      
      <div class="kanban-column success-column" style="flex:1; min-width:280px;" ondrop="drop(event)" ondragover="allowDrop(event)">
        <div class="kanban-header">완료</div>
        {% for task in status_tasks.완료 %}
        <div class="kanban-card" data-date="{{ task.scheduled_end_date|date:'Y-m-d' }}" draggable="true" id="task{{ task.id }}">
          <div class="kanban-card-row" style="margin-bottom:2px; justify-content:space-between;">
            <div class="kanban-meta-left" style="display:flex;align-items:center;gap:8px;">
              <span class="kanban-diff {% if task.priority == '상' %}diff-high{% elif task.priority == '중' %}diff-mid{% else %}diff-low{% endif %}">{{ task.priority }}</span>
            </div>
          </div>
          <div class="kanban-card-row">
            <span class="kanban-title">{{ task.title }}</span>
          </div>
          <div class="kanban-desc">{{ task.description|default:"설명이 없습니다." }}</div>
        </div>
        {% empty %}
        <div style="text-align: center; color: #9ca3af; padding: 20px; font-style: italic;">
          완료한 태스크가 없습니다.
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/mentee/mentee.js' %}"></script>
<script>
function allowDrop(ev) {
  ev.preventDefault();
}
let dragged = null;
document.querySelectorAll('.kanban-card').forEach(card => {
  card.addEventListener('dragstart', function(e) {
    dragged = card;
    console.log('드래그 시작:', {
      cardId: card.id,
      cardElement: card
    });
    setTimeout(() => card.classList.add('dragging'), 0);
    
    // 드래그할 때 클릭 이벤트 방지
    e.stopPropagation();
  });
  card.addEventListener('dragend', function(e) {
    card.classList.remove('dragging');
    console.log('드래그 종료:', card.id);
    dragged = null;
    document.querySelectorAll('.kanban-column').forEach(col => col.classList.remove('drop-hover'));
  });
  // 카드 클릭 시 task_add 페이지로 이동 (드래그가 아닐 때만)
  card.addEventListener('click', function(e) {
    // 드래그 중이 아닐 때만 페이지 이동
    if (!dragged) {
      window.location.href = '/common/task_add/';
    }
  });
});
document.querySelectorAll('.kanban-column').forEach(col => {
  col.addEventListener('dragover', function(e) {
    e.preventDefault();
    col.classList.add('drop-hover');
  });
  col.addEventListener('dragleave', function(e) {
    col.classList.remove('drop-hover');
  });
  col.addEventListener('drop', function(e) {
    col.classList.remove('drop-hover');
  });
});
function drop(ev) {
  ev.preventDefault();
  if (dragged) {
    const col = ev.currentTarget;
    const taskId = dragged.id.replace('task', '');
    
    console.log('드롭 이벤트 시작:', {
      draggedElement: dragged,
      draggedId: dragged.id,
      taskId: taskId,
      targetColumn: col.className
    });
    
    // 컬럼별 상태 매핑
    let newStatus = '';
    if (col.classList.contains('todo-column')) {
      newStatus = '진행전';
    } else if (col.classList.contains('processing-column')) {
      newStatus = '진행중';
    } else if (col.classList.contains('review-request-column')) {
      newStatus = '검토요청';
    } else if (col.classList.contains('success-column')) {
      newStatus = '완료';
    }
    
    console.log('상태 매핑 완료:', { newStatus });
    
    // 이미 같은 컬럼에 있으면 이동하지 않음
    if (col.contains(dragged)) {
      console.log('이미 같은 컬럼에 있음. 이동하지 않음.');
      col.classList.remove('drop-hover');
      return;
    }
    
    // CSRF 토큰 확인
    const csrfToken = getCookie('csrftoken');
    console.log('CSRF 토큰 상태:', csrfToken ? '있음' : '없음');
    
    if (!csrfToken) {
      alert('CSRF 토큰을 찾을 수 없습니다. 페이지를 새로고침해주세요.');
      return;
    }
    
    // 서버에 상태 변경 요청
    console.log('태스크 상태 변경 요청:', { taskId, newStatus });
    
    const requestUrl = `/mentee/update_task_status/${taskId}/`;
    console.log('요청 URL:', requestUrl);
    
    // UI 먼저 업데이트 (낙관적 업데이트)
    const originalParent = dragged.parentNode;
    
    fetch(requestUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        status: newStatus
      })
    })
    .then(response => {
      console.log('서버 응답 상태:', response.status, response.statusText);
      console.log('응답 헤더:', response.headers);
      
      if (!response.ok) {
        return response.text().then(text => {
          console.error('서버 에러 응답:', text);
          throw new Error(`HTTP ${response.status}: ${response.statusText}\n응답: ${text}`);
        });
      }
      
      return response.json();
    })
    .then(data => {
      console.log('서버 응답 데이터:', data);
      
      if (data.success) {
        // 성공 시 UI 업데이트 - 더 안전한 방식으로 처리
        try {
          // 카드를 새로운 컬럼으로 이동
          if (dragged.parentNode !== col) {
            col.appendChild(dragged);
          }
          updateSuccessLine();
          updateTaskProgress();
          console.log('태스크 상태가 업데이트되었습니다:', data);
          
          // 성공 메시지 표시 (선택사항)
          if (data.message) {
            console.log('업데이트 메시지:', data.message);
          }
        } catch (domError) {
          console.error('DOM 업데이트 오류:', domError);
          // DOM 오류가 발생하면 페이지 새로고침
          console.log('DOM 오류로 인한 페이지 새로고침');
          window.location.reload();
        }
      } else {
        console.error('태스크 상태 업데이트 실패:', data.error);
        alert('태스크 상태 업데이트에 실패했습니다: ' + data.error);
        // 실패시 원래 위치로 되돌리기
        if (originalParent && originalParent !== col) {
          originalParent.appendChild(dragged);
        }
      }
    })
    .catch(error => {
      console.error('상세 오류 정보:', error);
      console.error('오류 스택:', error.stack);
      
      // 에러 발생시 원래 위치로 되돌리기
      if (originalParent && originalParent !== col) {
        try {
          originalParent.appendChild(dragged);
        } catch (rollbackError) {
          console.error('롤백 실패:', rollbackError);
          // 롤백도 실패하면 페이지 새로고침
          window.location.reload();
        }
      }
      
      if (error.message.includes('HTTP')) {
        alert(`서버 오류가 발생했습니다: ${error.message}`);
      } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
        alert('네트워크 연결을 확인해주세요. 서버에 접근할 수 없습니다.');
      } else {
        alert(`오류가 발생했습니다: ${error.message}`);
      }
    });
    
    col.classList.remove('drop-hover');
  }
}

// CSRF 토큰 가져오기 함수 (개선된 버전)
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  
  // CSRF 토큰이 없으면 meta 태그에서 가져오기 시도
  if (!cookieValue) {
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
      cookieValue = csrfMeta.getAttribute('content');
    }
  }
  
  // 여전히 없으면 hidden input에서 가져오기 시도
  if (!cookieValue) {
    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (csrfInput) {
      cookieValue = csrfInput.value;
    }
  }
  
  console.log('CSRF 토큰:', cookieValue ? '찾음' : '없음');
  return cookieValue;
}
// Success 컬럼에 있는 카드에 취소선 적용
function updateSuccessLine() {
  document.querySelectorAll('.success-column .kanban-card').forEach(card => {
    card.classList.add('success-task');
  });
  document.querySelectorAll('.kanban-column:not(.success-column) .kanban-card').forEach(card => {
    card.classList.remove('success-task');
  });
}

// 완료 컬럼 태스크 개수 기반 진행률 계산 및 welcome-section 동기화
function updateTaskProgress() {
  const completedCount = document.querySelectorAll('.success-column .kanban-card').length;
  const totalTasks = {{ total_tasks|default:0 }};
  const completionPercentage = totalTasks > 0 ? (completedCount / totalTasks * 100) : 0;
  
  // 상단 완료율/진행률/Bar 동기화
  const userLevelTop = document.getElementById('userLevelTop');
  const userExpTop = document.getElementById('userExpTop');
  const userExpMaxTop = document.getElementById('userExpMaxTop');
  const expBarTop = document.getElementById('expBarTop');
  
  if (userLevelTop) userLevelTop.textContent = `${Math.round(completionPercentage)}%`;
  if (userExpTop) userExpTop.textContent = completedCount;
  if (userExpMaxTop) userExpMaxTop.textContent = totalTasks;
  if (expBarTop) expBarTop.style.width = Math.min(100, completionPercentage) + '%';
}
// 드래그/드롭, DOM 변경 시 진행률/취소선 동기화
let observer = null;
window.addEventListener('DOMContentLoaded', () => {
  updateSuccessLine();
  updateTaskProgress();
  const successCol = document.querySelector('.success-column');
  if (successCol && !observer) {
    try {
      observer = new MutationObserver(() => {
        updateSuccessLine();
        updateTaskProgress();
      });
      observer.observe(successCol, { childList: true, subtree: true });
    } catch (e) {
      // observer 오류 무시
    }
  }
  document.querySelectorAll('.kanban-card').forEach(card => {
    card.addEventListener('dragend', () => {
      updateSuccessLine();
      updateTaskProgress();
    });
  });
});
</script>
{% endblock %}