{% extends 'base.html' %}
{% load static %}

{% block title %}íƒœìŠ¤í¬ ëª©ë¡ í˜ì´ì§€{% endblock %}
{% block extra_head %}
<style>
.tasklist-container {
  display: flex;
  gap: 32px;
  width: 100%;
  min-height: 600px;
}
.tasklist-left {
  flex: 1;
  padding: 24px 0 24px 24px;
  background: #fafbfc;
  border-radius: 12px 0 0 12px;
  min-width: 340px;
  max-width: 500px;
  overflow-y: auto;
  max-height: 85vh;
}
.tasklist-title {
  font-size: 1.3em;
  font-weight: bold;
  margin-bottom: 18px;
  color: #222;
}
.tasklist-search-row {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
}
.tasklist-search {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 15px;
}
.tasklist-create-btn {
  padding: 8px 18px;
  background: #ffd600;
  color: #222;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
.tasklist-filter-btn {
  padding: 8px 18px;
  background: #e0e0e0;
  color: #222;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
.tasklist-filter-panel {
  background: #f7f7f7;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 14px 18px 10px 18px;
  margin-top: 4px;
  font-size: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
}
.filter-group {
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.filter-label {
  font-weight: bold;
  margin-right: 8px;
}
.filter-group label {
  margin-right: 8px;
  font-weight: normal;
}
.filter-dday-sort {
  background: #fff;
  border: 1px solid #bbb;
  border-radius: 4px;
  padding: 2px 8px;
  margin-left: 2px;
  cursor: pointer;
  font-size: 15px;
}
.filter-dday-sort.active {
  background: #ffd600;
  color: #222;
  border-color: #ffd600;
}
.task-card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  margin-bottom: 18px;
  padding: 18px 20px 14px 20px;
  border-left: 6px solid #ffd600;
  transition: box-shadow 0.2s, border-color 0.2s;
  cursor: pointer;
  position: relative;
}
.task-card.in-progress { border-left-color: #4caf50; }
.task-card.done { border-left-color: #ffd600; background: #f6fff6; }
.task-card.selected { box-shadow: 0 0 0 3px #1976d233; border-left-color: #1976d2; }
.task-card.not-started { border-left-color: #f44336; }
.task-card.review-requested { border-left-color: #ffd600; }
.task-title {
  color: #222;
}
.task-title.done {
  text-decoration: line-through;
  color: #aaa;
}
.task-title.d-day {
  margin-right: 8px;
  text-align: left;
  display: inline-block;
}
.task-card-header {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  font-size: 17px;
  font-weight: bold;
  margin-bottom: 6px;
  gap: 10px;
}
.task-xp { color: #888; font-size: 15px; display: flex; align-items: center; gap: 4px; }
.icon-trophy { width: 18px; height: 18px; vertical-align: middle; }
.task-desc { color: #555; font-size: 14px; margin-bottom: 8px; }
.task-desc-row { margin-bottom: 8px; }
.task-meta-row {
  display: flex;
  gap: 10px;
  align-items: center;
  font-size: 13px;
  margin-bottom: 4px;
}
.task-week { color: #666; }
.task-badge {
  padding: 2px 10px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: bold;
  color: #fff;
  display: inline-block;
}
.task-badge.red { background: #f44336; color: #fff; }
.task-badge.green { background: #4caf50; color: #fff; }
.task-badge.yellow { background: #ffd600 !important; color: #222 !important; }

.status-badge {
  display: inline-block;
  min-width: 60px;
  padding: 2px 12px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: bold;
  color: #fff;
  margin-right: 10px;
  vertical-align: middle;
}
.status-badge.not-started { background: #888; }
.status-badge.in-progress { background: #1976d2; }
.status-badge.review-requested { background: #f44336; }
.status-badge.done { background: #43a047; }

.subtask-toggle {
  display: flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  margin: 0 0 0 6px;
  font-size: 18px;
  color: #222;
  user-select: none;
}
.subtask-list {
  margin: 0 0 0 32px;
  padding: 0;
  border: 1px solid #bbb;
  border-radius: 8px;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  margin-bottom: 10px;
  display: none;
}
.subtask-list.open { display: block; }
.subtask-card {
  padding: 12px 16px 10px 16px;
  border-bottom: 1px solid #eee;
  font-size: 15px;
  cursor: pointer;
}
.subtask-card:last-child { border-bottom: none; }
.subtask-title { font-weight: bold; font-size: 15px; margin-bottom: 2px; display: block; }
.subtask-desc { color: #555; font-size: 13px; margin-bottom: 4px; }
.subtask-meta-row {
  display: flex;
  gap: 8px;
  align-items: center;
  font-size: 12px;
}
.subtask-week { color: #666; }
.subtask-badge {
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: bold;
  color: #fff;
  display: inline-block;
}
.subtask-badge.green { background: #4caf50; }
.subtask-badge.yellow { background: #ffd600 !important; color: #222 !important; }

.tasklist-right {
  flex: 2;
  background: #fff;
  border-radius: 0 16px 16px 0;
  padding: 36px 48px 32px 48px;
  min-width: 600px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  display: flex;
  flex-direction: column;
  position: relative;
  z-index: 10;
}
.task-detail-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  font-size: 26px;
  font-weight: bold;
  margin-bottom: 8px;
}
.task-detail-title { color: #222; font-size: 26px; font-weight: bold; }
.task-detail-xp { color: #888; font-size: 18px; display: flex; align-items: center; gap: 4px; font-weight: bold; }
.task-detail-desc { color: #222; font-size: 17px; margin-bottom: 12px; margin-top: 8px; }
.task-detail-meta-row {
  display: flex;
  gap: 14px;
  align-items: center;
  font-size: 15px;
  margin-bottom: 12px;
}
.task-detail-divider {
  border: none;
  border-top: 1.5px solid #e0e0e0;
  margin: 18px 0 24px 0;
}
.task-detail-list {
  margin: 0 0 24px 0;
  padding-left: 0;
  color: #222;
  font-size: 17px;
  list-style: none;
}
.task-detail-list ul {
  margin: 0 0 24px 0;
  padding-left: 0;
  color: #222;
  font-size: 17px;
  list-style: none;
}
.task-detail-list ul li {
  margin-bottom: 6px;
  font-weight: 500;
}
.task-detail-chat {
  margin-top: auto;
  background: #fafafa;
  border-radius: 12px;
  padding: 24px 24px 18px 24px;
  margin-top: 32px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.03);
}
.chat-message {
  margin-bottom: 14px;
  font-size: 15px;
  display: flex;
  flex-direction: column;
}
.chat-message .chat-user {
  font-weight: bold;
  color: #43a047;
  margin-bottom: 2px;
}
.chat-message.mine .chat-user { color: #1976d2; }
.chat-message .chat-text { color: #222; margin-bottom: 2px; }
.chat-message .chat-time { color: #aaa; font-size: 12px; }
.chat-input-row {
  display: flex;
  gap: 8px;
  margin-top: 18px;
}
.chat-input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 16px;
  background: #fff;
}
.chat-send-btn {
  padding: 0 24px;
  background: #ffd600;
  color: #222;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
</style>
{% endblock %}
{% block content %}
<div class="tasklist-container">
  <!-- ì¢Œì¸¡: Task ëª©ë¡ -->
<div class="tasklist-left" id="tasklist-left">
  <div class="tasklist-title">Task ëª©ë¡</div>
  {% for week, tasks in week_tasks.items %}
    <div style="font-weight:bold; margin:18px 0 8px 0; color:#1976d2;">{{ week }}ì£¼ì°¨</div>
    {% for task in tasks %}
      <div class="task-card {% if forloop.first and forloop.parentloop.first %}selected{% endif %} {% if task.status == 'ì§„í–‰ ì „' %}not-started{% elif task.status == 'ì§„í–‰ ì¤‘' %}in-progress{% elif task.status == 'ê²€í†  ìš”ì²­' %}review-requested{% elif task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}"
        data-task-id="{{ task.id }}"
        data-title="{{ task.title|escapejs }}"
        data-desc="{{ task.desc|default_if_none:''|escapejs }}"
        data-priority="{{ task.priority|default:'í•˜'|escapejs }}"
        data-status="{{ task.status|escapejs }}"
        data-end_date="{{ task.end_date|date:'Y-m-d' }}"
        data-week="{{ week }}"
        >
        <div class="task-card-header">
          <span class="status-badge {% if task.status == 'ì§„í–‰ ì „' %}not-started{% elif task.status == 'ì§„í–‰ ì¤‘' %}in-progress{% elif task.status == 'ê²€í†  ìš”ì²­' %}review-requested{% elif task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}">{{ task.status }}</span>
          <span class="task-title {% if task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}">{{ task.title }}</span>
        </div>
        <div class="task-desc-row">
          <div class="task-desc">{{ task.desc }}</div>
          <div class="task-meta-row">
            <span class="task-badge {{ task.priority|default:'í•˜'|lower }}">{{ task.priority|default:'í•˜' }}</span>
            <span class="d-day-badge">{{ task.end_date|date:'Y-m-d' }}</span>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endfor %}
</div>
  <!-- ìš°ì¸¡: ìƒì„¸ ì •ë³´ -->
  <div class="tasklist-right">
    <div class="task-detail-header" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="display:flex; align-items:center; gap:12px;">
        <span class="task-detail-title" id="detail-title">ì²« ë²ˆì§¸ í”„ë¡œì íŠ¸ ì°¸ì—¬í•˜ê¸°</span>
        <span class="task-detail-xp" id="detail-xp" style="color:#888; font-size:17px; display:flex; align-items:center; gap:4px; font-weight:bold;"><span class="icon-trophy" style="font-size:15px;">ğŸ†</span> 100 XP</span>
      </div>
      <div style="display:flex; gap:10px; margin-left:auto;">
        <button class="task-detail-edit-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;" onclick="location.href='/common/task_add/'">í¸ì§‘</button>
        <button class="task-detail-subtask-btn" style="background:#e0e0e0; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;" onclick="location.href='/common/task_add/'">í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„±</button>
      </div>
    </div>
    <div class="task-detail-desc" id="detail-desc">ê°„ë‹¨í•œ í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•˜ì—¬ ì›Œí¬í”Œë¡œìš° ì´í•´í•˜ê¸°</div>
    <div class="task-detail-meta-row">
      <span class="task-badge yellow" id="detail-badge">ì¤‘ê¸‰</span>
    </div>    
    <div class="task-detail-divider">
    </div>
    <div class="task-detail-list" id="detail-list">
      <ul>
        <li>í”„ë¡œì íŠ¸ ì¤€ë¹„</li>
        <li>ì²« í”„ë¡œì íŠ¸ ì§„í–‰</li>
        <li>í”„ë¡œì íŠ¸ ê²°ê³¼ ê³µìœ </li>
      </ul>
    </div>
    <div class="task-detail-chat">
      <div class="chat-message other">
        <span class="chat-user">ì±„íŒ…ë´‡</span>
        <span class="chat-text">ê²Œì‹œê¸€ì€ 4ì£¼ì°¨ê¹Œì§€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì† í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</span>
        <span class="chat-time">2025.06.25. 01:41</span>
      </div>
      <div class="chat-message mine">
        <span class="chat-user">ë©˜í† ìœ í˜•</span>
        <span class="chat-text">ì™„ë£Œí•˜ì˜€ìœ¼ë©°, ë‹¤ìŒê³¼ì œë„ ê¸°ëŒ€í•˜ê² ìŠµë‹ˆë‹¤.</span>
        <span class="chat-time">2025.06.25. 01:45</span>
      </div>
      <div class="chat-input-row">
        <input type="text" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
        <button class="chat-send-btn"><span style="font-size:20px;">ğŸ’¬</span></button>
      </div>
    </div>
  </div>
</div>
<script>
// ì¢Œì¸¡ Task ì¹´ë“œ í´ë¦­ ì‹œ ìš°ì¸¡ ìƒì„¸ ì •ë³´ ê°±ì‹ 
document.addEventListener('DOMContentLoaded', function() {
  const cards = document.querySelectorAll('.task-card');
  function updateDetailFromData(task) {
    // ìƒíƒœ ë±ƒì§€ ìƒ‰ìƒ
    let statusClass = '';
    if (task.status === 'ì§„í–‰ ì „') statusClass = 'not-started';
    else if (task.status === 'ì§„í–‰ ì¤‘') statusClass = 'in-progress';
    else if (task.status === 'ê²€í†  ìš”ì²­') statusClass = 'review-requested';
    else if (task.status === 'ì™„ë£Œ' || task.status === 'ì™„ë£Œë¨') statusClass = 'done';
    // ìš°ì¸¡ ì˜ì—­ ê°±ì‹ 
    const titleEl = document.getElementById('detail-title');
    titleEl.innerHTML = `<span class="status-badge ${statusClass}">${task.status}</span> <span class="${statusClass === 'done' ? 'done' : ''}">${task.title}</span>`;
    const xpEl = document.getElementById('detail-xp');
    if (xpEl) xpEl.innerHTML = '';
    // guidelineì´ null/ë¹ˆê°’ì´ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
    const descEl = document.getElementById('detail-desc');
    if (task.guideline && String(task.guideline).trim() !== '') {
      descEl.textContent = task.guideline;
      descEl.style.display = '';
    } else {
      descEl.textContent = '';
      descEl.style.display = 'none';
    }
    // ë‚œì´ë„/ë””ë°ì´ ë©”íƒ€
    const metaRow = document.querySelector('.task-detail-meta-row');
    let badgeClass = 'yellow';
    if (task.priority === 'ìƒ') badgeClass = 'red';
    else if (task.priority === 'ì¤‘') badgeClass = 'green';
    metaRow.innerHTML = `<span class="task-badge ${badgeClass}" id="detail-badge">${task.priority || 'í•˜'}</span> <span class="d-day-badge">${task.end_date || ''}</span>`;
    // descriptionì„ ë¦¬ìŠ¤íŠ¸ë¡œ í‘œì‹œ
    const listDiv = document.getElementById('detail-list');
    listDiv.innerHTML = '';
    if (task.description) {
      const items = String(task.description).split('\n').filter(x => x.trim() !== '');
      const ul = document.createElement('ul');
      items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        ul.appendChild(li);
      });
      listDiv.appendChild(ul);
    } else if (task.desc) {
      const ul = document.createElement('ul');
      const li = document.createElement('li');
      li.textContent = task.desc;
      ul.appendChild(li);
      listDiv.appendChild(ul);
    }
  }
  async function fetchAndUpdateDetail(taskId) {
    try {
      const resp = await fetch(`/mentee/task_detail/${taskId}/`);
      if (!resp.ok) throw new Error('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      const data = await resp.json();
      if (data.success && data.task) {
        updateDetailFromData(data.task);
      }
    } catch (e) {
      alert('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
  }
  cards.forEach(card => {
    card.addEventListener('click', function() {
      cards.forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      const taskId = card.getAttribute('data-task-id');
      if (taskId) fetchAndUpdateDetail(taskId);
    });
  });
  // ìµœì´ˆ ë¡œë”© ì‹œ ì²« ë²ˆì§¸ Task ì„ íƒ
  if (cards.length > 0) {
    const firstTaskId = cards[0].getAttribute('data-task-id');
    if (firstTaskId) fetchAndUpdateDetail(firstTaskId);
  }
});
</script>
{% endblock %}
