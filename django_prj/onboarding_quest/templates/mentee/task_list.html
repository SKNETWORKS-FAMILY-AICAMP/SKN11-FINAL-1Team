{% extends 'base.html' %}
{% load static %}

{% block title %}태스크 목록 페이지{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/common/mentee_task_list.css' %}">
{% endblock %}
{% block content %}
<div class="tasklist-container">
  <!-- 좌측: Task 목록 -->
<div class="tasklist-left" id="tasklist-left">
  <div class="tasklist-title">Task 목록</div>
  
  <!-- 정렬/필터 컨트롤 -->
  <div class="task-controls" style="margin: 12px 0; padding: 8px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0;">
    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
      <label style="font-size: 13px; font-weight: 500; color: #333;">정렬:</label>
      <select id="task-sort" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
        <option value="week">주차별</option>
        <option value="deadline">마감일별</option>
      </select>
      
      <label style="font-size: 13px; font-weight: 500; color: #333; margin-left: 8px;">필터:</label>
      <select id="task-filter-status" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
        <option value="all">전체 상태</option>
        <option value="진행전">진행 전</option>
        <option value="진행중">진행 중</option>
        <option value="검토요청">검토 요청</option>
        <option value="완료">완료</option>
      </select>
      
      <select id="task-filter-priority" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
        <option value="all">전체 우선순위</option>
        <option value="상">상</option>
        <option value="중">중</option>
        <option value="하">하</option>
      </select>
    </div>
  </div>
  {% for week, tasks in week_tasks.items %}
    <div style="font-weight:bold; margin:18px 0 8px 0; color:#1976d2;">{{ week }}주차</div>
    {% for task in tasks %}
      {% if not task.parent %}
      <div class="task-card {% if forloop.first and forloop.parentloop.first %}selected{% endif %} {% if task.status == '진행전' %}not-started{% elif task.status == '진행중' %}in-progress{% elif task.status == '검토요청' %}review-requested{% elif task.status == '완료' or task.status == '완료됨' %}done{% endif %}"
        data-task-id="{{ task.id }}"
        data-title="{{ task.title|escapejs }}"
        data-desc="{{ task.description|default_if_none:''|escapejs }}"
        data-priority="{{ task.priority|default:'하'|escapejs }}"
        data-status="{{ task.status|escapejs }}"
        data-scheduled_end_date="{{ task.scheduled_end_date|date:'Y-m-d' }}"
        data-week="{{ week }}"
        data-dday="{{ task.dday|default_if_none:'' }}"
        >
        <div class="task-card-header">
          <span class="status-badge {% if task.status == '진행전' %}not-started{% elif task.status == '진행중' %}in-progress{% elif task.status == '검토요청' %}review-requested{% elif task.status == '완료' or task.status == '완료됨' %}done{% endif %}">{{ task.status }}</span>
          <span class="task-title {% if task.status == '완료' or task.status == '완료됨' %}done{% endif %}">{{ task.title }}</span>
          {% if task.dday is not None %}
            <span class="task-dday {% if task.dday <= 1 %}urgent{% elif task.dday <= 3 %}warning{% endif %}">
              {% if task.dday >= 0 %}D-{{ task.dday }}{% else %}D+{% widthratio task.dday -1 1 %}{% endif %}
            </span>
          {% endif %}
        </div>
        <div class="task-desc-row">
          <div class="task-desc">{{ task.description }}</div>
          <div class="task-meta-row">
            <span class="task-badge {% if task.priority == '상' %}red{% elif task.priority == '중' %}green{% else %}yellow{% endif %}">{{ task.priority|default:'하' }}</span>
          </div>
        </div>
        {# 직접적인 하위 테스크만 필터링 #}
        {% with direct_subtasks=task.subtasks|dictsort:'task_assign_id' %}
          {% if direct_subtasks and direct_subtasks|length > 0 %}
            <button type="button" class="subtask-toggle" style="margin:6px 0 0 0; font-size:13px; background:none; border:none; color:#1976d2; cursor:pointer;">▼ 하위 {{ direct_subtasks|length }}개</button>
            <div class="subtask-list" style="display:none; margin:6px 0 0 10px;">
              {% for sub in direct_subtasks %}
                <div class="subtask-item" data-task-id="{{ sub.task_assign_id }}" style="padding:4px 0 4px 12px; border-left:2px solid #e0e0e0; margin-bottom:2px; font-size:14px; color:#444; cursor:pointer; display: flex; align-items: center; gap: 6px;">
                  <span class="status-badge {% if sub.status == '진행전' %}not-started{% elif sub.status == '진행중' %}in-progress{% elif sub.status == '검토요청' %}review-requested{% elif sub.status == '완료' or sub.status == '완료됨' %}done{% endif %}" style="font-size: 11px; padding: 1px 8px;">{{ sub.status }}</span>
                  <span class="subtask-title" style="flex: 1;">{{ sub.title }}</span>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
      </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
</div>
  <!-- 우측: 상세 정보 -->
  <div class="tasklist-right">
    <div class="task-detail-header" id="detail-header-row" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <!-- 하위 테스크 생성 모달 -->
      <div id="subtask-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:16px; min-width:420px; max-width:600px; padding:40px 36px 32px 36px; box-shadow:0 6px 32px rgba(0,0,0,0.20); position:relative;">
          <button id="subtask-close-btn" style="position:absolute; right:12px; top:10px; background:none; border:none; font-size:18px; color:#888; cursor:pointer; padding:0 4px; width:28px; height:28px; line-height:24px;">&times;</button>
          <form id="subtask-form">
            <div style="font-weight:bold; margin-bottom:18px;">하위 테스크 생성</div>
            <div style="display:flex; gap:12px; margin-bottom:14px; align-items:flex-end;">
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">상태</label>
                <select id="subtask-status" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;">
                  <option value="진행전">진행 전</option>
                  <option value="진행중">진행 중</option>
                  <option value="검토요청">검토 요청</option>
                  <option value="완료">완료</option>
                </select>
              </div>
              <div style="flex:2;">
                <label style="font-size:17px; color:#222;">상위 Task</label>
                <input id="subtask-parent-title" type="text" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px; background:#f7f7f7;" readonly />
                <input id="subtask-parent-id" type="hidden" />
              </div>
            </div>
            <div style="margin-bottom:14px;">
              <label style="font-size:17px; color:#222;">제목</label>
              <input id="subtask-title" type="text" style="width:100%; margin-bottom:0; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" required />
            </div>
            <div style="margin-bottom:14px;">
              <label style="font-size:17px; color:#222;">가이드라인</label>
              <input id="subtask-guideline" type="text" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
            </div>
            <div style="margin-bottom:14px;">
              <label style="font-size:17px; color:#222;">세부내용</label>
              <textarea id="subtask-desc" style="width:100%; min-height:120px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:14px; align-items:flex-end;">
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">우선순위</label>
                <select id="subtask-priority" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;">
                  <option value="">(상위와 동일)</option>
                  <option value="상">상</option>
                  <option value="중">중</option>
                  <option value="하">하</option>
                </select>
              </div>
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">시작일</label>
                <input id="subtask-start-date" type="date" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;" />
              </div>
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">마감일</label>
                <input id="subtask-end-date" type="date" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;" />
              </div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:18px;">
              <button type="submit" class="template-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:8px; padding:6px 18px; font-size:17px; cursor:pointer;">생성</button>
              <button type="button" id="subtask-cancel-btn" class="template-btn" style="background:#eee; color:#222; font-weight:bold; border:none; border-radius:8px; padding:6px 18px; font-size:17px; cursor:pointer;">취소</button>
            </div>
          </form>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span class="task-detail-title" id="detail-title">첫 번째 프로젝트 참여하기</span>
        <span class="task-detail-xp" id="detail-xp" style="color:#888; font-size:17px; display:flex; align-items:center; gap:4px; font-weight:bold;"><span class="icon-trophy" style="font-size:15px;">🏆</span> 100 XP</span>
      </div>
      <div id="detail-header-btns" style="display:flex; gap:10px; margin-left:auto;">
        <button class="task-detail-edit-btn" id="task-edit-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;">편집</button>
        <button class="task-detail-subtask-btn" id="task-detail-subtask-btn" style="background:#e0e0e0; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;">하위 테스크 생성</button>
      </div>
    </div>
    <div class="task-detail-desc" id="detail-desc">간단한 프로젝트에 참여하여 워크플로우 이해하기</div>
    <form id="task-edit-form" style="display:none; margin-bottom:12px;">
      <div style="display:flex; gap:10px; align-items:flex-end; margin-bottom:8px;">
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">상태</label>
          <select id="edit-status" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;">
            <option value="진행전">진행 전</option>
            <option value="진행중">진행 중</option>
            <option value="검토요청">검토 요청</option>
            <option value="완료">완료</option>
          </select>
        </div>
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">우선순위</label>
          <select id="edit-priority" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;">
            <option value="상">상</option>
            <option value="중">중</option>
            <option value="하">하</option>
          </select>
        </div>
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">마감날짜</label>
          <input id="edit-end-date" type="date" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
        </div>
      </div>
      <label style="font-weight:bold; color:#222;">제목</label>
      <input id="edit-title" type="text" style="width:100%; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
      <label style="font-weight:bold; color:#222;">가이드라인</label>
      <textarea id="edit-guideline" style="width:100%; min-height:60px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
      <label style="font-weight:bold; color:#222;">세부내용(여러 줄)</label>
      <textarea id="edit-description" style="width:100%; min-height:80px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
      <div style="display:flex; gap:8px;">
        <button type="submit" id="edit-save-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:6px; padding:6px 18px; font-size:15px; cursor:pointer;">저장</button>
        <button type="button" id="edit-cancel-btn" style="background:#eee; color:#222; font-weight:bold; border:none; border-radius:6px; padding:6px 18px; font-size:15px; cursor:pointer;">취소</button>
      </div>
    </form>
    <div class="task-detail-meta-row" id="detail-meta-row">
      <span class="task-badge yellow" id="detail-badge">중급</span>
      <span class="d-day-badge" id="detail-dday"></span>
    </div>
    <div class="task-detail-divider"></div>
    <div class="task-detail-list" id="detail-list">
      <ul>
        <li>프로젝트 준비</li>
        <li>첫 프로젝트 진행</li>
        <li>프로젝트 결과 공유</li>
      </ul>
    </div>
    <div class="task-detail-chat">
      <div id="chat-messages"></div>
      <div class="chat-input-row">
        <input type="text" class="chat-input" id="chat-input" placeholder="메시지 입력...">
        <button class="chat-send-btn" id="chat-send-btn"><span style="font-size:20px;">💬</span></button>
      </div>
    </div>
  </div>
</div>
<script>
// Django 템플릿 변수를 JavaScript로 전달
window.mentorshipId = {% if mentorship_id %}'{{ mentorship_id }}'{% else %}null{% endif %};
</script>
<script src="{% static 'js/common/mentee_task_list.js' %}"></script>
{% endblock %}
