{% extends 'base.html' %}
{% load static %}

{% block title %}íƒœìŠ¤í¬ ëª©ë¡ í˜ì´ì§€{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/common/mentee_task_list.css' %}">
{% endblock %}
{% block content %}

<script>
    // ì‚¬ìš©ì ì—­í• (ë©˜í† /ë©˜í‹°)ì„ JS ë³€ìˆ˜ë¡œ ì „ë‹¬
    window.userRole = "{{ user.role }}";  // "mentor" ë˜ëŠ” "mentee"
</script>


<div class="tasklist-container">
  <!-- ì¢Œì¸¡: Task ëª©ë¡ -->
<div class="tasklist-left" id="tasklist-left">
  
  <!-- ì •ë ¬/í•„í„° ì»¨íŠ¸ë¡¤ -->
  <div class="task-controls" style="margin: 12px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: nowrap; justify-content: space-between;">
      <select id="task-sort" style="padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; flex: 1; height: 40px;">
        <option value="week">ì£¼ì°¨ë³„</option>
        <option value="deadline">ë§ˆê°ì¼ë³„</option>
      </select>

      <select id="task-filter-status" style="padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; flex: 1; height: 40px;">
        <option value="all">ì „ì²´ ìƒíƒœ</option>
        <option value="ì§„í–‰ì „">ì§„í–‰ ì „</option>
        <option value="ì§„í–‰ì¤‘">ì§„í–‰ ì¤‘</option>
        <option value="ê²€í† ìš”ì²­">ê²€í†  ìš”ì²­</option>
        <option value="ì™„ë£Œ">ì™„ë£Œ</option>
      </select>
      
      <select id="task-filter-priority" style="padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; flex: 1; height: 40px;">
        <option value="all">ì „ì²´ ìš°ì„ ìˆœìœ„</option>
        <option value="ìƒ">ìƒ</option>
        <option value="ì¤‘">ì¤‘</option>
        <option value="í•˜">í•˜</option>
      </select>
    </div>
  </div>
  {% for week, tasks in week_tasks.items %}
    <div style="font-weight:bold; margin:18px 0 8px 0; color:#000000; font-size:18px;">{{ week }}ì£¼ì°¨</div>
    {% for task in tasks %}
      {% if not task.parent %}
      <div class="task-card {% if forloop.first and forloop.parentloop.first %}selected{% endif %} {% if task.status == 'ì§„í–‰ì „' %}not-started{% elif task.status == 'ì§„í–‰ì¤‘' %}in-progress{% elif task.status == 'ê²€í† ìš”ì²­' %}review-requested{% elif task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}"
        data-task-id="{{ task.task_id }}"
        data-title="{{ task.title|escapejs }}"
        data-desc="{{ task.description|default_if_none:''|escapejs }}"
        data-priority="{{ task.priority|default:'í•˜'|escapejs }}"
        data-status="{{ task.status|escapejs }}"
        data-scheduled_end_date="{{ task.scheduled_end_date|date:'Y-m-d' }}"
        data-week="{{ week }}"
        data-dday="{{ task.dday|default_if_none:'' }}"
        >
        <div class="task-card-header">
          <span class="status-badge {% if task.status == 'ì§„í–‰ì „' %}not-started{% elif task.status == 'ì§„í–‰ì¤‘' %}in-progress{% elif task.status == 'ê²€í† ìš”ì²­' %}review-requested{% elif task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}">{{ task.status }}</span>
          <span class="task-title {% if task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}">{{ task.title }}</span>
          {% if task.dday is not None %}
            <span class="task-dday {% if task.dday <= 1 %}urgent{% elif task.dday <= 3 %}warning{% endif %}">
              {% if task.dday >= 0 %}D-{{ task.dday }}{% else %}D+{% widthratio task.dday -1 1 %}{% endif %}
            </span>
          {% endif %}
        </div>
        <div class="task-desc-row">
          <div class="task-desc">{{ task.description }}</div>
        </div>
        
        <!-- ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ í† ê¸€ ë° ë¦¬ìŠ¤íŠ¸ -->
        {# ì§ì ‘ì ì¸ í•˜ìœ„ í…ŒìŠ¤í¬ë§Œ í•„í„°ë§ #}
        {% with direct_subtasks=task.subtasks|dictsort:'task_assign_id' %}
          {% if direct_subtasks and direct_subtasks|length > 0 %}
            <div class="task-subtask-section" style="margin-top:8px;">
              <button type="button" class="subtask-toggle" style="font-size:13px; background:none; border:none; color:#1976d2; cursor:pointer; padding:4px 8px; margin-bottom:4px;">
                â–¼ í•˜ìœ„ {{ direct_subtasks|length }}ê°œ
              </button>
              
              <div class="subtask-list" style="display:none; margin:0;">
                {% for sub in direct_subtasks %}
                  <div class="subtask-item" data-task-id="{{ sub.task_assign_id }}" style="padding:6px 0 6px 16px; border-left:3px solid #e0e0e0; margin-bottom:4px; font-size:14px; color:#444; cursor:pointer; display: flex; align-items: center; gap: 8px; background:#f8f9fa; border-radius:4px;">
                    <span class="status-badge {% if sub.status == 'ì§„í–‰ì „' %}not-started{% elif sub.status == 'ì§„í–‰ì¤‘' %}in-progress{% elif sub.status == 'ê²€í† ìš”ì²­' %}review-requested{% elif sub.status == 'ì™„ë£Œ' or sub.status == 'ì™„ë£Œë¨' %}done{% endif %}" style="font-size: 11px; padding: 2px 8px;">{{ sub.status }}</span>
                    <span class="subtask-title" style="flex: 1;">{{ sub.title }}</span>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endwith %}
      </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
</div>
  <!-- ìš°ì¸¡: ìƒì„¸ ì •ë³´ -->
  <div class="tasklist-right">
    <div class="task-detail-header" id="detail-header-row" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">

      <div style="display:flex; align-items:center; gap:12px;">
        <span class="task-detail-title" id="detail-title">ì²« ë²ˆì§¸ í”„ë¡œì íŠ¸ ì°¸ì—¬í•˜ê¸°</span>
      </div>
      <div id="detail-header-btns" style="display:flex; gap:10px; margin-left:auto;">
        <button class="task-detail-edit-btn" id="task-edit-btn" style="background:#1976d2; color:#ffffff; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;">í¸ì§‘</button>        
        <button class="task-detail-subtask-btn" id="task-detail-subtask-btn" style="background:#e0e0e0; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;">í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„±</button>
      </div>
    </div>
    <div id="guideline-content" style="background:none; min-height:60px; line-height:1.6; white-space:pre-wrap;">
          <!-- description ë‚´ìš©ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    <form id="task-edit-form" style="display:none; margin-bottom:12px;">
      <div style="display:flex; gap:10px; align-items:flex-end; margin-bottom:8px;">
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">ìƒíƒœ</label>
          <select id="edit-status" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;">
            <option value="ì§„í–‰ì „">ì§„í–‰ ì „</option>
            <option value="ì§„í–‰ì¤‘">ì§„í–‰ ì¤‘</option>
            <option value="ê²€í† ìš”ì²­">ê²€í†  ìš”ì²­</option>
            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
          </select>
        </div>
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">ìš°ì„ ìˆœìœ„</label>
          <select id="edit-priority" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;">
            <option value="ìƒ">ìƒ</option>
            <option value="ì¤‘">ì¤‘</option>
            <option value="í•˜">í•˜</option>
          </select>
        </div>
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">ë§ˆê°ë‚ ì§œ</label>
          <input id="edit-end-date" type="date" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
        </div>
      </div>
      <label style="font-weight:bold; color:#222;">ì œëª©</label>
      <input id="edit-title" type="text" style="width:100%; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
      <label style="font-weight:bold; color:#222;">ê°€ì´ë“œë¼ì¸</label>
      <textarea id="edit-guideline" style="width:100%; min-height:60px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
      <label style="font-weight:bold; color:#222;">ì„¸ë¶€ë‚´ìš©(ì—¬ëŸ¬ ì¤„)</label>
      <textarea id="edit-description" style="width:100%; min-height:80px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
      <div style="display:flex; gap:8px;">
        <button type="submit" id="edit-save-btn" style="background:#1976d2; color:#ffffff; font-weight:bold; border:none; border-radius:6px; padding:6px 18px; font-size:15px; cursor:pointer;">ì €ì¥</button>
        <button type="button" id="edit-cancel-btn" style="background:#eee; color:#000000; font-weight:bold; border:none; border-radius:6px; padding:6px 18px; font-size:15px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>
    </form>
    <div class="task-detail-meta-row" id="detail-meta-row">
      <span class="task-badge yellow" id="detail-badge">ì¤‘ê¸‰</span>
      <span class="d-day-badge" id="detail-dday"></span>
    </div>
    <div class="task-detail-divider"></div>
    <div class="task-detail-list" id="detail-list">
        <div class="task-detail-desc" id="detail-desc" style="margin-bottom:16px;">ê°€ì´ë“œë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>        
    </div>
    <div class="task-detail-chat">
        <label style="font-weight:bold; color:#222; margin-bottom:10px; display:block;">ğŸ’¬ ëŒ“ê¸€</label>
      <div id="chat-messages" style="padding:12px; margin-bottom:12px; background:#fafafa; border:none; border-radius:8px;">
        <!-- ë©”ëª¨ ëª©ë¡ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
      <div class="chat-input-row" style="display:flex; align-items:center;">
        <input type="text" class="chat-input" id="chat-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex:1; padding:10px; border:1px solid #ccc; border-radius:6px 0 0 6px; font-size:14px;">
        <button class="chat-send-btn" id="chat-send-btn" style="background:#1976d2; color:#ffffff; font-weight:bold; border:none; border-radius:8px; padding:5px 11px; font-size:15px; cursor:pointer;">ë“±ë¡</button>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ëª¨ë‹¬ -->
<div id="subtask-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:25000; align-items:center; justify-content:center;">
  <div style="background:white; border-radius:12px; padding:32px; width:700px; max-width:95vw; max-height:95vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3); position:relative; margin:auto;">
    
    <!-- ëª¨ë‹¬ í—¤ë” -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #e0e0e0; padding-bottom:16px;">
      <h3 style="margin:0; color:#333; font-size:18px; font-weight:600;">í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„±</h3>
      <button id="subtask-modal-close" style="background:none; border:none; font-size:20px; cursor:pointer; color:#666; padding:0; width:24px; height:24px; display:flex; align-items:center; justify-content:center;">Ã—</button>
    </div>
    
    <!-- í¼ ë‚´ìš© -->
    <form id="subtask-form">
      <!-- ìƒìœ„ Task -->
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-weight:500; color:#333;">ìƒìœ„ Task</label>
        <input id="parent-task-title" type="text" readonly style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; background:#f8f9fa; color:#666; font-size:14px;" placeholder="ìƒìœ„ íƒœìŠ¤í¬ë¥¼ ì„ íƒí•˜ì„¸ìš”">
        <input id="parent-task-id" type="hidden">
        <input id="parent-mentorship-id" type="hidden">
      </div>
      
      <!-- ì œëª© -->
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-weight:500; color:#333;">ì œëª© <span style="color:#e74c3c;">*</span></label>
        <input id="subtask-title" type="text" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;" placeholder="í•˜ìœ„ íƒœìŠ¤í¬ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
      </div>
      
      <!-- ê°€ì´ë“œë¼ì¸ -->
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-weight:500; color:#333;">ê°€ì´ë“œë¼ì¸</label>
        <input id="subtask-guideline" type="text" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;" placeholder="íƒœìŠ¤í¬ ìˆ˜í–‰ì„ ìœ„í•œ ê°€ì´ë“œë¼ì¸ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      
      <!-- ì„¸ë¶€ë‚´ìš© -->
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-weight:500; color:#333;">ì„¸ë¶€ë‚´ìš©</label>
        <textarea id="subtask-description" style="width:100%; min-height:120px; padding:10px; border:1px solid #ddd; border-radius:6px; resize:vertical; font-size:14px; font-family:inherit;" placeholder="íƒœìŠ¤í¬ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </div>
      
      <!-- ìš°ì„ ìˆœìœ„ì™€ ë‚ ì§œ í•œ ì¤„ì— ë°°ì¹˜ -->
      <div style="display:flex; gap:16px; margin-bottom:16px;">
        <!-- ìš°ì„ ìˆœìœ„ -->
        <div style="flex:1;">
          <label style="display:block; margin-bottom:6px; font-weight:500; color:#333;">ìš°ì„ ìˆœìœ„</label>
          <select id="subtask-priority" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
            <option value="ìƒ">ìƒ</option>
            <option value="ì¤‘">ì¤‘</option>
            <option value="í•˜">í•˜</option>
          </select>
        </div>
        
        <!-- ì‹œì‘ì¼ -->
        <div style="flex:1;">
          <label style="display:block; margin-bottom:6px; font-weight:500; color:#333;">ì‹œì‘ì¼</label>
          <input id="subtask-start-date" type="date" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
        </div>
        
        <!-- ë§ˆê°ì¼ -->
        <div style="flex:1;">
          <label style="display:block; margin-bottom:6px; font-weight:500; color:#333;">ë§ˆê°ì¼</label>
          <input id="subtask-end-date" type="date" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
        </div>
      </div>
      
      <!-- ë²„íŠ¼ ì˜ì—­ -->
      <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px; padding-top:16px; border-top:1px solid #e0e0e0;">
        <button type="button" id="subtask-cancel-btn" style="padding:10px 20px; border:1px solid #ddd; border-radius:6px; background:white; color:#666; font-size:14px; cursor:pointer; font-weight:500;">ì·¨ì†Œ</button>
        <button type="submit" id="subtask-create-btn" style="padding:10px 20px; border:none; border-radius:6px; background:#1976d2; color:white; font-size:14px; cursor:pointer; font-weight:500;">ìƒì„±</button>
      </div>
    </form>
  </div>
</div>


{% csrf_token %}
{{ selected_task|json_script:"selected-task-data" }}
<script>
// Django í…œí”Œë¦¿ ë³€ìˆ˜ë¥¼ JavaScriptë¡œ ì „ë‹¬
window.mentorshipId = {% if mentorship_id %}'{{ mentorship_id }}'{% else %}null{% endif %};
window.selectedTaskData = JSON.parse(document.getElementById('selected-task-data').textContent || 'null');
console.log('ğŸ” ì „ë‹¬ë°›ì€ selectedTaskData:', window.selectedTaskData);

// ğŸš€ Task List ì™„ì„± JavaScript
let currentSelectedTaskId = null; // í˜„ì¬ ì„ íƒëœ íƒœìŠ¤í¬ ID

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Task List ì´ˆê¸°í™” ì‹œì‘');
    
    try {
        // íƒœìŠ¤í¬ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
        initializeTaskCards();

        // ìš°ì¸¡ ë””í…Œì¼ íŒ¨ë„ ë²„íŠ¼ ì„¤ì •
        initializeDetailPanelButtons();

        // ë©”ì‹œì§€ ì „ì†¡ ê¸°ëŠ¥ ì„¤ì •
        initializeMessageSystem();

        // í•„í„°/ì •ë ¬ ê¸°ëŠ¥ ì„¤ì • (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
        initializeFilterAndSort();

        // ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ ëª¨ë‹¬ ì´ˆê¸°í™”
        initSubtaskModal();

        // **ë©˜í† /ë©˜í‹°ë³„ 'ì™„ë£Œ' ì˜µì…˜ ì œì–´**
        const statusSelect = document.getElementById('edit-status');
        if (statusSelect && window.userRole === 'mentee') {
            Array.from(statusSelect.options).forEach(option => {
                if (option.value === 'ì™„ë£Œ') {
                    option.remove();
                }
            });
        }
        

        // ì²« ë²ˆì§¸ íƒœìŠ¤í¬ ìë™ ì„ íƒ ë° ìƒì„¸ í‘œì‹œ
        setTimeout(() => {
            const firstTaskCard = document.querySelector('.task-card');
            if (firstTaskCard) {
                const taskId = firstTaskCard.dataset.taskId || firstTaskCard.getAttribute('data-task-id');
                firstTaskCard.classList.add('selected');
                selectTask(firstTaskCard, taskId, false); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ìƒì„¸ í‘œì‹œ
            }
        }, 100);

        console.log('âœ… Task List ì´ˆê¸°í™” ì™„ë£Œ');
    } catch (error) {
        console.error('âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
    }
});

// ğŸ”§ íƒœìŠ¤í¬ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì´ˆê¸°í™”
function initializeTaskCards() {
    document.querySelectorAll('.task-card').forEach(card => {
        // ì¼ë°˜ í´ë¦­ - íƒœìŠ¤í¬ ì„ íƒ
        card.addEventListener('click', function(e) {
            // í•˜ìœ„ íƒœìŠ¤í¬ í† ê¸€ ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ì„ íƒí•˜ì§€ ì•ŠìŒ
            if (e.target.classList.contains('subtask-toggle')) {
                toggleSubtasks(e.target);
                return;
            }
            
            // ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ì„ íƒí•˜ì§€ ì•ŠìŒ
            if (e.target.classList.contains('create-subtask-btn')) {
                return; // ë²„íŠ¼ ìì²´ ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬
            }
            
            // í•˜ìœ„ íƒœìŠ¤í¬ ì•„ì´í…œ í´ë¦­ ì‹œ
            if (e.target.closest('.subtask-item')) {
                const subtaskItem = e.target.closest('.subtask-item');
                const subtaskId = subtaskItem.dataset.taskId;
                selectTask(subtaskItem, subtaskId); // í•˜ìœ„ íƒœìŠ¤í¬ ID ì „ë‹¬
                return;
            }
            
            // ë©”ì¸ íƒœìŠ¤í¬ ì„ íƒ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
            const taskId = card.dataset.taskId;
            selectTask(card, taskId);
        });
    });
    
    console.log('âœ… íƒœìŠ¤í¬ ì¹´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ (í´ë¦­: ì„ íƒ)');
}

// ğŸ”§ ìš°ì¸¡ ë””í…Œì¼ íŒ¨ë„ ë²„íŠ¼ ì´ˆê¸°í™”
function initializeDetailPanelButtons() {
    // í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const subtaskBtn = document.getElementById('task-detail-subtask-btn');
    if (subtaskBtn) {
        subtaskBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // í˜„ì¬ ì„ íƒëœ íƒœìŠ¤í¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const selectedCard = document.querySelector('.task-card.selected');
            if (!selectedCard) {
                alert('íƒœìŠ¤í¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const parentId = selectedCard.dataset.taskId;
            const parentTitle = selectedCard.dataset.title || selectedCard.querySelector('.task-title')?.textContent || 'ì„ íƒëœ íƒœìŠ¤í¬';
            
            console.log(`ğŸ”§ ìš°ì¸¡ íŒ¨ë„ í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„± ë²„íŠ¼ í´ë¦­: ${parentTitle} (ID: ${parentId})`);
            

            console.log(`í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„±: ${parentTitle} (ID: ${parentId})`);
            // í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ëª¨ë‹¬ ì—´ê¸°
            openSubtaskModal(parentId, parentTitle);
        });
        
        console.log('âœ… ìš°ì¸¡ ë””í…Œì¼ íŒ¨ë„ í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
    }
}

// ğŸ”§ ë©”ì‹œì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
function initializeMessageSystem() {
    const chatSendBtn = document.getElementById('chat-send-btn');
    const chatInput = document.getElementById('chat-input');
    
    if (chatSendBtn && chatInput) {
        // ì „ì†¡ ë²„íŠ¼ í´ë¦­
        chatSendBtn.addEventListener('click', sendMessage);
        
        // Enter í‚¤ ì „ì†¡
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        console.log('âœ… ë©”ì‹œì§€ ì‹œìŠ¤í…œ ì„¤ì • ì™„ë£Œ');
    }
}

// ğŸ”§ í•„í„°/ì •ë ¬ ê¸°ëŠ¥ ì´ˆê¸°í™” (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
function initializeFilterAndSort() {
    // ê¸°ì¡´ í•„í„°/ì •ë ¬ ë¡œì§ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
    console.log('âœ… í•„í„°/ì •ë ¬ ê¸°ëŠ¥ ì„¤ì • ì™„ë£Œ');
}

// ğŸ”§ ì²« ë²ˆì§¸ íƒœìŠ¤í¬ ìë™ ì„ íƒ
function selectFirstTask() {
    // ë¨¼ì € selectedTaskDataê°€ ìˆëŠ”ì§€ í™•ì¸
    if (window.selectedTaskData) {
        const taskId = window.selectedTaskData.task_assign_id || window.selectedTaskData.task_id;
        console.log('ğŸ” selectedTaskDataì—ì„œ íƒœìŠ¤í¬ ì„ íƒ:', taskId);
        
        // í•´ë‹¹ íƒœìŠ¤í¬ ì¹´ë“œ ì°¾ì•„ì„œ ì„ íƒ
        const targetCard = document.querySelector(`[data-task-id="${taskId}"]`);
        if (targetCard) {
            selectTask(targetCard, taskId, false);
            return;
        }
    }
    
    // selectedTaskDataê°€ ì—†ê±°ë‚˜ í•´ë‹¹ ì¹´ë“œë¥¼ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ ì²« ë²ˆì§¸ ì¹´ë“œ ì„ íƒ
    const firstTaskCard = document.querySelector('.task-card.selected');
    if (firstTaskCard) {
        const taskId = firstTaskCard.dataset.taskId;
        selectTask(firstTaskCard, taskId, false); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´
    } else {
        // selected í´ë˜ìŠ¤ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì¹´ë“œ ì„ íƒ
        const firstCard = document.querySelector('.task-card');
        if (firstCard) {
            const taskId = firstCard.dataset.taskId;
            selectTask(firstCard, taskId, false);
        }
    }
}

// ğŸ¯ íƒœìŠ¤í¬ ì„ íƒ í•¨ìˆ˜ (í•µì‹¬ ê¸°ëŠ¥)
async function selectTask(taskCard, taskId, animate = true) {
    try {
        console.log(`ğŸ¯ íƒœìŠ¤í¬ ì„ íƒ: ID ${taskId}`);
        
        // 1. ê¸°ì¡´ ì„ íƒ í•´ì œ
        document.querySelectorAll('.task-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // 2. ìƒˆ ì¹´ë“œ ì„ íƒ í‘œì‹œ
        taskCard.classList.add('selected');
        currentSelectedTaskId = taskId;
        
        // 3. ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        if (animate) {
            taskCard.style.transform = 'scale(1.02)';
            setTimeout(() => {
                taskCard.style.transform = 'scale(1)';
            }, 150);
        }
        
        // 4. ìš°ì¸¡ íŒ¨ë„ ì—…ë°ì´íŠ¸
        await updateTaskDetailPanel(taskId);

        // selectTask() ë‚´ë¶€
        const subtaskBtn = document.getElementById('task-detail-subtask-btn');
        if (subtaskBtn) {
            if (taskCard.classList.contains('subtask-item')) {
                subtaskBtn.style.display = 'none';
            } else {
                subtaskBtn.style.display = 'inline-block';
            }
        }


        
        
        console.log(`âœ… íƒœìŠ¤í¬ ${taskId} ì„ íƒ ì™„ë£Œ`);
        
    } catch (error) {
        console.error(`âŒ íƒœìŠ¤í¬ ì„ íƒ ì‹¤íŒ¨: ${error}`);
        showErrorMessage('íƒœìŠ¤í¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ğŸ”„ ìš°ì¸¡ íŒ¨ë„ ì—…ë°ì´íŠ¸ (API í˜¸ì¶œ)
async function updateTaskDetailPanel(taskId) {
    try {
        console.log(`ğŸ”„ íƒœìŠ¤í¬ ìƒì„¸ ì •ë³´ ë¡œë“œ: ${taskId}`);
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        showLoadingState();
        
        // API í˜¸ì¶œ
        const response = await fetch(`/mentee/task_detail/${taskId}/`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            const task = data.task;
            
            // ìš°ì¸¡ íŒ¨ë„ ì •ë³´ ì—…ë°ì´íŠ¸
            updateTaskInfo(task);
            
            // ê°€ì´ë“œë¼ì¸ ì—…ë°ì´íŠ¸
            updateGuideline(task.guideline);
            
            // ë©”ëª¨ ëª©ë¡ ì—…ë°ì´íŠ¸
            console.log(`ğŸ” íƒœìŠ¤í¬ ${taskId} ë©”ëª¨ ë°ì´í„°:`, task.memos);
            updateMemoList(task.memos || []);
            
            // currentTask ì„¤ì • (í¸ì§‘ ê¸°ëŠ¥ìš©)
            currentTask = {
                id: task.task_assign_id || task.id,
                task_assign_id: task.task_assign_id || task.id,
                title: task.title,
                description: task.description,
                guideline: task.guideline,
                status: task.status,
                priority: task.priority,
                scheduled_end_date: task.scheduled_end_date,
                week: task.week,
                order: task.order,
                parent_id: task.parent_id
            };

            // í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ë²„íŠ¼ í† ê¸€
            const subtaskBtn = document.getElementById('task-detail-subtask-btn');
            if (subtaskBtn) {
                if (task.parent_id) {
                    // parent_idê°€ ì¡´ì¬í•˜ë©´ í•˜ìœ„ íƒœìŠ¤í¬ì´ë¯€ë¡œ ë²„íŠ¼ ìˆ¨ê¹€
                    subtaskBtn.style.display = 'none';
                } else {
                    // ìƒìœ„ íƒœìŠ¤í¬ë©´ ë²„íŠ¼ í‘œì‹œ
                    subtaskBtn.style.display = 'inline-block';
                }
            }

            
            console.log(`âœ… íƒœìŠ¤í¬ ${taskId} ìƒì„¸ ì •ë³´ ë¡œë“œ ì™„ë£Œ (ë©”ëª¨ ${task.memos ? task.memos.length : 0}ê°œ)`);
            
        } else {
            throw new Error(data.error || 'íƒœìŠ¤í¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
    } catch (error) {
        console.error(`âŒ íƒœìŠ¤í¬ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ${error}`);
        showErrorState();
    } finally {
        hideLoadingState();
    }
}

// ğŸ“ íƒœìŠ¤í¬ ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
function updateTaskInfo(task) {
    // ì œëª© ì—…ë°ì´íŠ¸
    const titleElement = document.getElementById('detail-title');
    if (titleElement) {
        titleElement.textContent = task.title || 'ì œëª© ì—†ìŒ';
    }
    
    // ì„¤ëª… ì—…ë°ì´íŠ¸
    const descElement = document.getElementById('detail-desc');
    if (descElement) {
        descElement.textContent = task.desc || task.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
    }
    
    // ìš°ì„ ìˆœìœ„ ë±ƒì§€ ì—…ë°ì´íŠ¸
    const badgeElement = document.getElementById('detail-badge');
    if (badgeElement) {
        badgeElement.textContent = task.priority || 'ì¤‘';
        badgeElement.className = 'task-badge yellow'; // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€
    }
    
    // D-Day ì—…ë°ì´íŠ¸
    const ddayElement = document.getElementById('detail-dday');
    if (ddayElement && task.scheduled_end_date) {
        const ddayText = calculateDday(task.scheduled_end_date);
        ddayElement.textContent = ddayText || '';
        ddayElement.style.display = ddayText ? 'inline-block' : 'none';
    }
    
    console.log('âœ… íƒœìŠ¤í¬ ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

// ğŸ“‹ ê°€ì´ë“œë¼ì¸ ì—…ë°ì´íŠ¸
function updateGuideline(guideline) {
    const guidelineElement = document.getElementById('guideline-content');
    if (guidelineElement) {
        if (guideline && guideline.trim()) {
            guidelineElement.textContent = guideline;
            guidelineElement.style.color = '#333';
        } else {
            guidelineElement.textContent = 'ê°€ì´ë“œë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤.';
            guidelineElement.style.color = '#999';
            guidelineElement.style.fontStyle = 'italic';
        }
    }
    
    console.log('âœ… ê°€ì´ë“œë¼ì¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

// ğŸ’¬ ë©”ëª¨ ëª©ë¡ ì—…ë°ì´íŠ¸
function updateMemoList(memos) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    // ê¸°ì¡´ ë©”ëª¨ ì œê±°
    messagesContainer.innerHTML = '';
    
    if (memos && memos.length > 0) {
        memos.forEach(memo => {
            const memoElement = document.createElement('div');
            memoElement.className = 'memo-item';
            memoElement.style.cssText = `
            margin-bottom: 16px;       /* ëŒ“ê¸€ ê°„ê²© ì¦ê°€ */
            padding: 16px 20px;        /* ë‚´ë¶€ ì—¬ë°±ì„ ë” í¬ê²Œ */
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        `;
            
            // ì‘ì„±ì, ìƒì„±ì‹œê°„, ë‚´ìš© ë¶„ë¦¬í•´ì„œ í‘œì‹œ
            let displayUser = 'ìµëª…';
            let displayDate = '';
            let displayComment = '';
            
            if (memo.user && typeof memo.user === 'object') {
                const lastName = memo.user.last_name || '';
                const firstName = memo.user.first_name || '';
                if (lastName || firstName) {
                    displayUser = `${lastName}${firstName}`.trim();
                }
            } else if (typeof memo.user === 'string' && memo.user.trim() !== '') {
                displayUser = memo.user;
            }
            
            if (memo.create_date) {
                const dateObj = new Date(memo.create_date);
                if (!isNaN(dateObj.getTime())) {
                    const y = dateObj.getFullYear();
                    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const d = String(dateObj.getDate()).padStart(2, '0');
                    const hh = String(dateObj.getHours()).padStart(2, '0');
                    const mm = String(dateObj.getMinutes()).padStart(2, '0');
                    const ss = String(dateObj.getSeconds()).padStart(2, '0');
                    displayDate = `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
                } else {
                    displayDate = memo.create_date;
                }
            }
            
            displayComment = memo.comment || '';
            console.log('ğŸ” ë©”ëª¨ ë°ì´í„°:', { user: memo.user, create_date: memo.create_date, comment: memo.comment });
            
            memoElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-weight: bold; color: #1976d2; font-size: 15px;">${displayUser}</span>
                    <span style="color: #888; font-size: 13px;">${displayDate}</span>
                </div>
                <div style="color: #222; font-size: 15px; line-height: 1.6; margin-top: 2px; white-space: pre-wrap;">${displayComment}</div>
            `;
            messagesContainer.appendChild(memoElement);
        });
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } else {
        messagesContainer.innerHTML = `
            <div style="text-align: center; color: #999; font-style: italic; padding: 20px;">
                ì•„ì§ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
        `;
    }
    console.log(`âœ… ë©”ëª¨ ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ (${memos.length}ê°œ)`);
}


// ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
async function sendMessage() {
    if (!currentSelectedTaskId) {
        showErrorMessage('íƒœìŠ¤í¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const chatInput = document.getElementById('chat-input');
    if (!chatInput) return;
    
    const message = chatInput.value.trim();
    if (!message) {
        chatInput.focus();
        return;
    }
    
    try {
        console.log(`ğŸ“¤ ë©”ëª¨ ì „ì†¡ ì‹œì‘: ${currentSelectedTaskId}`);
        
        // ë¡œë”© ìƒíƒœ
        const sendBtn = document.getElementById('chat-send-btn');
        const originalText = sendBtn.innerHTML;
        sendBtn.innerHTML = '<span style="font-size:15px;">ì „ì†¡ì¤‘...</span>';
        sendBtn.disabled = true;
        chatInput.disabled = true;
        
        // API í˜¸ì¶œ
        const response = await fetch(`/mentee/task_comment/${currentSelectedTaskId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ comment: message }),
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            // ì„±ê³µ ì‹œ ì…ë ¥ì°½ ì´ˆê¸°í™”
            chatInput.value = '';
            
            // ë©”ëª¨ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await updateTaskDetailPanel(currentSelectedTaskId);
            
            // ì„±ê³µ ë©”ì‹œì§€
            showSuccessMessage('ë©”ëª¨ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            console.log('âœ… ë©”ëª¨ ì „ì†¡ ì„±ê³µ');
            
        } else {
            throw new Error(data.error || 'ë©”ëª¨ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
    } catch (error) {
        console.error(`âŒ ë©”ëª¨ ì „ì†¡ ì‹¤íŒ¨: ${error}`);
        showErrorMessage('ë©”ëª¨ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
        // ë¡œë”© ìƒíƒœ í•´ì œ
        const sendBtn = document.getElementById('chat-send-btn');
        sendBtn.innerHTML = '<span style="font-size:15px;">ë“±ë¡</span>';
        sendBtn.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
    }
}

// ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ í† ê¸€ (êµ¬ì¡° ë³€ê²½ì— ë§ê²Œ ìˆ˜ì •)
function toggleSubtasks(toggleBtn) {
    // í† ê¸€ ë²„íŠ¼ì˜ ë‹¤ìŒ í˜•ì œ ìš”ì†Œì¸ subtask-list ì°¾ê¸°
    const subtaskList = toggleBtn.nextElementSibling;
    
    if (subtaskList && subtaskList.classList.contains('subtask-list')) {
        const isVisible = subtaskList.style.display !== 'none';
        subtaskList.style.display = isVisible ? 'none' : 'block';
        
        // í•˜ìœ„ íƒœìŠ¤í¬ ê°œìˆ˜ ê³„ì‚°
        const subtaskCount = subtaskList.children.length;
        toggleBtn.innerHTML = isVisible ? 'â–¼ í•˜ìœ„ ' + subtaskCount + 'ê°œ' : 'â–² í•˜ìœ„ ' + subtaskCount + 'ê°œ';
        
        console.log(`ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ í† ê¸€: ${isVisible ? 'ì ‘ê¸°' : 'í¼ì¹˜ê¸°'} (${subtaskCount}ê°œ)`);
    } else {
        console.error('ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', toggleBtn);
    }
}

// ğŸ• D-day ê³„ì‚° í•¨ìˆ˜
function calculateDday(scheduledEndDate) {
    if (!scheduledEndDate) return null;
    
    try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const endDate = new Date(scheduledEndDate);
        endDate.setHours(0, 0, 0, 0);
        const diffTime = endDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            return `D+${Math.abs(diffDays)}`;
        } else if (diffDays === 0) {
            return 'D-Day';
        } else {
            return `D-${diffDays}`;
        }
    } catch (error) {
        console.error('D-day ê³„ì‚° ì˜¤ë¥˜:', error);
        return null;
    }
}

// ğŸª CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ğŸ”„ ë¡œë”© ìƒíƒœ í‘œì‹œ
function showLoadingState() {
    const elements = ['detail-title', 'detail-desc', 'guideline-content', 'chat-messages'];
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.opacity = '0.6';
        }
    });
}

function hideLoadingState() {
    const elements = ['detail-title', 'detail-desc', 'guideline-content', 'chat-messages'];
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.opacity = '1';
        }
    });
}

// âš ï¸ ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
function showErrorState() {
    const titleElement = document.getElementById('detail-title');
    const descElement = document.getElementById('detail-desc');
    const guidelineElement = document.getElementById('guideline-content');
    const messagesElement = document.getElementById('chat-messages');
    
    if (titleElement) titleElement.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
    if (descElement) descElement.textContent = 'íƒœìŠ¤í¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    if (guidelineElement) {
        guidelineElement.textContent = 'ê°€ì´ë“œë¼ì¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        guidelineElement.style.color = '#dc3545';
    }
    if (messagesElement) {
        messagesElement.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
}

// ğŸ’¬ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ë“¤
function showSuccessMessage(message) {
    showToast(message, 'success');
}

function showErrorMessage(message) {
    showToast(message, 'error');
}

function showToast(message, type = 'info') {
    // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
    const existingToast = document.querySelector('.toast-message');
    if (existingToast) {
        existingToast.remove();
    }
    
    // ìƒˆ í† ìŠ¤íŠ¸ ìƒì„±
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 300px;
        word-wrap: break-word;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ë‚˜íƒ€ë‚´ê¸°
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    }, 100);
    
    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ğŸ” ë””ë²„ê¹…ìš© í•¨ìˆ˜
function debugTaskList() {
    console.log('ğŸ” Task List ë””ë²„ê¹… ì •ë³´:');
    console.log('í˜„ì¬ ì„ íƒëœ íƒœìŠ¤í¬ ID:', currentSelectedTaskId);
    console.log('íƒœìŠ¤í¬ ì¹´ë“œ ê°œìˆ˜:', document.querySelectorAll('.task-card').length);
    console.log('ë©˜í† ì‰½ ID:', window.mentorshipId);
}

// ì „ì—­ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
window.debugTaskList = debugTaskList;

// ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
function openSubtaskModal(parentTaskId, parentTaskTitle) {
    console.log(`ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ëª¨ë‹¬ ì—´ê¸° - ìƒìœ„ íƒœìŠ¤í¬: ${parentTaskTitle} (ID: ${parentTaskId})`);
    
    // ëª¨ë‹¬ í‘œì‹œ - flex ì†ì„±ìœ¼ë¡œ ì¤‘ì•™ ì •ë ¬
    const modal = document.getElementById('subtask-modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ë°©ì§€
    
    // ìƒìœ„ íƒœìŠ¤í¬ ì •ë³´ ì„¤ì •
    let displayTitle = parentTaskTitle || 'ì„ íƒëœ íƒœìŠ¤í¬';
    
    // currentTaskì—ì„œ parent ì •ë³´ê°€ ìˆìœ¼ë©´ parentì˜ titleì„ í‘œì‹œ
    // if (currentTask && currentTask.parent_title) {
    //     displayTitle = currentTask.parent_title;
    // } else if (currentTask && currentTask.title) {
    //     displayTitle = currentTask.title;
    // }

    document.getElementById('subtask-form').reset();
    
    document.getElementById('parent-task-title').value = displayTitle;
    document.getElementById('parent-task-id').value = parentTaskId || '';
    document.getElementById('parent-mentorship-id').value = window.mentorshipId || '';
    
    // í¼ ì´ˆê¸°í™”
    document.getElementById('subtask-title').focus();
    
    // ìƒìœ„ íƒœìŠ¤í¬ì˜ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ê¸°ë³¸ê°’ ì„¤ì •
    const selectedCard = document.querySelector('.task-card.selected');
    if (selectedCard && currentTask) {
        // ìš°ì„ ìˆœìœ„ë¥¼ ìƒìœ„ íƒœìŠ¤í¬ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
        const parentPriority = currentTask.priority || selectedCard.dataset.priority || 'í•˜';
        document.getElementById('subtask-priority').value = parentPriority;
        
        // ì‹œì‘ì¼ê³¼ ë§ˆê°ì¼ì„ ìƒìœ„ íƒœìŠ¤í¬ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
        const parentStartDate = currentTask.scheduled_start_date || selectedCard.dataset.scheduledStartDate;
        const parentEndDate = currentTask.scheduled_end_date || selectedCard.dataset.scheduledEndDate;
        
        if (parentStartDate) {
            document.getElementById('subtask-start-date').value = parentStartDate;
        } else {
            // ì‹œì‘ì¼ì´ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('subtask-start-date').value = today;
        }
        
        if (parentEndDate) {
            document.getElementById('subtask-end-date').value = parentEndDate;
        }
    } else {
        // ê¸°ë³¸ê°’ ì„¤ì •
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('subtask-start-date').value = today;
        document.getElementById('subtask-priority').value = 'í•˜'; // ê¸°ë³¸ê°’
    }
}

function closeSubtaskModal() {
    console.log('ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ëª¨ë‹¬ ë‹«ê¸°');
    
    const modal = document.getElementById('subtask-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // ìŠ¤í¬ë¡¤ ë³µì›
    
    // í¼ ì´ˆê¸°í™”
    document.getElementById('subtask-form').reset();
}

// í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± í•¨ìˆ˜
async function createSubtask() {
    console.log('ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ì‹œì‘');
    
    const parentTaskId = document.getElementById('parent-task-id').value;
    const mentorshipId = document.getElementById('parent-mentorship-id').value;
    const title = document.getElementById('subtask-title').value.trim();
    const guideline = document.getElementById('subtask-guideline').value.trim();
    const description = document.getElementById('subtask-description').value.trim();
    const priority = document.getElementById('subtask-priority').value || '';
    const startDate = document.getElementById('subtask-start-date').value;
    const endDate = document.getElementById('subtask-end-date').value;
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!title) {
        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        document.getElementById('subtask-title').focus();
        return;
    }
    
    if (!parentTaskId) {
        alert('ìƒìœ„ íƒœìŠ¤í¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        // ë¡œë”© ìƒíƒœ
        const createBtn = document.getElementById('subtask-create-btn');
        const originalText = createBtn.textContent;
        createBtn.textContent = 'ìƒì„± ì¤‘...';
        createBtn.disabled = true;
        
        // ë©˜í† ì‹­ IDë¥¼ URLì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸° 
        const urlParams = new URLSearchParams(window.location.search);
        const finalMentorshipId = urlParams.get('mentorship_id') || window.mentorshipId;
        console.log('ğŸ” URLì—ì„œ ê°€ì ¸ì˜¨ ë©˜í† ì‹­ ID:', finalMentorshipId);
        
        if (!finalMentorshipId) {
            alert('ë©˜í† ì‹­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const requestData = {
            title: title,
            guideline: guideline,
            description: description,
            priority: priority,
            scheduled_start_date: startDate || null,
            scheduled_end_date: endDate || null,
            mentorship_id: parseInt(finalMentorshipId),
            week: null, // ìƒìœ„ íƒœìŠ¤í¬ì—ì„œ ìƒì†
            order: null, // ìë™ ìƒì„±
            status: 'ì§„í–‰ì „'
        };
        
        console.log('ğŸ” ì „ì†¡í•  ë°ì´í„°:', requestData);
        
        // API í˜¸ì¶œ
        const response = await fetch(`/mentee/create_subtask/${parentTaskId}/?mentorship_id=${finalMentorshipId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(requestData),
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ì„±ê³µ:', data.subtask_id);
            
            // ì„±ê³µ ë©”ì‹œì§€
            showSuccessMessage('í•˜ìœ„ íƒœìŠ¤í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeSubtaskModal();
            
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ìƒˆ í•˜ìœ„ íƒœìŠ¤í¬ í‘œì‹œ
            setTimeout(() => {
                window.location.reload();
            }, 1000);
            
        } else {
            throw new Error(data.error || 'í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
    } catch (error) {
        console.error('âŒ í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„± ì‹¤íŒ¨:', error);
        showErrorMessage('í•˜ìœ„ íƒœìŠ¤í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        // ë¡œë”© ìƒíƒœ í•´ì œ
        const createBtn = document.getElementById('subtask-create-btn');
        createBtn.textContent = 'ìƒì„±';
        createBtn.disabled = false;
    }
}

// ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
function initSubtaskModal() {
    console.log('ğŸ”§ í•˜ìœ„ íƒœìŠ¤í¬ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”');
    
    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ë“¤
    document.getElementById('subtask-modal-close').addEventListener('click', closeSubtaskModal);
    document.getElementById('subtask-cancel-btn').addEventListener('click', closeSubtaskModal);
    
    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('subtask-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeSubtaskModal();
        }
    });
    
    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('subtask-modal');
            if (modal.style.display !== 'none') {
                closeSubtaskModal();
            }
        }
    });
    
    // í¼ ì œì¶œ ì²˜ë¦¬
    document.getElementById('subtask-form').addEventListener('submit', function(e) {
        e.preventDefault();
        createSubtask();
    });
    
    console.log('âœ… í•˜ìœ„ íƒœìŠ¤í¬ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
}

// ğŸ”§ í˜ì´ì§€ ë¡œë“œ ì‹œ ì„ íƒëœ íƒœìŠ¤í¬ í‘œì‹œ í•¨ìˆ˜
function displaySelectedTask() {
    console.log('ğŸ” displaySelectedTask í˜¸ì¶œ');
    console.log('ğŸ” selectedTaskData:', window.selectedTaskData);
    
    if (window.selectedTaskData) {
        // í˜„ì¬ ì„ íƒëœ íƒœìŠ¤í¬ ì •ë³´ ì—…ë°ì´íŠ¸
        currentSelectedTaskId = window.selectedTaskData.task_assign_id || window.selectedTaskData.task_id;
        
        console.log('ğŸ” ì„ íƒëœ íƒœìŠ¤í¬ë¡œ ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸:', currentSelectedTaskId);
        
        // í•´ë‹¹ íƒœìŠ¤í¬ ì¹´ë“œì— ì„ íƒ í‘œì‹œ
        const taskCard = document.querySelector(`[data-task-id="${currentSelectedTaskId}"]`);
        if (taskCard) {
            document.querySelectorAll('.task-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.subtask-item').forEach(item => item.classList.remove('selected'));
            taskCard.classList.add('selected');
            console.log('ğŸ” íƒœìŠ¤í¬ ì¹´ë“œì— ì„ íƒ í‘œì‹œ ì ìš©');
        }
        
        // ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸ - selectedTaskDataì— ì´ë¯¸ ìˆëŠ” ì •ë³´ ì‚¬ìš©
        updateTaskInfo(window.selectedTaskData);
        updateGuideline(window.selectedTaskData.guideline);
        
        // currentTask ì„¤ì • (í¸ì§‘ ê¸°ëŠ¥ìš©)
        currentTask = {
            id: window.selectedTaskData.task_assign_id || window.selectedTaskData.id,
            task_assign_id: window.selectedTaskData.task_assign_id || window.selectedTaskData.id,
            title: window.selectedTaskData.title,
            description: window.selectedTaskData.description,
            guideline: window.selectedTaskData.guideline,
            status: window.selectedTaskData.status,
            priority: window.selectedTaskData.priority,
            scheduled_end_date: window.selectedTaskData.scheduled_end_date,
            week: window.selectedTaskData.week,
            order: window.selectedTaskData.order,
            parent_id: window.selectedTaskData.parent_id
        };
        
        // ë©”ëª¨ëŠ” ë³„ë„ë¡œ ë¡œë“œí•´ì•¼ í•¨ (selectedTaskDataì— í¬í•¨ë˜ì§€ ì•ŠìŒ)
        if (currentSelectedTaskId) {
            console.log(`ğŸ” íƒœìŠ¤í¬ ${currentSelectedTaskId}ì˜ ë©”ëª¨ ë¡œë“œ ì¤‘...`);
            fetch(`/mentee/task_detail/${currentSelectedTaskId}`)
                .then(response => response.json())
                .then(data => {
                    console.log(`ğŸ” íƒœìŠ¤í¬ ${currentSelectedTaskId} ë©”ëª¨ ë¡œë“œ ì‘ë‹µ:`, data);
                    if (data.success && data.task && data.task.memos) {
                        console.log(`ğŸ” íƒœìŠ¤í¬ ${currentSelectedTaskId} ë©”ëª¨ ${data.task.memos.length}ê°œ í‘œì‹œ`);
                        updateMemoList(data.task.memos);
                    } else {
                        console.log(`ğŸ” íƒœìŠ¤í¬ ${currentSelectedTaskId} ë©”ëª¨ ì—†ìŒ`);
                        updateMemoList([]);
                    }
                })
                .catch(error => {
                    console.error(`âŒ íƒœìŠ¤í¬ ${currentSelectedTaskId} ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨:`, error);
                    updateMemoList([]);
                });
        }
        
    } else {
        console.log('ğŸ” selectedTaskData ì—†ìŒ - ê¸°ë³¸ ë™ì‘');
    }
}

// ğŸ”§ ì¸ë¼ì¸ í¸ì§‘ ê¸°ëŠ¥ ì¶”ê°€
let isEditing = false;
let currentTask = null;

// í¸ì§‘ í¼ í‘œì‹œ í•¨ìˆ˜
function showEditForm() {
    if (!currentTask) return;
    
    const editForm = document.getElementById('task-edit-form');
    const descDiv = document.getElementById('detail-desc');
    const listDiv = document.getElementById('detail-list');
    const editStatus = document.getElementById('edit-status');
    const editTitle = document.getElementById('edit-title');
    const editGuideline = document.getElementById('edit-guideline');
    const editDescription = document.getElementById('edit-description');
    const editPriority = document.getElementById('edit-priority');
    const editEndDate = document.getElementById('edit-end-date');
    
    // ê¸°ì¡´ ì˜ì—­ ìˆ¨ê¹€
    document.getElementById('detail-header-row').style.display = 'none';
    document.getElementById('detail-meta-row').style.display = 'none';
    
    // ê¸°ì¡´ ê°’ ì„¸íŒ…
    editStatus.value = currentTask.status || 'ì§„í–‰ì „';
    editTitle.value = currentTask.title || '';
    editGuideline.value = currentTask.guideline || '';
    editDescription.value = currentTask.description || '';
    editPriority.value = currentTask.priority || 'í•˜';
    if (currentTask.scheduled_end_date) {
        editEndDate.value = String(currentTask.scheduled_end_date).slice(0, 10);
    } else {
        editEndDate.value = '';
    }
    
    // í¼ í‘œì‹œ
    editForm.style.display = 'block';
    descDiv.style.display = 'none';
    listDiv.style.display = 'none';
    isEditing = true;
    
    // í¸ì§‘ ì¤‘ì¼ ë•Œ ì¢Œì¸¡ ì¹´ë“œë“¤ ë¹„í™œì„±í™”
    const taskListLeft = document.getElementById('tasklist-left');
    if (taskListLeft) {
        taskListLeft.classList.add('editing-mode');
    }
}

// í¸ì§‘ í¼ ìˆ¨ê¹€ í•¨ìˆ˜
function hideEditForm() {
    const editForm = document.getElementById('task-edit-form');
    const descDiv = document.getElementById('detail-desc');
    const listDiv = document.getElementById('detail-list');
    
    editForm.style.display = 'none';
    // ìˆ¨ê²¼ë˜ ì˜ì—­ ë‹¤ì‹œ í‘œì‹œ
    document.getElementById('detail-header-row').style.display = 'flex';
    document.getElementById('detail-meta-row').style.display = 'flex';
    descDiv.style.display = 'block';
    listDiv.style.display = 'block';
    isEditing = false;
    
    // í¸ì§‘ ì™„ë£Œ ì‹œ ì¢Œì¸¡ ì¹´ë“œë“¤ ë‹¤ì‹œ í™œì„±í™”
    const taskListLeft = document.getElementById('tasklist-left');
    if (taskListLeft) {
        taskListLeft.classList.remove('editing-mode');
    }
}

// í¸ì§‘ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.addEventListener('click', function(e) {
    if (e.target && (e.target.id === 'task-edit-btn' || e.target.classList.contains('task-detail-edit-btn'))) {
        e.preventDefault();
        if (isEditing) return;
        showEditForm();
    }
});

// í¸ì§‘ í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
setTimeout(() => {
    const editForm = document.getElementById('task-edit-form');
    const editCancelBtn = document.getElementById('edit-cancel-btn');
    
    if (editCancelBtn) {
        editCancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            hideEditForm();
        });
    }
    
    if (editForm) {
        editForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentTask || !currentTask.id) {
                alert('íƒœìŠ¤í¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // FastAPI ìŠ¤í‚¤ë§ˆì— ë§ëŠ” ì™„ì „í•œ ë°ì´í„° ì¤€ë¹„
            const payload = {
                title: document.getElementById('edit-title').value || currentTask.title,
                description: document.getElementById('edit-description').value || currentTask.description,
                guideline: document.getElementById('edit-guideline').value || currentTask.guideline,
                week: currentTask.week || 1,
                order: currentTask.order,
                scheduled_start_date: currentTask.scheduled_start_date || null,
                scheduled_end_date: document.getElementById('edit-end-date').value || null,
                real_start_date: currentTask.real_start_date || null,
                real_end_date: currentTask.real_end_date || null,
                status: document.getElementById('edit-status').value || currentTask.status,
                priority: document.getElementById('edit-priority').value || currentTask.priority,
                mentorship_id: parseInt(window.mentorshipId),
                parent_id: currentTask.parent_id || null
            };
            
            // ìƒíƒœì— ë”°ë¥¸ ë‚ ì§œ ìë™ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            if (payload.status === 'ì§„í–‰ì¤‘' && !payload.real_start_date) {
                payload.real_start_date = today;
            } else if (payload.status === 'ì™„ë£Œ' && !payload.real_end_date) {
                payload.real_end_date = today;
            }
            
            try {
                console.log('ğŸš€ FastAPIë¡œ íƒœìŠ¤í¬ ì—…ë°ì´íŠ¸ ì‹œì‘:', currentTask.id);
                
                const resp = await fetch(`http://localhost:8001/api/tasks/assign/${currentTask.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!resp.ok) {
                    const errorText = await resp.text();
                    throw new Error(`HTTP ${resp.status}: ${errorText}`);
                }
                
                const data = await resp.json();
                
                if (data) {
                    // í”„ë¡ íŠ¸ ìƒíƒœë„ ë°˜ì˜
                    const oldStatus = currentTask.status;
                    currentTask.status = payload.status;
                    currentTask.title = payload.title;
                    currentTask.guideline = payload.guideline;
                    currentTask.description = payload.description;
                    currentTask.priority = payload.priority;
                    currentTask.scheduled_end_date = payload.scheduled_end_date;
                    
                    // íƒœìŠ¤í¬ ì •ë³´ ì—…ë°ì´íŠ¸
                    updateTaskInfo(currentTask);
                    updateGuideline(currentTask.guideline);
                    
                    // ì™¼ìª½ íƒœìŠ¤í¬ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
                    const taskCard = document.querySelector(`[data-task-id="${currentTask.id}"]`);
                    if (taskCard) {
                        // ì¹´ë“œì˜ data ì†ì„± ì—…ë°ì´íŠ¸
                        taskCard.setAttribute('data-title', payload.title);
                        taskCard.setAttribute('data-status', payload.status);
                        taskCard.setAttribute('data-priority', payload.priority);
                        if (payload.scheduled_end_date) {
                            taskCard.setAttribute('data-scheduled_end_date', payload.scheduled_end_date);
                        }
                        
                        // ìƒíƒœ ë±ƒì§€ ì—…ë°ì´íŠ¸
                        const statusBadge = taskCard.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.textContent = payload.status;
                            statusBadge.className = 'status-badge';
                            if (payload.status === 'ì§„í–‰ì „') statusBadge.classList.add('not-started');
                            else if (payload.status === 'ì§„í–‰ì¤‘') statusBadge.classList.add('in-progress');
                            else if (payload.status === 'ê²€í† ìš”ì²­') statusBadge.classList.add('review-requested');
                            else if (payload.status === 'ì™„ë£Œ' || payload.status === 'ì™„ë£Œë¨') statusBadge.classList.add('done');
                        }
                        
                        // ì œëª© ì—…ë°ì´íŠ¸
                        const titleElement = taskCard.querySelector('.task-title');
                        if (titleElement) {
                            titleElement.textContent = payload.title;
                            if (payload.status === 'ì™„ë£Œ' || payload.status === 'ì™„ë£Œë¨') {
                                titleElement.classList.add('done');
                            } else {
                                titleElement.classList.remove('done');
                            }
                        }
                        
                        // ì„¤ëª… ì—…ë°ì´íŠ¸
                        const descElement = taskCard.querySelector('.task-desc');
                        if (descElement) {
                            descElement.textContent = payload.description || '';
                        }
                        
                        // ì¹´ë“œ ì „ì²´ ìƒíƒœ í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
                        taskCard.classList.remove('not-started', 'in-progress', 'review-requested', 'done');
                        if (payload.status === 'ì§„í–‰ì „') taskCard.classList.add('not-started');
                        else if (payload.status === 'ì§„í–‰ì¤‘') taskCard.classList.add('in-progress');
                        else if (payload.status === 'ê²€í† ìš”ì²­') taskCard.classList.add('review-requested');
                        else if (payload.status === 'ì™„ë£Œ' || payload.status === 'ì™„ë£Œë¨') taskCard.classList.add('done');
                        
                        console.log('âœ… ì™¼ìª½ íƒœìŠ¤í¬ ì¹´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    }
                    
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    showSuccessMessage('íƒœìŠ¤í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    hideEditForm();
                }
            } catch (err) {
                console.error('âŒ FastAPI íƒœìŠ¤í¬ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
                showErrorMessage('íƒœìŠ¤í¬ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        });
    }
}, 500);

</script>
<!-- ê¸°ì¡´ JavaScript íŒŒì¼ì€ ì£¼ì„ ì²˜ë¦¬í•˜ì—¬ ì¶©ëŒ ë°©ì§€ -->
<!-- <script src="{% static 'js/common/mentee_task_list.js' %}"></script> -->
{% endblock %}
