{% extends 'base.html' %}
{% load static %}

{% block title %}íƒœìŠ¤í¬ ëª©ë¡ í˜ì´ì§€{% endblock %}
{% block extra_head %}
<style>
.tasklist-container {
  display: flex;
  gap: 32px;
  width: 100%;
  min-height: 600px;
}
.tasklist-left {
  flex: 1;
  padding: 24px 0 24px 24px;
  background: #fafbfc;
  border-radius: 12px 0 0 12px;
  min-width: 340px;
  max-width: 500px;
  overflow-y: auto;
  max-height: 85vh;
}
.tasklist-title {
  font-size: 1.3em;
  font-weight: bold;
  margin-bottom: 18px;
  color: #222;
}
.tasklist-search-row {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
}
.tasklist-search {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 15px;
}
.tasklist-create-btn {
  padding: 8px 18px;
  background: #ffd600;
  color: #222;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
.tasklist-filter-btn {
  padding: 8px 18px;
  background: #e0e0e0;
  color: #222;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
.tasklist-filter-panel {
  background: #f7f7f7;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 14px 18px 10px 18px;
  margin-top: 4px;
  font-size: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
}
.filter-group {
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.filter-label {
  font-weight: bold;
  margin-right: 8px;
}
.filter-group label {
  margin-right: 8px;
  font-weight: normal;
}
.filter-dday-sort {
  background: #fff;
  border: 1px solid #bbb;
  border-radius: 4px;
  padding: 2px 8px;
  margin-left: 2px;
  cursor: pointer;
  font-size: 15px;
}
.filter-dday-sort.active {
  background: #ffd600;
  color: #222;
  border-color: #ffd600;
}
.task-card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  margin-bottom: 18px;
  padding: 18px 20px 14px 20px;
  border-left: 6px solid #ffd600;
  transition: box-shadow 0.2s, border-color 0.2s;
  cursor: pointer;
  position: relative;
}
.task-card.in-progress { border-left-color: #4caf50; }
.task-card.done { border-left-color: #ffd600; background: #f6fff6; }
.task-card.selected { box-shadow: 0 0 0 3px #1976d233; border-left-color: #1976d2; }
.task-card.not-started { border-left-color: #f44336; }
.task-card.review-requested { border-left-color: #ffd600; }
.task-title {
  color: #222;
}
.task-title.done {
  text-decoration: line-through;
  color: #aaa;
}
.task-title.d-day {
  margin-right: 8px;
  text-align: left;
  display: inline-block;
}
.task-card-header {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  font-size: 17px;
  font-weight: bold;
  margin-bottom: 6px;
  gap: 10px;
}
.task-xp { color: #888; font-size: 15px; display: flex; align-items: center; gap: 4px; }
.icon-trophy { width: 18px; height: 18px; vertical-align: middle; }
.task-desc { color: #555; font-size: 14px; margin-bottom: 8px; }
.task-desc-row { margin-bottom: 8px; }
.task-meta-row {
  display: flex;
  gap: 10px;
  align-items: center;
  font-size: 13px;
  margin-bottom: 4px;
}
.task-week { color: #666; }
.task-badge {
  padding: 2px 10px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: bold;
  color: #fff;
  display: inline-block;
}
.task-badge.red { background: #f44336; color: #fff; }
.task-badge.green { background: #4caf50; color: #fff; }
.task-badge.yellow { background: #ffd600 !important; color: #222 !important; }

.status-badge {
  display: inline-block;
  min-width: 60px;
  padding: 2px 12px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: bold;
  color: #fff;
  margin-right: 10px;
  vertical-align: middle;
}
.status-badge.not-started { background: #888; }
.status-badge.in-progress { background: #1976d2; }
.status-badge.review-requested { background: #f44336; }
.status-badge.done { background: #43a047; }

.subtask-toggle {
  display: flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  margin: 0 0 0 6px;
  font-size: 18px;
  color: #222;
  user-select: none;
}
.subtask-list {
  margin: 0 0 0 32px;
  padding: 0;
  border: 1px solid #bbb;
  border-radius: 8px;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  margin-bottom: 10px;
  display: none;
}
.subtask-list.open { display: block; }
.subtask-card {
  padding: 12px 16px 10px 16px;
  border-bottom: 1px solid #eee;
  font-size: 15px;
  cursor: pointer;
}
.subtask-card:last-child { border-bottom: none; }
.subtask-title { font-weight: bold; font-size: 15px; margin-bottom: 2px; display: block; }
.subtask-desc { color: #555; font-size: 13px; margin-bottom: 4px; }
.subtask-meta-row {
  display: flex;
  gap: 8px;
  align-items: center;
  font-size: 12px;
}
.subtask-week { color: #666; }
.subtask-badge {
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: bold;
  color: #fff;
  display: inline-block;
}
.subtask-badge.green { background: #4caf50; }
.subtask-badge.yellow { background: #ffd600 !important; color: #222 !important; }

.tasklist-right {
  flex: 2;
  background: #fff;
  border-radius: 0 16px 16px 0;
  padding: 36px 48px 32px 48px;
  min-width: 600px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  display: flex;
  flex-direction: column;
  position: relative;
  z-index: 10;
}
.task-detail-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  font-size: 26px;
  font-weight: bold;
  margin-bottom: 8px;
}
.task-detail-title { color: #222; font-size: 26px; font-weight: bold; }
.task-detail-xp { color: #888; font-size: 18px; display: flex; align-items: center; gap: 4px; font-weight: bold; }
.task-detail-desc { color: #222; font-size: 17px; margin-bottom: 12px; margin-top: 8px; }
.task-detail-meta-row {
  display: flex;
  gap: 14px;
  align-items: center;
  font-size: 15px;
  margin-bottom: 12px;
}
.task-detail-divider {
  border: none;
  border-top: 1.5px solid #e0e0e0;
  margin: 18px 0 24px 0;
}
.task-detail-list {
  margin: 0 0 24px 0;
  padding-left: 0;
  color: #222;
  font-size: 17px;
  list-style: none;
}
.task-detail-list ul {
  margin: 0 0 24px 0;
  padding-left: 0;
  color: #222;
  font-size: 17px;
  list-style: none;
}
.task-detail-list ul li {
  margin-bottom: 6px;
  font-weight: 500;
}
.task-detail-chat {
  margin-top: auto;
  background: #fafafa;
  border-radius: 12px;
  padding: 24px 24px 18px 24px;
  margin-top: 32px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.03);
}
.chat-message {
  margin-bottom: 14px;
  font-size: 15px;
  display: flex;
  flex-direction: column;
}
.chat-message .chat-user {
  font-weight: bold;
  color: #43a047;
  margin-bottom: 2px;
}
.chat-message.mine .chat-user { color: #1976d2; }
.chat-message .chat-text { color: #222; margin-bottom: 2px; }
.chat-message .chat-time { color: #aaa; font-size: 12px; }
.chat-input-row {
  display: flex;
  gap: 8px;
  margin-top: 18px;
}
.chat-input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 16px;
  background: #fff;
}
.chat-send-btn {
  padding: 0 24px;
  background: #ffd600;
  color: #222;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
</style>
{% endblock %}
{% block content %}
<div class="tasklist-container">
  <!-- ì¢Œì¸¡: Task ëª©ë¡ -->
<div class="tasklist-left" id="tasklist-left">
  <div class="tasklist-title">Task ëª©ë¡</div>
  {% for week, tasks in week_tasks.items %}
    <div style="font-weight:bold; margin:18px 0 8px 0; color:#1976d2;">{{ week }}ì£¼ì°¨</div>
    {% for task in tasks %}
      <div class="task-card {% if forloop.first and forloop.parentloop.first %}selected{% endif %} {% if task.status == 'ì§„í–‰ ì „' %}not-started{% elif task.status == 'ì§„í–‰ ì¤‘' %}in-progress{% elif task.status == 'ê²€í†  ìš”ì²­' %}review-requested{% elif task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}"
        data-task-id="{{ task.id }}"
        data-title="{{ task.title|escapejs }}"
        data-desc="{{ task.desc|default_if_none:''|escapejs }}"
        data-priority="{{ task.priority|default:'í•˜'|escapejs }}"
        data-status="{{ task.status|escapejs }}"
        data-end_date="{{ task.end_date|date:'Y-m-d' }}"
        data-week="{{ week }}"
        >
        <div class="task-card-header">
          <span class="status-badge {% if task.status == 'ì§„í–‰ ì „' %}not-started{% elif task.status == 'ì§„í–‰ ì¤‘' %}in-progress{% elif task.status == 'ê²€í†  ìš”ì²­' %}review-requested{% elif task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}">{{ task.status }}</span>
          <span class="task-title {% if task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}">{{ task.title }}</span>
        </div>
        <div class="task-desc-row">
          <div class="task-desc">{{ task.desc }}</div>
          <div class="task-meta-row">
            <span class="task-badge {{ task.priority|default:'í•˜'|lower }}">{{ task.priority|default:'í•˜' }}</span>
            <span class="d-day-badge">{{ task.end_date|date:'Y-m-d' }}</span>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endfor %}
</div>
  <!-- ìš°ì¸¡: ìƒì„¸ ì •ë³´ -->
  <div class="tasklist-right">
    <div class="task-detail-header" id="detail-header-row" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <!-- í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„± ëª¨ë‹¬ -->
      <div id="subtask-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:16px; min-width:420px; max-width:600px; padding:40px 36px 32px 36px; box-shadow:0 6px 32px rgba(0,0,0,0.20); position:relative;">
          <button id="subtask-close-btn" style="position:absolute; right:12px; top:10px; background:none; border:none; font-size:18px; color:#888; cursor:pointer; padding:0 4px; width:28px; height:28px; line-height:24px;">&times;</button>
          <form id="subtask-form">
            <div style="font-weight:bold; margin-bottom:18px;">í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„±</div>
            <div style="display:flex; gap:12px; margin-bottom:14px; align-items:flex-end;">
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">ìƒíƒœ</label>
                <select id="subtask-status" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;">
                  <option value="ì§„í–‰ ì „">ì§„í–‰ ì „</option>
                  <option value="ì§„í–‰ ì¤‘">ì§„í–‰ ì¤‘</option>
                  <option value="ê²€í†  ìš”ì²­">ê²€í†  ìš”ì²­</option>
                  <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                </select>
              </div>
              <div style="flex:2;">
                <label style="font-size:17px; color:#222;">ìƒìœ„ Task</label>
                <input id="subtask-parent-title" type="text" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px; background:#f7f7f7;" readonly />
                <input id="subtask-parent-id" type="hidden" />
              </div>
            </div>
            <div style="margin-bottom:14px;">
              <label style="font-size:17px; color:#222;">ì œëª©</label>
              <input id="subtask-title" type="text" style="width:100%; margin-bottom:0; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" required />
            </div>
            <div style="margin-bottom:14px;">
              <label style="font-size:17px; color:#222;">ê°€ì´ë“œë¼ì¸</label>
              <input id="subtask-guideline" type="text" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
            </div>
            <div style="margin-bottom:14px;">
              <label style="font-size:17px; color:#222;">ì„¸ë¶€ë‚´ìš©</label>
              <textarea id="subtask-desc" style="width:100%; min-height:120px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:14px; align-items:flex-end;">
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">ìš°ì„ ìˆœìœ„</label>
                <select id="subtask-priority" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;">
                  <option value="">(ìƒìœ„ì™€ ë™ì¼)</option>
                  <option value="ìƒ">ìƒ</option>
                  <option value="ì¤‘">ì¤‘</option>
                  <option value="í•˜">í•˜</option>
                </select>
              </div>
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">ì‹œì‘ì¼</label>
                <input id="subtask-start-date" type="date" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;" />
              </div>
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">ë§ˆê°ì¼</label>
                <input id="subtask-end-date" type="date" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;" />
              </div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:18px;">
              <button type="submit" class="template-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:8px; padding:6px 18px; font-size:17px; cursor:pointer;">ìƒì„±</button>
              <button type="button" id="subtask-cancel-btn" class="template-btn" style="background:#eee; color:#222; font-weight:bold; border:none; border-radius:8px; padding:6px 18px; font-size:17px; cursor:pointer;">ì·¨ì†Œ</button>
            </div>
          </form>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span class="task-detail-title" id="detail-title">ì²« ë²ˆì§¸ í”„ë¡œì íŠ¸ ì°¸ì—¬í•˜ê¸°</span>
        <span class="task-detail-xp" id="detail-xp" style="color:#888; font-size:17px; display:flex; align-items:center; gap:4px; font-weight:bold;"><span class="icon-trophy" style="font-size:15px;">ğŸ†</span> 100 XP</span>
      </div>
      <div id="detail-header-btns" style="display:flex; gap:10px; margin-left:auto;">
        <button class="task-detail-edit-btn" id="task-edit-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;">í¸ì§‘</button>
        <button class="task-detail-subtask-btn" id="task-detail-subtask-btn" style="background:#e0e0e0; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;">í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„±</button>
      </div>
    </div>
    <div class="task-detail-desc" id="detail-desc">ê°„ë‹¨í•œ í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•˜ì—¬ ì›Œí¬í”Œë¡œìš° ì´í•´í•˜ê¸°</div>
    <form id="task-edit-form" style="display:none; margin-bottom:12px;">
      <div style="display:flex; gap:10px; align-items:flex-end; margin-bottom:8px;">
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">ìƒíƒœ</label>
          <select id="edit-status" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;">
            <option value="ì§„í–‰ ì „">ì§„í–‰ ì „</option>
            <option value="ì§„í–‰ ì¤‘">ì§„í–‰ ì¤‘</option>
            <option value="ê²€í†  ìš”ì²­">ê²€í†  ìš”ì²­</option>
            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
          </select>
        </div>
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">ìš°ì„ ìˆœìœ„</label>
          <select id="edit-priority" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;">
            <option value="ìƒ">ìƒ</option>
            <option value="ì¤‘">ì¤‘</option>
            <option value="í•˜">í•˜</option>
          </select>
        </div>
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">ë§ˆê°ë‚ ì§œ</label>
          <input id="edit-end-date" type="date" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
        </div>
      </div>
      <label style="font-weight:bold; color:#222;">ì œëª©</label>
      <input id="edit-title" type="text" style="width:100%; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
      <label style="font-weight:bold; color:#222;">ê°€ì´ë“œë¼ì¸</label>
      <textarea id="edit-guideline" style="width:100%; min-height:60px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
      <label style="font-weight:bold; color:#222;">ì„¸ë¶€ë‚´ìš©(ì—¬ëŸ¬ ì¤„)</label>
      <textarea id="edit-description" style="width:100%; min-height:80px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
      <div style="display:flex; gap:8px;">
        <button type="submit" id="edit-save-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:6px; padding:6px 18px; font-size:15px; cursor:pointer;">ì €ì¥</button>
        <button type="button" id="edit-cancel-btn" style="background:#eee; color:#222; font-weight:bold; border:none; border-radius:6px; padding:6px 18px; font-size:15px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>
    </form>
    <div class="task-detail-meta-row" id="detail-meta-row">
      <span class="task-badge yellow" id="detail-badge">ì¤‘ê¸‰</span>
      <span class="d-day-badge" id="detail-dday"></span>
    </div>
    <div class="task-detail-divider"></div>
    <div class="task-detail-list" id="detail-list">
      <ul>
        <li>í”„ë¡œì íŠ¸ ì¤€ë¹„</li>
        <li>ì²« í”„ë¡œì íŠ¸ ì§„í–‰</li>
        <li>í”„ë¡œì íŠ¸ ê²°ê³¼ ê³µìœ </li>
      </ul>
    </div>
    <div class="task-detail-chat">
      <div id="chat-messages"></div>
      <div class="chat-input-row">
        <input type="text" class="chat-input" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
        <button class="chat-send-btn" id="chat-send-btn"><span style="font-size:20px;">ğŸ’¬</span></button>
      </div>
    </div>
  </div>
</div>
<script>
// ì¢Œì¸¡ Task ì¹´ë“œ í´ë¦­ ì‹œ ìš°ì¸¡ ìƒì„¸ ì •ë³´ ê°±ì‹  ë° í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„± ëª¨ë‹¬
document.addEventListener('DOMContentLoaded', function() {
  // í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„± ëª¨ë‹¬ ê´€ë ¨
  const subtaskModal = document.getElementById('subtask-modal');
  const subtaskBtn = document.getElementById('task-detail-subtask-btn');
  const subtaskForm = document.getElementById('subtask-form');
  const subtaskCancelBtn = document.getElementById('subtask-cancel-btn');
  subtaskBtn.addEventListener('click', function() {
    if (!currentTask) return alert('ìƒìœ„ Taskë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
    subtaskModal.style.display = 'flex';
    subtaskForm.reset();
    document.getElementById('subtask-parent-title').value = currentTask.title || '';
    document.getElementById('subtask-parent-id').value = currentTask.id;
    document.getElementById('subtask-priority').value = '';
    document.getElementById('subtask-status').value = 'ì§„í–‰ ì „';
    document.getElementById('subtask-end-date').value = '';
  });
  // ë‹«ê¸° ë²„íŠ¼(Ã—)ê³¼ ì·¨ì†Œ ë²„íŠ¼ ëª¨ë‘ ëª¨ë‹¬ ë‹«ê¸°
  const subtaskCloseBtn = document.getElementById('subtask-close-btn');
  function closeSubtaskModal() {
    subtaskModal.style.display = 'none';
  }
  subtaskCancelBtn.addEventListener('click', closeSubtaskModal);
  if (subtaskCloseBtn) {
    subtaskCloseBtn.addEventListener('click', closeSubtaskModal);
  }
  // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
  document.addEventListener('keydown', function(e) {
    if (subtaskModal.style.display === 'flex' && (e.key === 'Escape' || e.key === 'Esc')) {
      closeSubtaskModal();
    }
  });
  subtaskForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentTask) return alert('ìƒìœ„ Taskë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
    const title = document.getElementById('subtask-title').value.trim();
    const guideline = document.getElementById('subtask-guideline').value.trim();
    const description = document.getElementById('subtask-desc').value.trim();
    const status = document.getElementById('subtask-status').value;
    const priority = document.getElementById('subtask-priority').value;
    const end_date = document.getElementById('subtask-end-date').value;
    const parent_id = document.getElementById('subtask-parent-id').value;
    // ìƒìœ„ Taskì˜ mentorship_id, week, orderë„ ì „ë‹¬
    const mentorship_id = currentTask.mentorship_id || (currentTask.mentorship_id_id || null);
    const week = currentTask.week;
    const order = null;
    if (!title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
    try {
      const resp = await fetch(`/mentee/create_subtask/${parent_id}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': (document.querySelector('input[name=csrfmiddlewaretoken]')||{}).value || ''
        },
        body: JSON.stringify({title, guideline, description, status, priority, end_date, mentorship_id, week, order})
      });
      const data = await resp.json();
      if (data.success) {
        alert('í•˜ìœ„ í…ŒìŠ¤í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        subtaskModal.style.display = 'none';
        // í•„ìš”ì‹œ ìƒì„¸ì •ë³´ ê°±ì‹ 
        if (currentTask && currentTask.id) fetchAndUpdateDetail(currentTask.id);
      } else {
        alert('ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì˜¤ë¥˜'));
      }
    } catch (err) {
      alert('ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + err);
    }
  });
  const cards = document.querySelectorAll('.task-card');
  let currentTask = null; // í˜„ì¬ ì„ íƒëœ task ì •ë³´ ì €ì¥
  function updateDetailFromData(task) {
    currentTask = task;
    // ìƒíƒœ ë±ƒì§€ ìƒ‰ìƒ
    let statusClass = '';
    if (task.status === 'ì§„í–‰ ì „') statusClass = 'not-started';
    else if (task.status === 'ì§„í–‰ ì¤‘') statusClass = 'in-progress';
    else if (task.status === 'ê²€í†  ìš”ì²­') statusClass = 'review-requested';
    else if (task.status === 'ì™„ë£Œ' || task.status === 'ì™„ë£Œë¨') statusClass = 'done';
    // ìš°ì¸¡ ì˜ì—­ ê°±ì‹  (ê¸°ì¡´ ì½”ë“œ ...)
    const titleEl = document.getElementById('detail-title');
    titleEl.innerHTML = `<span class="status-badge ${statusClass}">${task.status}</span> <span class="${statusClass === 'done' ? 'done' : ''}">${task.title}</span>`;
    const xpEl = document.getElementById('detail-xp');
    if (xpEl) xpEl.innerHTML = '';
    // guidelineì´ null/ë¹ˆê°’ì´ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
    const descEl = document.getElementById('detail-desc');
    if (task.guideline && String(task.guideline).trim() !== '') {
      descEl.textContent = task.guideline;
      descEl.style.display = '';
    } else {  
      descEl.textContent = '';
      descEl.style.display = 'none';
    }
    // ë‚œì´ë„/ë””ë°ì´ ë©”íƒ€
    const metaRow = document.querySelector('.task-detail-meta-row');
    let badgeClass = 'yellow';
    if (task.priority === 'ìƒ') badgeClass = 'red';
    else if (task.priority === 'ì¤‘') badgeClass = 'green';
    metaRow.innerHTML = `<span class="task-badge ${badgeClass}" id="detail-badge">${task.priority || 'í•˜'}</span> <span class="d-day-badge">${task.end_date || ''}</span>`;
    // descriptionì„ ë¦¬ìŠ¤íŠ¸ë¡œ í‘œì‹œ
    const listDiv = document.getElementById('detail-list');
    listDiv.innerHTML = '';
    if (task.description) {
      const items = String(task.description).split('\n').filter(x => x.trim() !== '');
      const ul = document.createElement('ul');
      items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        ul.appendChild(li);
      });
      listDiv.appendChild(ul);
    } else if (task.desc) {
      const ul = document.createElement('ul');
      const li = document.createElement('li');
      li.textContent = task.desc;
      ul.appendChild(li);
      listDiv.appendChild(ul);
    }
    // ëŒ“ê¸€ ëª©ë¡ í‘œì‹œ
    const chatMsgDiv = document.getElementById('chat-messages');
    if (chatMsgDiv) {
      chatMsgDiv.innerHTML = '';
      if (task.memos && Array.isArray(task.memos) && task.memos.length > 0) {
        task.memos.forEach(memo => {
          const msgDiv = document.createElement('div');
          msgDiv.className = 'chat-message';
          msgDiv.innerHTML = `
            <span class="chat-user">${memo.user}</span>
            <span class="chat-text">${memo.comment}</span>
            <span class="chat-time">${memo.create_date}</span>
          `;
          chatMsgDiv.appendChild(msgDiv);
        });
      } else {
        chatMsgDiv.innerHTML = '<div style="color:#888; font-size:15px;">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
    }
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    const chatInput = document.getElementById('chat-input');
    if (chatInput) chatInput.value = '';
  }
  // ëŒ“ê¸€ ì‘ì„±
  const chatSendBtn = document.getElementById('chat-send-btn');
  const chatInput = document.getElementById('chat-input');
  if (chatSendBtn && chatInput) {
    chatSendBtn.addEventListener('click', async function() {
      if (!currentTask || !chatInput.value.trim()) return;
      const comment = chatInput.value.trim();
      try {
        const resp = await fetch(`/mentee/task_comment/${currentTask.id}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': (document.querySelector('input[name=csrfmiddlewaretoken]')||{}).value || ''
          },
          body: JSON.stringify({comment})
        });
        const data = await resp.json();
        if (data.success && data.memo) {
          if (!currentTask.memos) currentTask.memos = [];
          currentTask.memos.push(data.memo);
          updateDetailFromData(currentTask);
        } else {
          alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ' + (data.error || 'ì˜¤ë¥˜'));
        }
      } catch (err) {
        alert('ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜: ' + err);
      }
    });
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        chatSendBtn.click();
      }
    });
  }

  // ì¢Œì¸¡ Task ì¹´ë“œ í´ë¦­ ì‹œ ìƒì„¸/ëŒ“ê¸€ ë™ì  ê°±ì‹ 
  cards.forEach(card => {
    card.addEventListener('click', async function() {
      const taskId = this.dataset.taskId || this.getAttribute('data-task-id');
      if (!taskId) return;
      try {
        const resp = await fetch(`/mentee/task_detail/${taskId}/`);
        const data = await resp.json();
        if (data.success && data.task) {
          updateDetailFromData(data.task);
        }
      } catch (e) {
        alert('ìƒì„¸ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      }
    });
  });

  // ìµœì´ˆ ë¡œë”© ì‹œ ì²« ë²ˆì§¸ Task ì„ íƒ
  if (cards.length > 0) {
    const firstCard = cards[0];
    const taskId = firstCard.dataset.taskId || firstCard.getAttribute('data-task-id');
    if (taskId) {
      fetch(`/mentee/task_detail/${taskId}/`).then(resp => resp.json()).then(data => {
        if (data.success && data.task) updateDetailFromData(data.task);
      });
    }
  }
  // í¸ì§‘ í¼ í† ê¸€ ë° ì €ì¥/ì·¨ì†Œ
  const editBtn = document.getElementById('task-edit-btn');
  const editForm = document.getElementById('task-edit-form');
  const descDiv = document.getElementById('detail-desc');
  const listDiv = document.getElementById('detail-list');
  const editStatus = document.getElementById('edit-status');
  const editTitle = document.getElementById('edit-title');
  const editGuideline = document.getElementById('edit-guideline');
  const editDescription = document.getElementById('edit-description');
  const editPriority = document.getElementById('edit-priority');
  const editEndDate = document.getElementById('edit-end-date');
  const saveBtn = document.getElementById('edit-save-btn');
  const cancelBtn = document.getElementById('edit-cancel-btn');
  let isEditing = false;

  function showEditForm() {
    if (!currentTask) return;
    // ê¸°ì¡´ ì˜ì—­ ìˆ¨ê¹€
    document.getElementById('detail-header-row').style.display = 'none';
    document.getElementById('detail-meta-row').style.display = 'none';
    // ê¸°ì¡´ ê°’ ì„¸íŒ…
    editStatus.value = currentTask.status || 'ì§„í–‰ ì „';
    editTitle.value = currentTask.title || '';
    editGuideline.value = currentTask.guideline || '';
    editDescription.value = currentTask.description || '';
    editPriority.value = currentTask.priority || 'í•˜';
    if (currentTask.end_date) {
      editEndDate.value = String(currentTask.end_date).slice(0, 10);
    } else {
      editEndDate.value = '';
    }
    // ê¸°ì¡´ í¼ ë¡œì§
    editForm.style.display = '';
    descDiv.style.display = 'none';
    listDiv.style.display = 'none';
    isEditing = true;
  }
  function hideEditForm() {
    editForm.style.display = 'none';
    // ìˆ¨ê²¼ë˜ ì˜ì—­ ë‹¤ì‹œ í‘œì‹œ
    document.getElementById('detail-header-row').style.display = '';
    document.getElementById('detail-meta-row').style.display = '';
    descDiv.style.display = '';
    listDiv.style.display = '';
    isEditing = false;
  }
  if (editBtn) {
    editBtn.addEventListener('click', function() {
      if (isEditing) return;
      showEditForm();
    });
  }
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function(e) {
      e.preventDefault();
      hideEditForm();
    });
  }
  if (editForm) {
    editForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      // DB ì €ì¥ AJAX
      const payload = {
        status: editStatus.value,
        title: editTitle.value,
        guideline: editGuideline.value,
        description: editDescription.value,
        priority: editPriority.value,
        end_date: editEndDate.value
      };
      try {
        const resp = await fetch(`/mentee/task_update/${currentTask.id}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': (document.querySelector('input[name=csrfmiddlewaretoken]')||{}).value || ''
          },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.success) {
          // í”„ë¡ íŠ¸ ìƒíƒœë„ ë°˜ì˜
          currentTask.status = payload.status;
          currentTask.title = payload.title;
          currentTask.guideline = payload.guideline;
          currentTask.description = payload.description;
          currentTask.priority = payload.priority;
          currentTask.end_date = payload.end_date;
          // ì¢Œì¸¡ ì¹´ë“œë„ ë™ê¸°í™”
          const card = document.querySelector(`.task-card[data-task-id="${currentTask.id}"]`);
          if (card) {
            // ìƒíƒœ ë±ƒì§€
            const statusBadge = card.querySelector('.status-badge');
            if (statusBadge) {
              statusBadge.textContent = payload.status;
              statusBadge.className = 'status-badge';
              if (payload.status === 'ì§„í–‰ ì „') statusBadge.classList.add('not-started');
              else if (payload.status === 'ì§„í–‰ ì¤‘') statusBadge.classList.add('in-progress');
              else if (payload.status === 'ê²€í†  ìš”ì²­') statusBadge.classList.add('review-requested');
              else if (payload.status === 'ì™„ë£Œ' || payload.status === 'ì™„ë£Œë¨') statusBadge.classList.add('done');
            }
            // ì œëª©
            const titleSpan = card.querySelector('.task-title');
            if (titleSpan) {
              titleSpan.textContent = payload.title;
              if (payload.status === 'ì™„ë£Œ' || payload.status === 'ì™„ë£Œë¨') titleSpan.classList.add('done');
              else titleSpan.classList.remove('done');
            }
            // ìš°ì„ ìˆœìœ„ ë±ƒì§€
            const badge = card.querySelector('.task-badge');
            if (badge) {
              badge.textContent = payload.priority || 'í•˜';
              badge.className = 'task-badge';
              if (payload.priority === 'ìƒ') badge.classList.add('red');
              else if (payload.priority === 'ì¤‘') badge.classList.add('green');
              else badge.classList.add('yellow');
            }
            // ë§ˆê°ì¼
            const dday = card.querySelector('.d-day-badge');
            if (dday) dday.textContent = payload.end_date || '';
            // ì„¤ëª…
            const descDiv = card.querySelector('.task-desc');
            if (descDiv) descDiv.textContent = payload.description || '';
            // ì¹´ë“œ ì „ì²´ í´ë˜ìŠ¤(ìƒíƒœë³„)
            card.classList.remove('not-started','in-progress','review-requested','done');
            if (payload.status === 'ì§„í–‰ ì „') card.classList.add('not-started');
            else if (payload.status === 'ì§„í–‰ ì¤‘') card.classList.add('in-progress');
            else if (payload.status === 'ê²€í†  ìš”ì²­') card.classList.add('review-requested');
            else if (payload.status === 'ì™„ë£Œ' || payload.status === 'ì™„ë£Œë¨') card.classList.add('done');
          }
          updateDetailFromData(currentTask);
          hideEditForm();
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì˜¤ë¥˜'));
        }
      } catch (err) {
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err);
      }
    });
  }
  async function fetchAndUpdateDetail(taskId) {
    try {
      const resp = await fetch(`/mentee/task_detail/${taskId}/`);
      if (!resp.ok) throw new Error('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      const data = await resp.json();
      if (data.success && data.task) {
        updateDetailFromData(data.task);
      }
    } catch (e) {
      alert('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
  }
  cards.forEach(card => {
    card.addEventListener('click', function() {
      if (isEditing) return; // í¸ì§‘ ì¤‘ì´ë©´ ì¹´ë“œ ì„ íƒ ë¹„í™œì„±í™”
      cards.forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      const taskId = card.getAttribute('data-task-id');
      if (taskId) fetchAndUpdateDetail(taskId);
    });
  });
  // ìµœì´ˆ ë¡œë”© ì‹œ ì²« ë²ˆì§¸ Task ì„ íƒ
  if (cards.length > 0) {
    const firstTaskId = cards[0].getAttribute('data-task-id');
    if (firstTaskId) fetchAndUpdateDetail(firstTaskId);
  }
});
</script>
{% endblock %}
