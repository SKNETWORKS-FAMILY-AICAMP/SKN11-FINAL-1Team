{% extends 'base.html' %}
{% load static %}

{% block title %}ÌÉúÏä§ÌÅ¨ Î™©Î°ù ÌéòÏù¥ÏßÄ{% endblock %}
{% block extra_head %}
<style>
.tasklist-container {
  display: flex;
  gap: 32px;
  width: 100%;
  min-height: 600px;
}
.tasklist-left {
  flex: 1;
  padding: 24px 0 24px 24px;
  background: #fafbfc;
  border-radius: 12px 0 0 12px;
  min-width: 340px;
  max-width: 500px;
  overflow-y: auto;
  max-height: 100vh;
}
.tasklist-title {
  font-size: 1.3em;
  font-weight: bold;
  margin-bottom: 18px;
  color: #222;
}
.tasklist-search-row {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
}
.tasklist-search {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 15px;
}
.tasklist-create-btn {
  padding: 8px 18px;
  background: #ffd600;
  color: #222;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
.tasklist-filter-btn {
  padding: 8px 18px;
  background: #e0e0e0;
  color: #222;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
.tasklist-filter-panel {
  background: #f7f7f7;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 14px 18px 10px 18px;
  margin-top: 4px;
  font-size: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
}
.filter-group {
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.filter-label {
  font-weight: bold;
  margin-right: 8px;
}
.filter-group label {
  margin-right: 8px;
  font-weight: normal;
}
.filter-dday-sort {
  background: #fff;
  border: 1px solid #bbb;
  border-radius: 4px;
  padding: 2px 8px;
  margin-left: 2px;
  cursor: pointer;
  font-size: 15px;
}
.filter-dday-sort.active {
  background: #ffd600;
  color: #222;
  border-color: #ffd600;
}
.task-card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  margin-bottom: 18px;
  padding: 18px 20px 14px 20px;
  border-left: 6px solid #ffd600;
  transition: box-shadow 0.2s, border-color 0.2s;
  cursor: pointer;
  position: relative;
}
.task-card.in-progress { border-left-color: #4caf50; }
.task-card.done { border-left-color: #ffd600; background: #f6fff6; }
.task-card.selected { box-shadow: 0 0 0 3px #1976d233; border-left-color: #1976d2; }
.task-card.not-started { border-left-color: #f44336; }
.task-card.review-requested { border-left-color: #ffd600; }
.task-title {
  color: #222;
}
.task-title.done {
  text-decoration: line-through;
  color: #aaa;
}
.task-title.d-day {
  margin-right: 8px;
  text-align: left;
  display: inline-block;
}
.task-card-header {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  font-size: 17px;
  font-weight: bold;
  margin-bottom: 6px;
  gap: 10px;
}
.task-xp { color: #888; font-size: 15px; display: flex; align-items: center; gap: 4px; }
.icon-trophy { width: 18px; height: 18px; vertical-align: middle; }
.task-desc { color: #555; font-size: 14px; margin-bottom: 8px; }
.task-desc-row { margin-bottom: 8px; }
.task-meta-row {
  display: flex;
  gap: 10px;
  align-items: center;
  font-size: 13px;
  margin-bottom: 4px;
}
.task-week { color: #666; }
.task-badge {
  padding: 2px 10px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: bold;
  color: #fff;
  display: inline-block;
}
.task-badge.red { background: #f44336; color: #fff; }
.task-badge.green { background: #4caf50; color: #fff; }
.task-badge.yellow { background: #ffd600 !important; color: #222 !important; }

.status-badge {
  display: inline-block;
  min-width: 60px;
  padding: 2px 12px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: bold;
  color: #fff;
  margin-right: 10px;
  vertical-align: middle;
}
.status-badge.not-started { background: #888; }
.status-badge.in-progress { background: #1976d2; }
.status-badge.review-requested { background: #f44336; }
.status-badge.done { background: #43a047; }

.subtask-toggle {
  display: flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  margin: 0 0 0 6px;
  font-size: 18px;
  color: #222;
  user-select: none;
}
.subtask-list {
  margin: 0 0 0 32px;
  padding: 0;
  border: 1px solid #bbb;
  border-radius: 8px;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  margin-bottom: 10px;
  display: none;
}
.subtask-list.open { display: block; }
.subtask-card {
  padding: 12px 16px 10px 16px;
  border-bottom: 1px solid #eee;
  font-size: 15px;
  cursor: pointer;
}
.subtask-card:last-child { border-bottom: none; }
.subtask-title { font-weight: bold; font-size: 15px; margin-bottom: 2px; display: block; }
.subtask-desc { color: #555; font-size: 13px; margin-bottom: 4px; }
.subtask-meta-row {
  display: flex;
  gap: 8px;
  align-items: center;
  font-size: 12px;
}
.subtask-week { color: #666; }
.subtask-badge {
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: bold;
  color: #fff;
  display: inline-block;
}
.subtask-badge.green { background: #4caf50; }
.subtask-badge.yellow { background: #ffd600 !important; color: #222 !important; }

.tasklist-right {
  flex: 2;
  background: #fff;
  border-radius: 0 16px 16px 0;
  padding: 36px 48px 32px 48px;
  min-width: 600px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  display: flex;
  flex-direction: column;
  position: relative;
  z-index: 10;
}
.task-detail-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  font-size: 26px;
  font-weight: bold;
  margin-bottom: 8px;
}
.task-detail-title { color: #222; font-size: 26px; font-weight: bold; }
.task-detail-xp { color: #888; font-size: 18px; display: flex; align-items: center; gap: 4px; font-weight: bold; }
.task-detail-desc { color: #222; font-size: 17px; margin-bottom: 12px; margin-top: 8px; }
.task-detail-meta-row {
  display: flex;
  gap: 14px;
  align-items: center;
  font-size: 15px;
  margin-bottom: 12px;
}
.task-detail-divider {
  border: none;
  border-top: 1.5px solid #e0e0e0;
  margin: 18px 0 24px 0;
}
.task-detail-list {
  margin: 0 0 24px 0;
  padding-left: 0;
  color: #222;
  font-size: 17px;
  list-style: none;
}
.task-detail-list ul {
  margin: 0 0 24px 0;
  padding-left: 0;
  color: #222;
  font-size: 17px;
  list-style: none;
}
.task-detail-list ul li {
  margin-bottom: 6px;
  font-weight: 500;
}
.task-detail-chat {
  margin-top: auto;
  background: #fafafa;
  border-radius: 12px;
  padding: 24px 24px 18px 24px;
  margin-top: 32px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.03);
}
.chat-message {
  margin-bottom: 14px;
  font-size: 15px;
  display: flex;
  flex-direction: column;
}
.chat-message .chat-user {
  font-weight: bold;
  color: #43a047;
  margin-bottom: 2px;
}
.chat-message.mine .chat-user { color: #1976d2; }
.chat-message .chat-text { color: #222; margin-bottom: 2px; }
.chat-message .chat-time { color: #aaa; font-size: 12px; }
.chat-input-row {
  display: flex;
  gap: 8px;
  margin-top: 18px;
}
.chat-input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 16px;
  background: #fff;
}
.chat-send-btn {
  padding: 0 24px;
  background: #ffd600;
  color: #222;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
</style>
{% endblock %}
{% block content %}
<div class="tasklist-container">
<<<<<<< Updated upstream
  <!-- Ï¢åÏ∏°: ÌÄòÏä§Ìä∏ Î™©Î°ù -->
  <div class="tasklist-left" id="tasklist-left">
    <div class="tasklist-title">Task Î™©Î°ù</div>
    <div class="tasklist-search-row">
      <input type="text" class="tasklist-search" placeholder="Task Í≤ÄÏÉâ...">
      <button class="tasklist-filter-btn">ÌïÑÌÑ∞</button>
    </div>
    <div class="tasklist-filter-panel" style="display:none; margin-bottom:18px;">
      <div class="filter-group">
        <span class="filter-label">ÎÇúÏù¥ÎèÑ:</span>
        <label><input type="checkbox" class="filter-diff" value="ÏÉÅ"> ÏÉÅ</label>
        <label><input type="checkbox" class="filter-diff" value="Ï§ë"> Ï§ë</label>
        <label><input type="checkbox" class="filter-diff" value="Ìïò"> Ìïò</label>
      </div>
      <div class="filter-group">
        <span class="filter-label">ÏÉÅÌÉú:</span>
        <label><input type="checkbox" class="filter-status" value="ÏßÑÌñâ Ï†Ñ"> ÏßÑÌñâ Ï†Ñ</label>
        <label><input type="checkbox" class="filter-status" value="ÏßÑÌñâ Ï§ë"> ÏßÑÌñâ Ï§ë</label>
        <label><input type="checkbox" class="filter-status" value="Í≤ÄÌÜ† ÏöîÏ≤≠"> Í≤ÄÌÜ†ÏöîÏ≤≠</label>
        <label><input type="checkbox" class="filter-status" value="ÏôÑÎ£åÎê®"> ÏôÑÎ£å</label>
      </div>
      <div class="filter-group">
        <span class="filter-label">D-day Ï†ïÎ†¨:</span>
        <button class="filter-dday-sort" data-order="desc">‚ñº</button>
      </div>
    </div>
    <div class="task-card not-started" data-detail="0">
      <div class="task-card-header">
        <span class="status-badge not-started">ÏßÑÌñâ Ï†Ñ</span>
        <span class="task-title d-day">Ïò®Î≥¥Îî© Í∞ÄÏù¥Îìú ÏùΩÍ∏∞</span>
        <span class="task-xp"><span class="icon-trophy" style="font-size:15px;">üèÜ</span> 20 XP</span>
      </div>
      <div class="task-desc-row">
        <div class="task-desc">ÌöåÏÇ¨ Ïò®Î≥¥Îî© Í∞ÄÏù¥Îìú Î¨∏ÏÑúÎ•º ÏùΩÍ≥†, Í∂ÅÍ∏àÌïú Ï†êÏùÑ Ï†ïÎ¶¨Ìï¥Î≥¥ÏÑ∏Ïöî.</div>
        <div class="task-meta-row">
          <span class="task-badge yellow">Ìïò</span>
          <span class="d-day-badge">D-5</span>
=======
  <!-- Ï¢åÏ∏°: Task Î™©Î°ù -->
<div class="tasklist-left" id="tasklist-left">
  <div class="tasklist-title">Task Î™©Î°ù</div>
  {% for week, tasks in week_tasks.items %}
    <div style="font-weight:bold; margin:18px 0 8px 0; color:#1976d2;">{{ week }}Ï£ºÏ∞®</div>
    {% for task in tasks %}
      <div class="task-card {% if forloop.first and forloop.parentloop.first %}selected{% endif %} {% if task.status == 'ÏßÑÌñâ Ï†Ñ' %}not-started{% elif task.status == 'ÏßÑÌñâ Ï§ë' %}in-progress{% elif task.status == 'Í≤ÄÌÜ† ÏöîÏ≤≠' %}review-requested{% elif task.status == 'ÏôÑÎ£å' or task.status == 'ÏôÑÎ£åÎê®' %}done{% endif %}"
        data-task-id="{{ task.id }}"
        data-title="{{ task.title|escapejs }}"
        data-desc="{{ task.desc|default_if_none:''|escapejs }}"
        data-priority="{{ task.priority|default:'Ìïò'|escapejs }}"
        data-status="{{ task.status|escapejs }}"
        data-end_date="{{ task.end_date|date:'Y-m-d' }}"
        data-week="{{ week }}"
        >
        <div class="task-card-header">
          <span class="status-badge {% if task.status == 'ÏßÑÌñâ Ï†Ñ' %}not-started{% elif task.status == 'ÏßÑÌñâ Ï§ë' %}in-progress{% elif task.status == 'Í≤ÄÌÜ† ÏöîÏ≤≠' %}review-requested{% elif task.status == 'ÏôÑÎ£å' or task.status == 'ÏôÑÎ£åÎê®' %}done{% endif %}">{{ task.status }}</span>
          <span class="task-title {% if task.status == 'ÏôÑÎ£å' or task.status == 'ÏôÑÎ£åÎê®' %}done{% endif %}">{{ task.title }}</span>
        </div>
        <div class="task-desc-row">
          <div class="task-desc">{{ task.desc }}</div>
          <div class="task-meta-row">
            <span class="task-badge {% if task.priority == 'ÏÉÅ' %}red{% elif task.priority == 'Ï§ë' %}green{% else %}yellow{% endif %}">{{ task.priority|default:'Ìïò' }}</span>
            <span class="d-day-badge">{{ task.end_date|date:'Y-m-d' }}</span>
          </div>
>>>>>>> Stashed changes
        </div>
      </div>
      <div class="subtask-toggle" data-toggle="0">‚ñº</div>
      <div class="subtask-list" id="subtask-list-0">
        <div class="subtask-card" data-detail="0-0">
          <span class="subtask-title">Í∞ÄÏù¥Îìú Î¨∏ÏÑú Îã§Ïö¥Î°úÎìú</span>
          <span class="subtask-desc">ÏµúÏã† Ïò®Î≥¥Îî© Í∞ÄÏù¥Îìú PDF Î∞õÍ∏∞</span>
          <div class="subtask-meta-row"><span class="subtask-badge yellow">Ìïò</span></div>
        </div>
        <div class="subtask-card" data-detail="0-1">
          <span class="subtask-title">Ï§ëÏöî ÎÇ¥Ïö© Ï†ïÎ¶¨</span>
          <span class="subtask-desc">ÌïµÏã¨ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏûëÏÑ±</span>
          <div class="subtask-meta-row"><span class="subtask-badge yellow">Ìïò</span></div>
        </div>
      </div>
    </div>
    <div class="task-card in-progress selected" data-detail="1">
      <div class="task-card-header">
        <span class="status-badge in-progress">ÏßÑÌñâ Ï§ë</span>
        <span class="task-title d-day">ÌöåÏÇ¨ ÏÜåÍ∞ú Î∞è Ï°∞ÏßÅÎèÑ Ïù¥Ìï¥ÌïòÍ∏∞</span>
        <span class="task-xp"><span class="icon-trophy" style="font-size:15px;">üèÜ</span> 50 XP</span>
      </div>
      <div class="task-desc-row">
        <div class="task-desc">ÌöåÏÇ¨ Ï°∞ÏßÅ Íµ¨Ï°∞ÏôÄ Í∞Å Î∂ÄÏÑú Ïó≠Ìï†ÏùÑ ÌååÏïÖÌïòÍ≥†, ÌåÄÏõêÎì§Í≥º Ï≤´ Ïù∏ÏÇ¨Î•º ÎÇòÎà†Î≥¥ÏÑ∏Ïöî.</div>
        <div class="task-meta-row">
          <span class="task-badge green">Ï§ë</span>
          <span class="d-day-badge">D-2</span>
        </div>
      </div>
      <div class="subtask-toggle" data-toggle="1">‚ñº</div>
      <div class="subtask-list" id="subtask-list-1">
        <div class="subtask-card" data-detail="1-0">
          <span class="subtask-title">Ï°∞ÏßÅÎèÑ Ïó¥Îûå</span>
          <span class="subtask-desc">ÏÇ¨ÎÇ¥ Ïù∏Ìä∏ÎùºÎÑ∑ÏóêÏÑú Ï°∞ÏßÅÎèÑ ÌôïÏù∏</span>
          <div class="subtask-meta-row"><span class="subtask-badge green">Ï§ë</span></div>
        </div>
        <div class="subtask-card" data-detail="1-1">
          <span class="subtask-title">ÌåÄÏõê Ïù∏ÏÇ¨</span>
          <span class="subtask-desc">ÌåÄ Ï±ÑÌåÖÎ∞©ÏóêÏÑú ÏûêÍ∏∞ÏÜåÍ∞ú ÎÇ®Í∏∞Í∏∞</span>
          <div class="subtask-meta-row"><span class="subtask-badge green">Ï§ë</span></div>
        </div>
      </div>
    </div>
    <div class="task-card review-requested" data-detail="2">
      <div class="task-card-header">
        <span class="status-badge review-requested">Í≤ÄÌÜ†ÏöîÏ≤≠</span>
        <span class="task-title d-day">ÏóÖÎ¨¥ ÌîÑÎ°úÏÑ∏Ïä§ Ïã§Ïäµ</span>
        <span class="task-xp"><span class="icon-trophy" style="font-size:15px;">üèÜ</span> 80 XP</span>
      </div>
      <div class="task-desc-row">
        <div class="task-desc">Ïã§Ï†ú Í≤∞Ïû¨/Î≥¥Í≥† ÌîÑÎ°úÏÑ∏Ïä§Î•º Í≤ΩÌóòÌïòÍ≥†, ÌîºÎìúÎ∞±ÏùÑ Î∞õÏïÑÎ≥¥ÏÑ∏Ïöî.</div>
        <div class="task-meta-row">
          <span class="task-badge red">ÏÉÅ</span>
          <span class="d-day-badge">D-1</span>
        </div>
      </div>
      <div class="subtask-toggle" data-toggle="2">‚ñº</div>
      <div class="subtask-list" id="subtask-list-2">
        <div class="subtask-card" data-detail="2-0">
          <span class="subtask-title">ÏóÖÎ¨¥ ÏöîÏ≤≠ÏÑú ÏûëÏÑ±</span>
          <span class="subtask-desc">ÏóÖÎ¨¥ ÏöîÏ≤≠ÏÑú ÏñëÏãùÏóê ÎßûÍ≤å ÏûëÏÑ±</span>
          <div class="subtask-meta-row"><span class="subtask-badge red">ÏÉÅ</span></div>
        </div>
        <div class="subtask-card" data-detail="2-1">
          <span class="subtask-title">Í≤∞Ïû¨ ÌîÑÎ°úÏÑ∏Ïä§ Í≤ΩÌóò</span>
          <span class="subtask-desc">Í≤∞Ïû¨ ÏöîÏ≤≠ Î∞è ÏäπÏù∏ Í≤ΩÌóò</span>
          <div class="subtask-meta-row"><span class="subtask-badge red">ÏÉÅ</span></div>
        </div>
        <div class="subtask-card" data-detail="2-2">
          <span class="subtask-title">ÌîºÎìúÎ∞± Ï†ïÎ¶¨</span>
          <span class="subtask-desc">Î©òÌÜ† ÌîºÎìúÎ∞± Ï†ïÎ¶¨ Î∞è Í∞úÏÑ†Ï†ê ÎèÑÏ∂ú</span>
          <div class="subtask-meta-row"><span class="subtask-badge red">ÏÉÅ</span></div>
        </div>
      </div>
    </div>
    <div class="task-card done" data-detail="3">
      <div class="task-card-header">
        <span class="status-badge done">ÏôÑÎ£å</span>
        <span class="task-title d-day done">Ï≤´ Î≤àÏß∏ ÌîÑÎ°úÏ†ùÌä∏ Ï∞∏Ïó¨ÌïòÍ∏∞</span>
        <span class="task-xp"><span class="icon-trophy" style="font-size:15px;">üèÜ</span> 100 XP</span>
      </div>
      <div class="task-desc-row">
        <div class="task-desc">ÌåÄ ÌîÑÎ°úÏ†ùÌä∏Ïóê ÏßÅÏ†ë Ï∞∏Ïó¨ÌïòÏó¨ Ïã§Î¨¥ Í≤ΩÌóòÏùÑ ÏåìÍ≥†, Í≤∞Í≥ºÎ•º Í≥µÏú†ÌïòÏÑ∏Ïöî.</div>
        <div class="task-meta-row">
          <span class="task-badge red">ÏÉÅ</span>
          <span class="d-day-badge">D-DAY</span>
        </div>
      </div>
      <div class="subtask-toggle" data-toggle="3">‚ñº</div>
      <div class="subtask-list" id="subtask-list-3">
        <div class="subtask-card" data-detail="3-0">
          <span class="subtask-title">ÌîÑÎ°úÏ†ùÌä∏ ÌôòÍ≤Ω ÏÑ∏ÌåÖ</span>
          <span class="subtask-desc">Ï†ÄÏû•ÏÜå ÌÅ¥Î°†, Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò, Ï¥àÍ∏∞ ÏÑ∏ÌåÖ</span>
          <div class="subtask-meta-row"><span class="subtask-badge red">ÏÉÅ</span></div>
        </div>
        <div class="subtask-card" data-detail="3-1">
          <span class="subtask-title">Ï≤´ Ïª§Î∞ã Î∞è PR</span>
          <span class="subtask-desc">Ï≤´ Ïª§Î∞ã ÌõÑ Pull Request ÏÉùÏÑ±</span>
          <div class="subtask-meta-row"><span class="subtask-badge red">ÏÉÅ</span></div>
        </div>
      </div>
    </div>
  </div>
  <!-- Ïö∞Ï∏°: ÏÉÅÏÑ∏ Ï†ïÎ≥¥ -->
  <div class="tasklist-right">
    <div class="task-detail-header" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="display:flex; align-items:center; gap:12px;">
        <span class="task-detail-title" id="detail-title">Ï≤´ Î≤àÏß∏ ÌîÑÎ°úÏ†ùÌä∏ Ï∞∏Ïó¨ÌïòÍ∏∞</span>
        <span class="task-detail-xp" id="detail-xp" style="color:#888; font-size:17px; display:flex; align-items:center; gap:4px; font-weight:bold;"><span class="icon-trophy" style="font-size:15px;">üèÜ</span> 100 XP</span>
      </div>
      <div style="display:flex; gap:10px; margin-left:auto;">
        <button class="task-detail-edit-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;" onclick="location.href='/common/task_add/'">Ìé∏Ïßë</button>
        <button class="task-detail-subtask-btn" style="background:#e0e0e0; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;" onclick="location.href='/common/task_add/'">ÌïòÏúÑ ÌÖåÏä§ÌÅ¨ ÏÉùÏÑ±</button>
      </div>
    </div>
    <div class="task-detail-desc" id="detail-desc">Í∞ÑÎã®Ìïú ÌîÑÎ°úÏ†ùÌä∏Ïóê Ï∞∏Ïó¨ÌïòÏó¨ ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïù¥Ìï¥ÌïòÍ∏∞</div>
    <div class="task-detail-meta-row">
      <span class="task-badge yellow" id="detail-badge">Ï§ëÍ∏â</span>
    </div>    
    <div class="task-detail-divider">
    </div>
    <div class="task-detail-list" id="detail-list">
      <ul>
        <li>ÌîÑÎ°úÏ†ùÌä∏ Ï§ÄÎπÑ</li>
        <li>Ï≤´ ÌîÑÎ°úÏ†ùÌä∏ ÏßÑÌñâ</li>
        <li>ÌîÑÎ°úÏ†ùÌä∏ Í≤∞Í≥º Í≥µÏú†</li>
      </ul>
    </div>
    <div class="task-detail-chat">
      <div class="chat-message other">
        <span class="chat-user">Ï±ÑÌåÖÎ¥á</span>
        <span class="chat-text">Í≤åÏãúÍ∏ÄÏùÄ 4Ï£ºÏ∞®ÍπåÏßÄ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§. Í≥ÑÏÜç ÌôïÏù∏ Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§.</span>
        <span class="chat-time">2025.06.25. 01:41</span>
      </div>
      <div class="chat-message mine">
        <span class="chat-user">Î©òÌÜ†Ïú†Ìòï</span>
        <span class="chat-text">ÏôÑÎ£åÌïòÏòÄÏúºÎ©∞, Îã§ÏùåÍ≥ºÏ†úÎèÑ Í∏∞ÎåÄÌïòÍ≤†ÏäµÎãàÎã§.</span>
        <span class="chat-time">2025.06.25. 01:45</span>
      </div>
      <div class="chat-input-row">
        <input type="text" class="chat-input" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•...">
        <button class="chat-send-btn"><span style="font-size:20px;">üí¨</span></button>
      </div>
    </div>
  </div>
</div>
<script>
<<<<<<< Updated upstream
// Ïπ¥ÎìúÎ≥Ñ ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞ ÏÉòÌîå
const details = [
  {
    title: 'Ïò®Î≥¥Îî© Í∞ÄÏù¥Îìú ÏùΩÍ∏∞',
    xp: '20 XP',
    desc: 'ÌöåÏÇ¨ Ïò®Î≥¥Îî© Í∞ÄÏù¥Îìú Î¨∏ÏÑúÎ•º ÏùΩÍ≥†, Í∂ÅÍ∏àÌïú Ï†êÏùÑ Ï†ïÎ¶¨Ìï¥Î≥¥ÏÑ∏Ïöî.',
    badge: { text: 'Ìïò', color: 'yellow' },
    status: 'ÏßÑÌñâ Ï†Ñ',
    list: ['Í∞ÄÏù¥Îìú Î¨∏ÏÑú Îã§Ïö¥Î°úÎìú', 'Ï§ëÏöî ÎÇ¥Ïö© Ï†ïÎ¶¨', 'ÏßàÎ¨∏ Î¶¨Ïä§Ìä∏ ÏûëÏÑ±'],
    subtasks: [
      {
        title: 'Í∞ÄÏù¥Îìú Î¨∏ÏÑú Îã§Ïö¥Î°úÎìú',
        desc: 'ÏµúÏã† Ïò®Î≥¥Îî© Í∞ÄÏù¥Îìú PDF Î∞õÍ∏∞',
        badge: { text: 'Ìïò', color: 'yellow' },
        status: 'ÏßÑÌñâ Ï†Ñ',
        list: [],
      },
      {
        title: 'Ï§ëÏöî ÎÇ¥Ïö© Ï†ïÎ¶¨',
        desc: 'ÌïµÏã¨ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏûëÏÑ±',
        badge: { text: 'Ìïò', color: 'yellow' },
        status: 'ÏßÑÌñâ Ï†Ñ',
        list: [],
      },
      {
        title: 'ÏßàÎ¨∏ Î¶¨Ïä§Ìä∏ ÏûëÏÑ±',
        desc: 'Í∂ÅÍ∏àÌïú Ï†êÏùÑ 3Í∞ú Ïù¥ÏÉÅ Ï†ïÎ¶¨',
        badge: { text: 'Ìïò', color: 'yellow' },
        status: 'ÏßÑÌñâ Ï†Ñ',
        list: [],
      },
    ],
    comments: [
      { user: 'Î©òÌÜ†A', text: 'Í∞ÄÏù¥ÎìúÏóêÏÑú Ìó∑Í∞àÎ¶¨Îäî Î∂ÄÎ∂Ñ ÏûàÏúºÎ©¥ ÏßàÎ¨∏ ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî!', time: '2025.07.01 09:12' },
      { user: 'ÎÇò', text: 'ÎÑ§! ÏùΩÍ≥† Í∂ÅÍ∏àÌïú Ï†ê Ï†ïÎ¶¨Ìï¥ÏÑú Ïò¨Î¶¥Í≤åÏöî.', time: '2025.07.01 09:15' },
    ],
  },
  {
    title: 'ÌöåÏÇ¨ ÏÜåÍ∞ú Î∞è Ï°∞ÏßÅÎèÑ Ïù¥Ìï¥ÌïòÍ∏∞',
    xp: '50 XP',
    desc: 'ÌöåÏÇ¨ Ï°∞ÏßÅ Íµ¨Ï°∞ÏôÄ Í∞Å Î∂ÄÏÑú Ïó≠Ìï†ÏùÑ ÌååÏïÖÌïòÍ≥†, ÌåÄÏõêÎì§Í≥º Ï≤´ Ïù∏ÏÇ¨Î•º ÎÇòÎà†Î≥¥ÏÑ∏Ïöî.',
    badge: { text: 'Ï§ë', color: 'green' },
    status: 'ÏßÑÌñâ Ï§ë',
    list: ['Ï°∞ÏßÅÎèÑ Ïó¥Îûå', 'ÌåÄÏõê Ïù∏ÏÇ¨', 'ÌöåÏÇ¨ ÎπÑÏ†Ñ Í≥µÏú†'],
    subtasks: [
      {
        title: 'Ï°∞ÏßÅÎèÑ Ïó¥Îûå',
        desc: 'ÏÇ¨ÎÇ¥ Ïù∏Ìä∏ÎùºÎÑ∑ÏóêÏÑú Ï°∞ÏßÅÎèÑ ÌôïÏù∏',
        badge: { text: 'Ï§ë', color: 'green' },
        status: 'ÏßÑÌñâ Ï§ë',
        list: [],
      },
      {
        title: 'ÌåÄÏõê Ïù∏ÏÇ¨',
        desc: 'ÌåÄ Ï±ÑÌåÖÎ∞©ÏóêÏÑú ÏûêÍ∏∞ÏÜåÍ∞ú ÎÇ®Í∏∞Í∏∞',
        badge: { text: 'Ï§ë', color: 'green' },
        status: 'ÏßÑÌñâ Ï§ë',
        list: [],
      },
    ],
    comments: [
      { user: 'ÌåÄÏû•', text: 'ÌåÄ Ï±ÑÌåÖÎ∞©Ïóê ÏûêÍ∏∞ÏÜåÍ∞ú ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî~', time: '2025.07.02 10:00' },
      { user: 'ÎÇò', text: 'ÎÑ§! Î∞©Í∏à Ïù∏ÏÇ¨ ÎÇ®Í≤ºÏäµÎãàÎã§.', time: '2025.07.02 10:05' },
    ],
  },
  {
    title: 'ÏóÖÎ¨¥ ÌîÑÎ°úÏÑ∏Ïä§ Ïã§Ïäµ',
    xp: '80 XP',
    desc: 'Ïã§Ï†ú Í≤∞Ïû¨/Î≥¥Í≥† ÌîÑÎ°úÏÑ∏Ïä§Î•º Í≤ΩÌóòÌïòÍ≥†, ÌîºÎìúÎ∞±ÏùÑ Î∞õÏïÑÎ≥¥ÏÑ∏Ïöî.',
    badge: { text: 'ÏÉÅ', color: 'red' },
    status: 'Í≤ÄÌÜ† ÏöîÏ≤≠',
    list: ['ÏóÖÎ¨¥ ÏöîÏ≤≠ÏÑú ÏûëÏÑ±', 'Í≤∞Ïû¨ ÌîÑÎ°úÏÑ∏Ïä§ Í≤ΩÌóò', 'ÌîºÎìúÎ∞± Ï†ïÎ¶¨'],
    subtasks: [
      {
        title: 'ÏóÖÎ¨¥ ÏöîÏ≤≠ÏÑú ÏûëÏÑ±',
        desc: 'ÏóÖÎ¨¥ ÏöîÏ≤≠ÏÑú ÏñëÏãùÏóê ÎßûÍ≤å ÏûëÏÑ±',
        badge: { text: 'ÏÉÅ', color: 'red' },
        status: 'ÏßÑÌñâ Ï§ë',
        list: [],
      },
      {
        title: 'Í≤∞Ïû¨ ÌîÑÎ°úÏÑ∏Ïä§ Í≤ΩÌóò',
        desc: 'Í≤∞Ïû¨ ÏöîÏ≤≠ Î∞è ÏäπÏù∏ Í≤ΩÌóò',
        badge: { text: 'ÏÉÅ', color: 'red' },
        status: 'ÏßÑÌñâ Ï§ë',
        list: [],
      },
      {
        title: 'ÌîºÎìúÎ∞± Ï†ïÎ¶¨',
        desc: 'Î©òÌÜ† ÌîºÎìúÎ∞± Ï†ïÎ¶¨ Î∞è Í∞úÏÑ†Ï†ê ÎèÑÏ∂ú',
        badge: { text: 'ÏÉÅ', color: 'red' },
        status: 'ÏßÑÌñâ Ï§ë',
        list: [],
      },
    ],
    comments: [
      { user: 'Î©òÌÜ†B', text: 'Í≤∞Ïû¨ ÌîÑÎ°úÏÑ∏Ïä§ÏóêÏÑú Ïñ¥Î†§Ïö¥ Ï†ê ÏûàÏúºÎ©¥ ÏïåÎ†§Ï£ºÏÑ∏Ïöî.', time: '2025.07.03 14:20' },
      { user: 'ÎÇò', text: 'Í≤∞Ïû¨ ÏäπÏù∏ Ï†àÏ∞®Í∞Ä ÏÉùÍ∞ÅÎ≥¥Îã§ Î≥µÏû°ÌïòÎÑ§Ïöî. Ï†ïÎ¶¨Ìï¥ÏÑú Í≥µÏú†ÎìúÎ¶¥Í≤åÏöî.', time: '2025.07.03 14:25' },
    ],
  },
  {
    title: 'Ï≤´ Î≤àÏß∏ ÌîÑÎ°úÏ†ùÌä∏ Ï∞∏Ïó¨ÌïòÍ∏∞',
    xp: '100 XP',
    desc: 'ÌåÄ ÌîÑÎ°úÏ†ùÌä∏Ïóê ÏßÅÏ†ë Ï∞∏Ïó¨ÌïòÏó¨ Ïã§Î¨¥ Í≤ΩÌóòÏùÑ ÏåìÍ≥†, Í≤∞Í≥ºÎ•º Í≥µÏú†ÌïòÏÑ∏Ïöî.',
    badge: { text: 'ÏÉÅ', color: 'red' },
    status: 'ÏôÑÎ£åÎê®',
    list: ['ÌîÑÎ°úÏ†ùÌä∏ ÌôòÍ≤Ω ÏÑ∏ÌåÖ', 'Ï≤´ Ïª§Î∞ã Î∞è PR', 'Í≤∞Í≥º Î∞úÌëú'],
    subtasks: [
      {
        title: 'ÌîÑÎ°úÏ†ùÌä∏ ÌôòÍ≤Ω ÏÑ∏ÌåÖ',
        desc: 'Ï†ÄÏû•ÏÜå ÌÅ¥Î°†, Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò, Ï¥àÍ∏∞ ÏÑ∏ÌåÖ',
        badge: { text: 'ÏÉÅ', color: 'red' },
        status: 'ÏßÑÌñâ Ï§ë',
        list: [],
      },
      {
        title: 'Ï≤´ Ïª§Î∞ã Î∞è PR',
        desc: 'Ï≤´ Ïª§Î∞ã ÌõÑ Pull Request ÏÉùÏÑ±',
        badge: { text: 'ÏÉÅ', color: 'red' },
        status: 'ÏßÑÌñâ Ï§ë',
        list: [],
      },
    ],
    comments: [
      { user: 'Î©òÌÜ†C', text: 'ÌîÑÎ°úÏ†ùÌä∏ Í≤∞Í≥º Î∞úÌëú ÏûêÎ£åÎèÑ Íº≠ Ï§ÄÎπÑÌï¥ Ï£ºÏÑ∏Ïöî!', time: '2025.07.04 17:00' },
      { user: 'ÎÇò', text: 'ÎÑ§, Î∞úÌëúÏûêÎ£å Ï§ÄÎπÑÌï¥ÏÑú Í≥µÏú†ÎìúÎ¶¨Í≤†ÏäµÎãàÎã§.', time: '2025.07.04 17:10' },
    ],
  },
];
=======
// CSRF ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ìï®Ïàò
function getCSRFToken() {
  // Ïó¨Îü¨ ÏÜåÏä§ÏóêÏÑú CSRF ÌÜ†ÌÅ∞ÏùÑ Ï∞æÏïÑÏÑú Î∞òÌôò
  let token = null;
  
  // 1. Ïø†ÌÇ§ÏóêÏÑú Ï∞æÍ∏∞
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    cookie = cookie.trim();
    if (cookie.startsWith('csrftoken=')) {
      token = decodeURIComponent(cookie.substring('csrftoken='.length));
      break;
    }
  }
  
  // 2. Î©îÌÉÄ ÌÉúÍ∑∏ÏóêÏÑú Ï∞æÍ∏∞
  if (!token) {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
      token = metaTag.getAttribute('content');
    }
  }
  
  // 3. ÌèºÏùò hidden inputÏóêÏÑú Ï∞æÍ∏∞
  if (!token) {
    const hiddenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (hiddenInput) {
      token = hiddenInput.value;
    }
  }
  
  return token || '';
}

// Ï¢åÏ∏° Task Ïπ¥Îìú ÌÅ¥Î¶≠ Ïãú Ïö∞Ï∏° ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Í∞±Ïã†
document.addEventListener('DOMContentLoaded', function() {
  const cards = document.querySelectorAll('.task-card');
  let currentTask = null; // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú task Ï†ïÎ≥¥ Ï†ÄÏû•
  function updateDetailFromData(task) {
    currentTask = task;
    // ÏÉÅÌÉú Î±ÉÏßÄ ÏÉâÏÉÅ
    let statusClass = '';
    if (task.status === 'ÏßÑÌñâ Ï†Ñ') statusClass = 'not-started';
    else if (task.status === 'ÏßÑÌñâ Ï§ë') statusClass = 'in-progress';
    else if (task.status === 'Í≤ÄÌÜ† ÏöîÏ≤≠') statusClass = 'review-requested';
    else if (task.status === 'ÏôÑÎ£å' || task.status === 'ÏôÑÎ£åÎê®') statusClass = 'done';
    // Ïö∞Ï∏° ÏòÅÏó≠ Í∞±Ïã†
    const titleEl = document.getElementById('detail-title');
    titleEl.innerHTML = `<span class="status-badge ${statusClass}">${task.status}</span> <span class="${statusClass === 'done' ? 'done' : ''}">${task.title}</span>`;
    const xpEl = document.getElementById('detail-xp');
    if (xpEl) xpEl.innerHTML = '';
    // guidelineÏù¥ null/ÎπàÍ∞íÏù¥Î©¥ ÌëúÏãúÌïòÏßÄ ÏïäÏùå
    const descEl = document.getElementById('detail-desc');
    if (task.guideline && String(task.guideline).trim() !== '') {
      descEl.textContent = task.guideline;
      descEl.style.display = '';
    } else {
      descEl.textContent = '';
      descEl.style.display = 'none';
    }
    // ÎÇúÏù¥ÎèÑ/ÎîîÎç∞Ïù¥ Î©îÌÉÄ
    const metaRow = document.querySelector('.task-detail-meta-row');
    let badgeClass = 'yellow';
    if (task.priority === 'ÏÉÅ') badgeClass = 'red';
    else if (task.priority === 'Ï§ë') badgeClass = 'green';
    metaRow.innerHTML = `<span class="task-badge ${badgeClass}" id="detail-badge">${task.priority || 'Ìïò'}</span> <span class="d-day-badge">${task.end_date || ''}</span>`;
    // descriptionÏùÑ Î¶¨Ïä§Ìä∏Î°ú ÌëúÏãú
    const listDiv = document.getElementById('detail-list');
    listDiv.innerHTML = '';
    if (task.description) {
      const items = String(task.description).split('\n').filter(x => x.trim() !== '');
      const ul = document.createElement('ul');
      items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        ul.appendChild(li);
      });
      listDiv.appendChild(ul);
    } else if (task.desc) {
      const ul = document.createElement('ul');
      const li = document.createElement('li');
      li.textContent = task.desc;
      ul.appendChild(li);
      listDiv.appendChild(ul);
    }
  }
  // Ìé∏Ïßë Ìèº ÌÜ†Í∏Ä Î∞è Ï†ÄÏû•/Ï∑®ÏÜå
  const editBtn = document.getElementById('task-edit-btn');
  const editForm = document.getElementById('task-edit-form');
  const descDiv = document.getElementById('detail-desc');
  const listDiv = document.getElementById('detail-list');
  const editStatus = document.getElementById('edit-status');
  const editTitle = document.getElementById('edit-title');
  const editGuideline = document.getElementById('edit-guideline');
  const editDescription = document.getElementById('edit-description');
  const editPriority = document.getElementById('edit-priority');
  const editEndDate = document.getElementById('edit-end-date');
  const saveBtn = document.getElementById('edit-save-btn');
  const cancelBtn = document.getElementById('edit-cancel-btn');
  let isEditing = false;
>>>>>>> Stashed changes

// --- ÌïÑÌÑ∞/Ï†ïÎ†¨ Í¥ÄÎ†® Î≥ÄÏàò ÏÑ†Ïñ∏ Î∞è Ïú†Ìã∏ Ìï®Ïàò Ï∂îÍ∞Ä ---
const filterDiffs = document.querySelectorAll('.filter-diff');
const filterStatuses = document.querySelectorAll('.filter-status');
const ddaySortBtn = document.querySelector('.filter-dday-sort');
const taskCardContainer = Array.from(document.querySelectorAll('.task-card'));

let ddayOrder = 'desc'; // Í∏∞Î≥∏Í∞í

// D-day ÌÖçÏä§Ìä∏Î•º Ïà´ÏûêÍ∞íÏúºÎ°ú Î≥ÄÌôò (D-5 ‚Üí 5, D-2 ‚Üí 2, D-1 ‚Üí 1, D-DAY ‚Üí 0)
function getDdayValue(text) {
  if (!text) return 9999;
  if (text.includes('D-DAY')) return 0;
  const match = text.match(/D-(\d+)/);
  if (match) return parseInt(match[1]);
  return 9999;
}

// Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅ Í∏∞Îä•
const searchInput = document.querySelector('.tasklist-search');
const cards = document.querySelectorAll('.task-card');
const toggles = document.querySelectorAll('.subtask-toggle');
const subtaskCards = document.querySelectorAll('.subtask-card');

searchInput.addEventListener('input', function() {
  const keyword = searchInput.value.trim().toLowerCase();
  cards.forEach((card, idx) => {
    const titleEl = card.querySelector('.task-title');
    const titleText = titleEl.textContent.toLowerCase();
    if (keyword === '' || titleText.includes(keyword)) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
<<<<<<< Updated upstream
=======
    // Í∏∞Ï°¥ Ìèº Î°úÏßÅ
    editForm.style.display = '';
    descDiv.style.display = 'none';
    listDiv.style.display = 'none';
    isEditing = true;
  }
  function hideEditForm() {
    editForm.style.display = 'none';
    // Ïà®Í≤ºÎçò ÏòÅÏó≠ Îã§Ïãú ÌëúÏãú
    document.getElementById('detail-header-row').style.display = '';
    document.getElementById('detail-meta-row').style.display = '';
    descDiv.style.display = '';
    listDiv.style.display = '';
    isEditing = false;
  }
  if (editBtn) {
    editBtn.addEventListener('click', function() {
      if (isEditing) return;
      showEditForm();
    });
  }
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function(e) {
      e.preventDefault();
      hideEditForm();
    });
  }
  if (editForm) {
    editForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      // DB Ï†ÄÏû• AJAX
      const payload = {
        status: editStatus.value,
        title: editTitle.value,
        guideline: editGuideline.value,
        description: editDescription.value,
        priority: editPriority.value,
        end_date: editEndDate.value
      };
      try {
        const resp = await fetch(`/mentee/task_update/${currentTask.id}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRFToken()
          },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.success) {
          // ÌîÑÎ°†Ìä∏ ÏÉÅÌÉúÎèÑ Î∞òÏòÅ
          currentTask.status = payload.status;
          currentTask.title = payload.title;
          currentTask.guideline = payload.guideline;
          currentTask.description = payload.description;
          currentTask.priority = payload.priority;
          currentTask.end_date = payload.end_date;
          // Ï¢åÏ∏° Ïπ¥ÎìúÎèÑ ÎèôÍ∏∞Ìôî
          const card = document.querySelector(`.task-card[data-task-id="${currentTask.id}"]`);
          if (card) {
            // ÏÉÅÌÉú Î±ÉÏßÄ
            const statusBadge = card.querySelector('.status-badge');
            if (statusBadge) {
              statusBadge.textContent = payload.status;
              statusBadge.className = 'status-badge';
              if (payload.status === 'ÏßÑÌñâ Ï†Ñ') statusBadge.classList.add('not-started');
              else if (payload.status === 'ÏßÑÌñâ Ï§ë') statusBadge.classList.add('in-progress');
              else if (payload.status === 'Í≤ÄÌÜ† ÏöîÏ≤≠') statusBadge.classList.add('review-requested');
              else if (payload.status === 'ÏôÑÎ£å' || payload.status === 'ÏôÑÎ£åÎê®') statusBadge.classList.add('done');
            }
            // Ï†úÎ™©
            const titleSpan = card.querySelector('.task-title');
            if (titleSpan) {
              titleSpan.textContent = payload.title;
              if (payload.status === 'ÏôÑÎ£å' || payload.status === 'ÏôÑÎ£åÎê®') titleSpan.classList.add('done');
              else titleSpan.classList.remove('done');
            }
            // Ïö∞ÏÑ†ÏàúÏúÑ Î±ÉÏßÄ
            const badge = card.querySelector('.task-badge');
            if (badge) {
              badge.textContent = payload.priority || 'Ìïò';
              badge.className = 'task-badge';
              if (payload.priority === 'ÏÉÅ') badge.classList.add('red');
              else if (payload.priority === 'Ï§ë') badge.classList.add('green');
              else badge.classList.add('yellow');
            }
            // ÎßàÍ∞êÏùº
            const dday = card.querySelector('.d-day-badge');
            if (dday) dday.textContent = payload.end_date || '';
            // ÏÑ§Î™Ö
            const descDiv = card.querySelector('.task-desc');
            if (descDiv) descDiv.textContent = payload.description || '';
            // Ïπ¥Îìú Ï†ÑÏ≤¥ ÌÅ¥ÎûòÏä§(ÏÉÅÌÉúÎ≥Ñ)
            card.classList.remove('not-started','in-progress','review-requested','done');
            if (payload.status === 'ÏßÑÌñâ Ï†Ñ') card.classList.add('not-started');
            else if (payload.status === 'ÏßÑÌñâ Ï§ë') card.classList.add('in-progress');
            else if (payload.status === 'Í≤ÄÌÜ† ÏöîÏ≤≠') card.classList.add('review-requested');
            else if (payload.status === 'ÏôÑÎ£å' || payload.status === 'ÏôÑÎ£åÎê®') card.classList.add('done');
          }
          updateDetailFromData(currentTask);
          hideEditForm();
        } else {
          alert('Ï†ÄÏû• Ïã§Ìå®: ' + (data.error || 'Ïò§Î•ò'));
        }
      } catch (err) {
        alert('Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + err);
      }
    });
  }
  async function fetchAndUpdateDetail(taskId) {
    try {
      const resp = await fetch(`/mentee/task_detail/${taskId}/`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      if (!resp.ok) throw new Error('ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§');
      const data = await resp.json();
      if (data.success && data.task) {
        updateDetailFromData(data.task);
      } else {
        console.error('Task detail fetch failed:', data.error);
        alert('Í≥ºÏ†ú ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
      }
    } catch (e) {
      console.error('Fetch error:', e);
      alert('ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§: ' + e.message);
    }
  }
  cards.forEach(card => {
    card.addEventListener('click', function() {
      if (isEditing) return; // Ìé∏Ïßë Ï§ëÏù¥Î©¥ Ïπ¥Îìú ÏÑ†ÌÉù ÎπÑÌôúÏÑ±Ìôî
      cards.forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      const taskId = card.getAttribute('data-task-id');
      if (taskId) fetchAndUpdateDetail(taskId);
    });
>>>>>>> Stashed changes
  });
});

// ÏôÑÎ£å TaskÏóê Ï∑®ÏÜåÏÑ† Ï†ÅÏö© (Ï¢åÏ∏° Î™©Î°ù)
cards.forEach((card, idx) => {
  const titleEl = card.querySelector('.task-title');
  if (details[idx] && (details[idx].status === 'ÏôÑÎ£åÎê®' || details[idx].status === 'ÏôÑÎ£å')) {
    titleEl.classList.add('done');
  } else {
    titleEl.classList.remove('done');
  }
});

// ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
function updateDetail(idx, subIdx = null) {
  let d = details[idx];
  if (subIdx !== null && d.subtasks && d.subtasks[subIdx]) {
    d = d.subtasks[subIdx];
  }
  // ÏÉÅÌÉú, D-day, ÎÇúÏù¥ÎèÑ ÎèôÏ†Å Ï†ÅÏö©
  const titleEl = document.getElementById('detail-title');
  let statusMap = [
    { text: 'ÏßÑÌñâ Ï†Ñ', color: 'not-started' },
    { text: 'ÏßÑÌñâ Ï§ë', color: 'in-progress' },
    { text: 'Í≤ÄÌÜ†ÏöîÏ≤≠', color: 'review-requested' },
    { text: 'ÏôÑÎ£å', color: 'done' }
  ];
  let dday = '';
  if(idx === 0) dday = 'D-5';
  else if(idx === 1) dday = 'D-2';
  else if(idx === 2) dday = 'D-1';
  else if(idx === 3) dday = 'D-DAY';
  let status = statusMap[idx];
  // ÌÉÄÏù¥ÌãÄ+exp Ìïú Ï§ÑÏóê Î∞∞Ïπò
  titleEl.innerHTML = `<span class="status-badge ${status.color}">${status.text}</span> <span class="${d.status === 'ÏôÑÎ£åÎê®' ? 'done' : ''}">${d.title}</span>`;
  if(d.status === 'ÏôÑÎ£åÎê®') {
    titleEl.classList.add('done');
  } else {
    titleEl.classList.remove('done');
  }
  // expÎèÑ Í∞ôÏùÄ Ï§ÑÏóê ÎèôÏ†Å Î∞òÏòÅ
  const xpEl = document.getElementById('detail-xp');
  if (xpEl) xpEl.innerHTML = `<span class="icon-trophy" style="font-size:15px;">üèÜ</span> ${d.xp || ''}`;
  document.getElementById('detail-desc').textContent = d.desc;
  // ÎÇúÏù¥ÎèÑ/ÎîîÎç∞Ïù¥ Î©îÌÉÄ(Ï§ëÎ≥µ ÏÉùÏÑ± Î∞©ÏßÄ)
  const metaRow = document.querySelector('.task-detail-meta-row');
  metaRow.innerHTML = `<span class="task-badge ${d.badge.color}" id="detail-badge">${d.badge.text}</span> <span class="d-day-badge">${dday}</span>`;
  // Î¶¨Ïä§Ìä∏
  const ul = document.createElement('ul');
  (d.list || []).forEach(item => {
    const li = document.createElement('li');
    li.textContent = item;
    ul.appendChild(li);
  });
  const listDiv = document.getElementById('detail-list');
  listDiv.innerHTML = '';
  listDiv.appendChild(ul);
  // ÎåìÍ∏Ä
  const chatDiv = document.querySelector('.task-detail-chat');
  const chatMsgs = (d.comments || []).map(c =>
    `<div class="chat-message${c.user === 'ÎÇò' ? ' mine' : ''}">
      <span class="chat-user">${c.user}</span>
      <span class="chat-text">${c.text}</span>
      <span class="chat-time">${c.time}</span>
    </div>`
  ).join('');
  chatDiv.innerHTML = chatMsgs + chatDiv.innerHTML.substring(chatDiv.innerHTML.indexOf('<div class="chat-input-row"'));
}

// Ïπ¥Îìú ÌÅ¥Î¶≠
cards.forEach((card, idx) => {
  card.addEventListener('click', function() {
    cards.forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    updateDetail(idx);
  });
});
// ÌïòÏúÑ ÌÉúÏä§ÌÅ¨ ÌÜ†Í∏Ä
toggles.forEach(toggle => {
  toggle.addEventListener('click', function(e) {
    e.stopPropagation();
    const idx = toggle.getAttribute('data-toggle');
    const list = document.getElementById('subtask-list-' + idx);
    if (list.classList.contains('open')) {
      list.classList.remove('open');
      toggle.textContent = '‚ñº';
    } else {
      list.classList.add('open');
      toggle.textContent = '‚ñ≤';
    }
  });
});
// ÌïòÏúÑ ÌÉúÏä§ÌÅ¨ ÌÅ¥Î¶≠ Ïãú ÏÉÅÏÑ∏ ÌëúÏãú
subtaskCards.forEach(card => {
  card.addEventListener('click', function(e) {
    e.stopPropagation();
    const [parentIdx, subIdx] = card.getAttribute('data-detail').split('-').map(Number);
    // ÏÉÅÏúÑ Ïπ¥Îìú ÏÑ†ÌÉù ÌëúÏãú
    cards.forEach(c => c.classList.remove('selected'));
    cards[parentIdx].classList.add('selected');
    updateDetail(parentIdx, subIdx);
  });
});
// ÏµúÏ¥à Î°úÎî© Ïãú Ï≤´ Î≤àÏß∏ Ïπ¥Îìú ÏÉÅÏÑ∏ ÌëúÏãú
updateDetail(0);

// ÌïÑÌÑ∞ Î≤ÑÌäº ÌÜ†Í∏Ä
const filterBtn = document.querySelector('.tasklist-filter-btn');
const filterPanel = document.querySelector('.tasklist-filter-panel');
filterBtn.addEventListener('click', function() {
  if (filterPanel.style.display === 'none') {
    filterPanel.style.display = 'block';
  } else {
    filterPanel.style.display = 'none';
  }
});

// ÌïÑÌÑ∞ + Í≤ÄÏÉâ ÎèôÏãú Ï†ÅÏö© Ìï®Ïàò
function getFilteredSortedIdxs() {
  // ÌïÑÌÑ∞ÎßÅ
  const diffChecked = Array.from(filterDiffs).filter(cb => cb.checked).map(cb => cb.value);
  const statusChecked = Array.from(filterStatuses).filter(cb => cb.checked).map(cb => cb.value);
  let idxs = details.map((d, i) => i);
  if (diffChecked.length > 0) {
    idxs = idxs.filter(i => diffChecked.includes(details[i].badge.text));
  }
  if (statusChecked.length > 0) {
    idxs = idxs.filter(i => statusChecked.includes(details[i].status));
  }
  // Í≤ÄÏÉâ
  const keyword = searchInput.value.trim().toLowerCase();
  if (keyword) {
    idxs = idxs.filter(i => details[i].title.toLowerCase().includes(keyword));
  }
  // D-day Ï†ïÎ†¨
  if (ddayOrder) {
    idxs.sort((a, b) => {
      // detailsÏóêÏÑú D-day Í∞íÏùÑ ÏßÅÏ†ë ÎπÑÍµê
      const ddayMap = ['D-5', 'D-2', 'D-1', 'D-DAY'];
      function getDetailDday(idx) {
        if (idx === 0) return 5;
        if (idx === 1) return 2;
        if (idx === 2) return 1;
        if (idx === 3) return 0;
        return 9999;
      }
      const aD = getDetailDday(a);
      const bD = getDetailDday(b);
      return ddayOrder === 'desc' ? aD - bD : bD - aD;
    });
  }
  return idxs;
}

function applyTaskFilterSort() {
  const idxs = getFilteredSortedIdxs();
  // Ïπ¥Îìú ÌëúÏãú/Ïà®ÍπÄ
  taskCardContainer.forEach((card, i) => card.style.display = 'none');
  idxs.forEach(idx => taskCardContainer[idx].style.display = '');
  // DOM ÏàúÏÑúÎèÑ Ïû¨Î∞∞Ïπò
  renderTaskCards(idxs);
}

// Ïπ¥Îìú DOMÏùÑ idxs ÏàúÏÑúÎåÄÎ°ú Ïû¨Î∞∞ÏπòÌïòÎäî Ìï®Ïàò Ï∂îÍ∞Ä
function renderTaskCards(idxs) {
  const container = document.getElementById('tasklist-left');
  // Í∏∞Ï°¥ Ïπ¥ÎìúÎì§Îßå Ï∂îÏ∂ú (task-card ÌÅ¥ÎûòÏä§)
  const allCards = Array.from(container.querySelectorAll('.task-card'));
  // idxs ÏàúÏÑúÎåÄÎ°ú append (Ïπ¥ÎìúÍ∞Ä Ïà®Í≤®Ï†∏ ÏûàÏñ¥ÎèÑ ÏàúÏÑú Ïú†ÏßÄ)
  idxs.forEach(idx => {
    container.appendChild(allCards[idx]);
  });
}

// Í≤ÄÏÉâ ÏûÖÎ†• ÏãúÏóêÎèÑ ÌïÑÌÑ∞+Ï†ïÎ†¨ ÎèôÏûë
searchInput.addEventListener('input', applyTaskFilterSort);
// Ï≤¥ÌÅ¨Î∞ïÏä§/Ï†ïÎ†¨ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
[...filterDiffs, ...filterStatuses].forEach(cb => cb.addEventListener('change', applyTaskFilterSort));
ddaySortBtn.addEventListener('click', function() {
  // ÌÜ†Í∏Ä asc/desc
  ddayOrder = ddayOrder === 'desc' ? 'asc' : 'desc';
  ddaySortBtn.dataset.order = ddayOrder;
  ddaySortBtn.textContent = ddayOrder === 'desc' ? '‚ñº' : '‚ñ≤';
  // Ï†ïÎ†¨ Î∞©Ìñ•Ïù¥ Î∞îÎÄî ÎïåÎßàÎã§ Ìï≠ÏÉÅ Ï†ïÎ†¨ Ï†ÅÏö©
  applyTaskFilterSort();
});
// ÌïÑÌÑ∞ Ìå®ÎÑê Ïó¥Î¶¥ ÎïåÎßàÎã§ Ï†ÅÏö©
filterBtn.addEventListener('click', applyTaskFilterSort);
// ÏµúÏ¥à Î°úÎî© ÏãúÏóêÎèÑ Ï†ÅÏö©
applyTaskFilterSort();
</script>
{% endblock %}
