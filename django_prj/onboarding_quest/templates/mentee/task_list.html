{% extends 'base.html' %}
{% load static %}

{% block title %}íƒœìŠ¤í¬ ëª©ë¡ í˜ì´ì§€{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/common/mentee_task_list.css' %}">
{% endblock %}
{% block content %}
<div class="tasklist-container">
  <!-- ì¢Œì¸¡: Task ëª©ë¡ -->
<div class="tasklist-left" id="tasklist-left">
  <div class="tasklist-title">Task ëª©ë¡</div>
  
  <!-- ì •ë ¬/í•„í„° ì»¨íŠ¸ë¡¤ -->
  <div class="task-controls" style="margin: 12px 0; padding: 8px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0;">
    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
      <label style="font-size: 13px; font-weight: 500; color: #333;">ì •ë ¬:</label>
      <select id="task-sort" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
        <option value="week">ì£¼ì°¨ë³„</option>
        <option value="deadline">ë§ˆê°ì¼ë³„</option>
      </select>
      
      <label style="font-size: 13px; font-weight: 500; color: #333; margin-left: 8px;">í•„í„°:</label>
      <select id="task-filter-status" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
        <option value="all">ì „ì²´ ìƒíƒœ</option>
        <option value="ì§„í–‰ì „">ì§„í–‰ ì „</option>
        <option value="ì§„í–‰ì¤‘">ì§„í–‰ ì¤‘</option>
        <option value="ê²€í† ìš”ì²­">ê²€í†  ìš”ì²­</option>
        <option value="ì™„ë£Œ">ì™„ë£Œ</option>
      </select>
      
      <select id="task-filter-priority" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
        <option value="all">ì „ì²´ ìš°ì„ ìˆœìœ„</option>
        <option value="ìƒ">ìƒ</option>
        <option value="ì¤‘">ì¤‘</option>
        <option value="í•˜">í•˜</option>
      </select>
    </div>
  </div>
  {% for week, tasks in week_tasks.items %}
    <div style="font-weight:bold; margin:18px 0 8px 0; color:#1976d2;">{{ week }}ì£¼ì°¨</div>
    {% for task in tasks %}
      {% if not task.parent %}
      <div class="task-card {% if forloop.first and forloop.parentloop.first %}selected{% endif %} {% if task.status == 'ì§„í–‰ì „' %}not-started{% elif task.status == 'ì§„í–‰ì¤‘' %}in-progress{% elif task.status == 'ê²€í† ìš”ì²­' %}review-requested{% elif task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}"
        data-task-id="{{ task.id }}"
        data-title="{{ task.title|escapejs }}"
        data-desc="{{ task.description|default_if_none:''|escapejs }}"
        data-priority="{{ task.priority|default:'í•˜'|escapejs }}"
        data-status="{{ task.status|escapejs }}"
        data-scheduled_end_date="{{ task.scheduled_end_date|date:'Y-m-d' }}"
        data-week="{{ week }}"
        data-dday="{{ task.dday|default_if_none:'' }}"
        >
        <div class="task-card-header">
          <span class="status-badge {% if task.status == 'ì§„í–‰ì „' %}not-started{% elif task.status == 'ì§„í–‰ì¤‘' %}in-progress{% elif task.status == 'ê²€í† ìš”ì²­' %}review-requested{% elif task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}">{{ task.status }}</span>
          <span class="task-title {% if task.status == 'ì™„ë£Œ' or task.status == 'ì™„ë£Œë¨' %}done{% endif %}">{{ task.title }}</span>
          {% if task.dday is not None %}
            <span class="task-dday {% if task.dday <= 1 %}urgent{% elif task.dday <= 3 %}warning{% endif %}">
              {% if task.dday >= 0 %}D-{{ task.dday }}{% else %}D+{% widthratio task.dday -1 1 %}{% endif %}
            </span>
          {% endif %}
        </div>
        <div class="task-desc-row">
          <div class="task-desc">{{ task.description }}</div>
          <div class="task-meta-row">
            <span class="task-badge {% if task.priority == 'ìƒ' %}red{% elif task.priority == 'ì¤‘' %}green{% else %}yellow{% endif %}">{{ task.priority|default:'í•˜' }}</span>
          </div>
        </div>
        {# ì§ì ‘ì ì¸ í•˜ìœ„ í…ŒìŠ¤í¬ë§Œ í•„í„°ë§ #}
        {% with direct_subtasks=task.subtasks|dictsort:'task_assign_id' %}
          {% if direct_subtasks and direct_subtasks|length > 0 %}
            <button type="button" class="subtask-toggle" style="margin:6px 0 0 0; font-size:13px; background:none; border:none; color:#1976d2; cursor:pointer;">â–¼ í•˜ìœ„ {{ direct_subtasks|length }}ê°œ</button>
            <div class="subtask-list" style="display:none; margin:6px 0 0 10px;">
              {% for sub in direct_subtasks %}
                <div class="subtask-item" data-task-id="{{ sub.task_assign_id }}" style="padding:4px 0 4px 12px; border-left:2px solid #e0e0e0; margin-bottom:2px; font-size:14px; color:#444; cursor:pointer; display: flex; align-items: center; gap: 6px;">
                  <span class="status-badge {% if sub.status == 'ì§„í–‰ì „' %}not-started{% elif sub.status == 'ì§„í–‰ì¤‘' %}in-progress{% elif sub.status == 'ê²€í† ìš”ì²­' %}review-requested{% elif sub.status == 'ì™„ë£Œ' or sub.status == 'ì™„ë£Œë¨' %}done{% endif %}" style="font-size: 11px; padding: 1px 8px;">{{ sub.status }}</span>
                  <span class="subtask-title" style="flex: 1;">{{ sub.title }}</span>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
      </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
</div>
  <!-- ìš°ì¸¡: ìƒì„¸ ì •ë³´ -->
  <div class="tasklist-right">
    <div class="task-detail-header" id="detail-header-row" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <!-- í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„± ëª¨ë‹¬ -->
      <div id="subtask-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:16px; min-width:420px; max-width:600px; padding:40px 36px 32px 36px; box-shadow:0 6px 32px rgba(0,0,0,0.20); position:relative;">
          <button id="subtask-close-btn" style="position:absolute; right:12px; top:10px; background:none; border:none; font-size:18px; color:#888; cursor:pointer; padding:0 4px; width:28px; height:28px; line-height:24px;">&times;</button>
          <form id="subtask-form">
            <div style="font-weight:bold; margin-bottom:18px;">í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„±</div>
            <div style="display:flex; gap:12px; margin-bottom:14px; align-items:flex-end;">
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">ìƒíƒœ</label>
                <select id="subtask-status" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;">
                  <option value="ì§„í–‰ì „">ì§„í–‰ ì „</option>
                  <option value="ì§„í–‰ì¤‘">ì§„í–‰ ì¤‘</option>
                  <option value="ê²€í† ìš”ì²­">ê²€í†  ìš”ì²­</option>
                  <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                </select>
              </div>
              <div style="flex:2;">
                <label style="font-size:17px; color:#222;">ìƒìœ„ Task</label>
                <input id="subtask-parent-title" type="text" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px; background:#f7f7f7;" readonly />
                <input id="subtask-parent-id" type="hidden" />
              </div>
            </div>
            <div style="margin-bottom:14px;">
              <label style="font-size:17px; color:#222;">ì œëª©</label>
              <input id="subtask-title" type="text" style="width:100%; margin-bottom:0; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" required />
            </div>
            <div style="margin-bottom:14px;">
              <label style="font-size:17px; color:#222;">ê°€ì´ë“œë¼ì¸</label>
              <input id="subtask-guideline" type="text" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
            </div>
            <div style="margin-bottom:14px;">
              <label style="font-size:17px; color:#222;">ì„¸ë¶€ë‚´ìš©</label>
              <textarea id="subtask-desc" style="width:100%; min-height:120px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:14px; align-items:flex-end;">
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">ìš°ì„ ìˆœìœ„</label>
                <select id="subtask-priority" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;">
                  <option value="">(ìƒìœ„ì™€ ë™ì¼)</option>
                  <option value="ìƒ">ìƒ</option>
                  <option value="ì¤‘">ì¤‘</option>
                  <option value="í•˜">í•˜</option>
                </select>
              </div>
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">ì‹œì‘ì¼</label>
                <input id="subtask-start-date" type="date" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;" />
              </div>
              <div style="flex:1;">
                <label style="font-size:17px; color:#222;">ë§ˆê°ì¼</label>
                <input id="subtask-end-date" type="date" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:7px; font-size:15px;" />
              </div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:18px;">
              <button type="submit" class="template-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:8px; padding:6px 18px; font-size:17px; cursor:pointer;">ìƒì„±</button>
              <button type="button" id="subtask-cancel-btn" class="template-btn" style="background:#eee; color:#222; font-weight:bold; border:none; border-radius:8px; padding:6px 18px; font-size:17px; cursor:pointer;">ì·¨ì†Œ</button>
            </div>
          </form>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span class="task-detail-title" id="detail-title">ì²« ë²ˆì§¸ í”„ë¡œì íŠ¸ ì°¸ì—¬í•˜ê¸°</span>
        <span class="task-detail-xp" id="detail-xp" style="color:#888; font-size:17px; display:flex; align-items:center; gap:4px; font-weight:bold;"><span class="icon-trophy" style="font-size:15px;">ğŸ†</span> 100 XP</span>
      </div>
      <div id="detail-header-btns" style="display:flex; gap:10px; margin-left:auto;">
        <button class="task-detail-edit-btn" id="task-edit-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;">í¸ì§‘</button>
        <button class="task-detail-subtask-btn" id="task-detail-subtask-btn" style="background:#e0e0e0; color:#222; font-weight:bold; border:none; border-radius:6px; padding:4px 12px; font-size:14px; cursor:pointer;">í•˜ìœ„ í…ŒìŠ¤í¬ ìƒì„±</button>
      </div>
    </div>
    <div class="task-detail-desc" id="detail-desc">ê°„ë‹¨í•œ í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•˜ì—¬ ì›Œí¬í”Œë¡œìš° ì´í•´í•˜ê¸°</div>
    <form id="task-edit-form" style="display:none; margin-bottom:12px;">
      <div style="display:flex; gap:10px; align-items:flex-end; margin-bottom:8px;">
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">ìƒíƒœ</label>
          <select id="edit-status" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;">
            <option value="ì§„í–‰ì „">ì§„í–‰ ì „</option>
            <option value="ì§„í–‰ì¤‘">ì§„í–‰ ì¤‘</option>
            <option value="ê²€í† ìš”ì²­">ê²€í†  ìš”ì²­</option>
            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
          </select>
        </div>
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">ìš°ì„ ìˆœìœ„</label>
          <select id="edit-priority" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;">
            <option value="ìƒ">ìƒ</option>
            <option value="ì¤‘">ì¤‘</option>
            <option value="í•˜">í•˜</option>
          </select>
        </div>
        <div style="flex:1;">
          <label style="font-weight:bold; color:#222;">ë§ˆê°ë‚ ì§œ</label>
          <input id="edit-end-date" type="date" style="width:100%; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
        </div>
      </div>
      <label style="font-weight:bold; color:#222;">ì œëª©</label>
      <input id="edit-title" type="text" style="width:100%; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;" />
      <label style="font-weight:bold; color:#222;">ê°€ì´ë“œë¼ì¸</label>
      <textarea id="edit-guideline" style="width:100%; min-height:60px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
      <label style="font-weight:bold; color:#222;">ì„¸ë¶€ë‚´ìš©(ì—¬ëŸ¬ ì¤„)</label>
      <textarea id="edit-description" style="width:100%; min-height:80px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc; padding:8px; font-size:15px;"></textarea>
      <div style="display:flex; gap:8px;">
        <button type="submit" id="edit-save-btn" style="background:#ffd600; color:#222; font-weight:bold; border:none; border-radius:6px; padding:6px 18px; font-size:15px; cursor:pointer;">ì €ì¥</button>
        <button type="button" id="edit-cancel-btn" style="background:#eee; color:#222; font-weight:bold; border:none; border-radius:6px; padding:6px 18px; font-size:15px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>
    </form>
    <div class="task-detail-meta-row" id="detail-meta-row">
      <span class="task-badge yellow" id="detail-badge">ì¤‘ê¸‰</span>
      <span class="d-day-badge" id="detail-dday"></span>
    </div>
    <div class="task-detail-divider"></div>
    <div class="task-detail-list" id="detail-list">
      <ul>
        <li>í”„ë¡œì íŠ¸ ì¤€ë¹„</li>
        <li>ì²« í”„ë¡œì íŠ¸ ì§„í–‰</li>
        <li>í”„ë¡œì íŠ¸ ê²°ê³¼ ê³µìœ </li>
      </ul>
    </div>
    <div class="task-detail-chat">
      <div id="chat-messages"></div>
      <div class="chat-input-row">
        <input type="text" class="chat-input" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
        <button class="chat-send-btn" id="chat-send-btn"><span style="font-size:20px;">ğŸ’¬</span></button>
      </div>
    </div>
  </div>
</div>
<script>
// Django í…œí”Œë¦¿ ë³€ìˆ˜ë¥¼ JavaScriptë¡œ ì „ë‹¬
window.mentorshipId = {% if mentorship_id %}'{{ mentorship_id }}'{% else %}null{% endif %};
</script>
<script src="{% static 'js/common/mentee_task_list.js' %}"></script>
{% endblock %}
