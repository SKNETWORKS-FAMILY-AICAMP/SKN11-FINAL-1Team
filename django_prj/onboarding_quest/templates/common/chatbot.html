{% extends "base.html" %}
{% load static %}

{% block title %}챗봇{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/common/chatbot.css' %}">
{% endblock %}

{% block content %}
<div class="chatbot-container">
  <!-- 좌측: 채팅 세션 목록 (카드형) -->
  <div class="chatbot-left">
    <div class="chatbot-title">채팅 세션</div>
    <div class="chatbot-session-list">
      {% if chat_sessions %}
        {% for session_data in chat_sessions %}
          {% with session=session_data.session messages=session_data.messages %}
            <div class="chatbot-session-item {% if forloop.first %}selected{% endif %}"
                 data-session-id="{{ session.session_id }}"
                 data-messages='[{% for msg in messages %}{"text":"{{ msg.message_text|escapejs }}","type":"{{ msg.message_type }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'>
              <div class="chatbot-session-title">
                {% if session.summary %}
                  {{ session.summary }}
                {% else %}
                  채팅 세션 #{{ session.session_id }}
                {% endif %}
              </div>
              <div class="chatbot-session-preview">
                {% if messages %}
                  {% with preview=None %}
                    {% for msg in messages %}
                      {% if msg.message_type == 'user' and not preview %}
                        {% with preview=msg.message_text %}{% endwith %}
                      {% endif %}
                    {% endfor %}
                    {% if preview %}
                      {{ preview|truncatechars:50 }}
                    {% else %}
                      {{ session.create_time|date:'Y-m-d H:i' }}
                    {% endif %}
                  {% endwith %}
                {% else %}
                  {{ session.create_time|date:'Y-m-d H:i' }}
                {% endif %}
              </div>
            </div>
          {% endwith %}
        {% endfor %}
      {% else %}
        <div class="no-sessions">채팅 세션이 없습니다.</div>
      {% endif %}
    </div>
  </div>
  
  <!-- 우측: 채팅 대화 영역 (카드형) -->
  <div class="chatbot-right">
    <div class="chatbot-chat-area" id="chatbot-chat-area">
      {% if chat_sessions %}
        {% with messages=chat_sessions.0.messages %}
          {% for msg in messages %}
            <div class="chatbot-msg-row {% if msg.message_type == 'user' %}user{% else %}bot{% endif %}">
              <div class="chatbot-msg-{{ msg.message_type }}">{{ msg.message_text }}</div>
            </div>
          {% endfor %}
        {% endwith %}
      {% else %}
        <div class="empty-chat">채팅 세션을 선택해주세요.</div>
      {% endif %}
    </div>
    <form method="post" class="chatbot-form-row">
      {% csrf_token %}
      <input type="text" name="message" class="chatbot-input" placeholder="메시지를 입력하세요..." required>
      <button type="submit" class="chatbot-send-btn">전송</button>
    </form>
  </div>
</div>

<script src="{% static 'js/common/chatbot.js' %}"></script>
{% endblock %}
