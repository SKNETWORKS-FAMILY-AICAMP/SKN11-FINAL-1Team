{% extends 'base.html' %}
{% load static %}

{% block title %}계정 추가/수정{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/account/user_add_modify.css' %}">
{% endblock %}

{% block content %}
  <div class="form-box">
    <h2>{% if edit_mode %}사원 정보 수정{% else %}계정 추가/수정{% endif %}</h2>
    <form method="post" autocomplete="off">
      {% csrf_token %}
      {% for field in form.visible_fields %}
        <div class="form-row">
          <label for="{{ field.id_for_label }}">
            {{ field.label }}
          </label>
          <div class="form-input-col">
            {{ field }}
            {% if field.help_text %}
              <div class="help-text">{{ field.help_text }}</div>
            {% endif %}
            {% for error in field.errors %}
              <div class="error-text">{{ error }}</div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
      <div class="button-row">
        <button class="btn-create" type="submit" id="submit-btn">
          <span class="btn-text">{% if edit_mode %}수정{% else %}생성{% endif %}</span>
          <span class="btn-loading" style="display: none;">
            <div class="loading-spinner"></div>
            {% if edit_mode %}수정중...{% else %}생성중...{% endif %}
          </span>
        </button>
        <button class="btn-cancel" type="button" onclick="window.location.href='/account/supervisor/';">취소</button>
      </div>
    </form>
  </div>

<script>
// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 메시지 표시 함수
function showMessage(message, type = 'success') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        transform: translateX(100%);
        transition: all 0.3s ease;
        ${type === 'success' ? 'background-color: #28a745;' : 'background-color: #dc3545;'}
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    // 슬라이드 인 애니메이션
    setTimeout(() => {
        messageDiv.style.transform = 'translateX(0)';
    }, 10);
    
    // 3초 후 자동 제거
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateX(100%)';
        setTimeout(() => messageDiv.remove(), 300);
    }, 3000);
}

// AJAX 폼 처리
document.addEventListener('DOMContentLoaded', function() {
    const userForm = document.querySelector('form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    const editMode = {{ edit_mode|yesno:"true,false" }};
    
    if (userForm) {
        userForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 로딩 상태 시작
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-flex';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(userForm);
                
                // FastAPI는 JSON을 선호하므로 FormData를 객체로 변환
                const formObject = {};
                formData.forEach((value, key) => {
                    // CSRF 토큰은 제외
                    if (key !== 'csrfmiddlewaretoken') {
                        // Django 폼 필드와 FastAPI 스키마 매핑
                        if (key === 'department') {
                            // department를 department_id로 변환
                            if (value) {
                                formObject['department_id'] = parseInt(value);
                            }
                        } else {
                            formObject[key] = value;
                        }
                    }
                });
                
                // UserCreate 스키마에 맞춰 필수 필드 설정
                if (!editMode) {
                    // 생성 모드일 때만 필수 필드 검증 및 기본값 설정
                    if (!formObject.password) {
                        formObject.password = 'temp123!'; // 임시 비밀번호
                    }
                    if (!formObject.join_date) {
                        formObject.join_date = new Date().toISOString().split('T')[0]; // 오늘 날짜
                    }
                    // 실제 입력값이 없을 때만 기본값 사용
                    if (!formObject.last_name || formObject.last_name.trim() === '') {
                        formObject.last_name = '성';
                    }
                    if (!formObject.first_name || formObject.first_name.trim() === '') {
                        formObject.first_name = '새사용자';
                    }

                    if (!formObject.job_part || formObject.job_part.trim() === '') {
                        formObject.job_part = '개발팀';
                    }
                    if (!formObject.position || formObject.position.trim() === '') {
                        formObject.position = '사원';
                    }
                    if (!formObject.role || formObject.role.trim() === '') {
                        formObject.role = 'mentee'; // 기본값은 멘티
                    }
                    if (!formObject.email || formObject.email.trim() === '') {
                        // 고유한 이메일 생성
                        const timestamp = Date.now();
                        formObject.email = `user${timestamp}@temp.com`;
                    }
                }
                
                // 빈 문자열을 null로 변환
                Object.keys(formObject).forEach(key => {
                    if (formObject[key] === '') {
                        formObject[key] = null;
                    }
                });
                
                console.log('Sending data:', formObject); // 디버깅용
                
                // FastAPI 서버 URL과 엔드포인트 (포트 8001에서 실행)
                const baseUrl = 'http://127.0.0.1:8001'; // FastAPI 서버 주소
                let apiUrl;
                
                if (editMode) {
                    // 수정 모드: URL에서 사용자 ID 추출
                    const pathParts = window.location.pathname.split('/');
                    // URL segments example: ["", "account", "user", "123", "modify", ""]
                    // userId is the segment before "modify"
                    const userId = pathParts[pathParts.length - 3];
                    apiUrl = `${baseUrl}/api/users/${userId}`;
                } else {
                    // 생성 모드
                    apiUrl = `${baseUrl}/api/users/`;
                }
                
                console.log('API URL:', apiUrl); // 디버깅용
                
                const response = await fetch(apiUrl, {
                    method: editMode ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(formObject)
                });
                
                console.log('Response status:', response.status); // 디버깅용
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Success result:', result); // 디버깅용
                    
                    // FastAPI 응답 형태에 따른 성공 판단
                    if (result.user_id || result.id || result.success !== false) {
                        const successMsg = editMode ? '사용자 정보가 성공적으로 수정되었습니다!' : '사용자가 성공적으로 생성되었습니다!';
                        showMessage(successMsg);
                        
                        // 생성 성공 후 약간의 지연을 두고 페이지 이동 (데이터 동기화 대기)
                        setTimeout(() => {
                            window.location.href = '/account/supervisor/?refresh=' + Date.now();
                        }, 2000); // 2초 지연
                    } else {
                        throw new Error(result.detail || result.message || '처리 중 오류가 발생했습니다.');
                    }
                } else {
                    // 에러 응답 처리
                    let errorMessage = `서버 오류 (${response.status})`;
                    
                    try {
                        const errorResult = await response.json();
                        console.log('Error result:', errorResult); // 디버깅용
                        
                        if (errorResult.detail) {
                            // FastAPI validation error 형식
                            if (Array.isArray(errorResult.detail)) {
                                const errors = errorResult.detail.map(err => `${err.loc?.join('.')}: ${err.msg}`).join('\n');
                                errorMessage = `입력 오류:\n${errors}`;
                            } else {
                                errorMessage = errorResult.detail;
                            }
                        } else if (errorResult.error) {
                            errorMessage = `서버 오류: ${errorResult.error}`;
                        } else if (errorResult.message) {
                            errorMessage = errorResult.message;
                        }
                        
                        console.log('Full error object:', errorResult); // 전체 에러 객체 로깅
                    } catch (jsonError) {
                        console.error('JSON 파싱 실패:', jsonError);
                        errorMessage = `서버 오류 (${response.status}): 응답을 파싱할 수 없습니다`;
                    }
                    
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('사용자 처리 오류:', error);
                showMessage(error.message || '처리 중 오류가 발생했습니다.', 'error');
            } finally {
                // 로딩 상태 종료
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    }
});

// 로딩 스피너 스타일 추가
const style = document.createElement('style');
style.textContent = `
.loading-spinner {
    width: 12px;
    height: 12px;
    border: 2px solid #ffffff33;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 5px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.btn-loading {
    display: inline-flex;
    align-items: center;
}
`;
document.head.appendChild(style);
</script>
{% endblock %}
