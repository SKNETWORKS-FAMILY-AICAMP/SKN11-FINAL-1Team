{% extends 'base.html' %}
{% load static %}

{% block title %}관리자 대시보드{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/account/supervisor.css' %}">
{% endblock %}

{% block content %}
<h1>관리자 대시보드</h1>
<div class="dashboard" style="display:flex; gap:30px; align-items:flex-start;">
    <!-- =================== 부서 관리 영역 =================== -->
    <div style="flex:1; min-width:260px; max-width:400px;">
        {# 부서 리스트 테이블 #}
        <table style="width:100%; margin:16px 0 12px 0; border-collapse:collapse;">
            <thead>
                <tr>
                    <th>부서명</th>
                </tr>
            </thead>
            <tbody>
                <tr class="{% if not selected_department_id %}selected-dept-row{% endif %}">
                    <td class="dept-cell">
                        <a href="?" class="dept-link{% if not selected_department_id %} selected{% endif %}">전체</a>
                    </td>
                </tr>
                {% for dept in departments %}
                <tr class="{% if dept.department_id == selected_department_id %}selected-dept-row{% endif %}">
                    <td class="dept-cell">
                        <a href="?dept={{ dept.department_id }}" class="dept-link{% if dept.department_id == selected_department_id %} selected{% endif %}">{{ dept.department_name }}</a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="2" class="no-dept">등록된 부서가 없습니다.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- =================== 부서 등록/수정 폼 =================== -->
        <div id="dept-form-box" style="margin-top:24px; background:#f8f8f8; border-radius:10px; padding:18px 16px;">
            <h2>부서 정보</h2>
            {% if selected_department_id and dept_detail %}
            <!-- 선택된 부서 정보 표시 -->
            <div style="margin-bottom:14px; background:#f0f6ff; border-radius:8px; padding:12px 14px; border:1px solid #b6d4fe;">
                <b>부서명:</b> {{ dept_detail.department_name|default:"-" }}<br>
                <b>설명:</b> {{ dept_detail.description|default:"-" }}<br>
            </div>
            <!-- 부서 수정 폼 (DepartmentForm 사용) -->
            <form method="post" action="{% url 'account:department_update' dept_detail.department_id %}" style="margin-bottom:0;">
                {% csrf_token %}
                <div style="margin-bottom:12px;">
                    <label for="id_department_name">부서명</label><br>
                    {{ dept_form.department_name }}
                </div>
                <div style="margin-bottom:12px;">
                    <label for="id_description">설명</label><br>
                    {{ dept_form.description }}
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button type="submit" class="icon-btn dept-update-btn" title="수정 저장" style="background:#2563eb; border:none; padding:6px 10px; border-radius:5px; color:#fff; display:flex; align-items:center;">
                        <span class="btn-content">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6.536-6.536a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-2.828 0L5.232 11.232a2 2 0 010-2.828L9 13z"/></svg>
                        </span>
                        <span class="btn-loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            저장중...
                        </span>
                    </button>
                    <a href="{% url 'account:department_delete' dept_detail.department_id %}" class="icon-btn dept-delete-btn" title="삭제" style="background:#f87171; border:none; padding:6px 10px; border-radius:5px; color:#fff; display:flex; align-items:center;" onclick="return confirm('정말 삭제하시겠습니까?');">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </a>
                </div>
            </form>
            {% else %}
            <!-- 부서 등록 폼 (DepartmentForm 사용) -->
            <form method="post" action="{% url 'account:department_create' %}">
                {% csrf_token %}
                <div style="margin-bottom:12px;">
                    <label for="id_department_name">부서명</label><br>
                    {{ dept_form.department_name }}
                </div>
                <div style="margin-bottom:12px;">
                    <label for="id_description">설명</label><br>
                    {{ dept_form.description }}
                </div>
                <button type="submit" class="icon-btn dept-create-btn" title="등록" style="background:#2563eb; border:none; padding:6px 10px; border-radius:5px; color:#fff; display:flex; align-items:center;">
                    <span class="btn-content">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    </span>
                    <span class="btn-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        등록중...
                    </span>
                </button>
            </form>
            {% endif %}
        </div>
    </div>
    <!-- =================== 유저 관리 영역 =================== -->
    <div style="flex:2; min-width:340px;">
        {# 유저 상단바 #}
        <div class="top-bar" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <!-- 검색 및 필터 영역 -->
            <div class="search-filters" style="display:flex; gap:10px; align-items:center;">
                <form method="get" style="display:flex; gap:10px; align-items:center;">
                    <input type="text" name="search" placeholder="사번, 이름, 이메일 검색" value="{{ search_query }}" 
                           style="padding:6px 12px; border:1px solid #ddd; border-radius:4px; width:200px;">
                    
                    {% if selected_department_id %}
                    <input type="hidden" name="dept" value="{{ selected_department_id }}">
                    {% endif %}
                    
                    <button type="submit" class="btn" style="padding:6px 12px; background:#2563eb; color:white; border:none; border-radius:4px; cursor:pointer;">검색</button>
                    <a href="{% url 'account:supervisor' %}" class="btn" style="padding:6px 12px; background:#6b7280; color:white; text-decoration:none; border-radius:4px;">초기화</a>
                </form>
            </div>
            
            <a href="{% url 'account:user_create' %}" class="btn">+ 신규 유저 등록</a>
        </div>
        
        <!-- js, css는 별도 파일로 분리 -->
        {# 유저 리스트 테이블 #}
        <table>
            <thead>
                <tr>
                    <th>사번</th>
                    <th>이름</th>
                    <th>이메일</th>
                    <th>부서</th>
                    <th>직급</th>
                    <th>입사일</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ u.employee_number }}</td>
                    <td>{{ u.last_name }}{{ u.first_name }}</td>
                    <td>{{ u.email }}</td>
                    <td>{{ u.department.department_name }}</td>
                    <td>{{ u.position }}</td>
                    <td>{{ u.join_date|date:"Y-m-d" }}</td>
                    <td>
                        <a href="{% url 'account:user_update' u.pk %}" class="edit-link action-link" title="수정" style="margin-right:6px; display:inline-block; vertical-align:middle;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6.536-6.536a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-2.828 0L5.232 11.232a2 2 0 010-2.828L9 13z"/></svg>
                        </a>
                        <button onclick="resetPassword({{ u.user_id }})" class="password-reset-btn action-link" title="비밀번호 초기화" style="margin-right:6px; display:inline-block; vertical-align:middle; background:none; border:none; color:#f59e0b; cursor:pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m0 0a2 2 0 01-2 2m2-2h3M9 7H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-5m-9-9L12 3l4 4"/></svg>
                        </button>
                        <a href="{% url 'account:user_delete' u.pk %}" class="delete-link action-link" title="삭제" onclick="return confirm('정말 삭제하시겠습니까?');" style="display:inline-block; vertical-align:middle;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7">등록된 직원이 없습니다.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function resetPassword(userId) {
    if (confirm('이 사용자의 비밀번호를 초기화하시겠습니까? (초기화 후 비밀번호: 123)')) {
        fetch(`/account/user/${userId}/password_reset/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('비밀번호 초기화 중 오류가 발생했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('비밀번호 초기화 중 오류가 발생했습니다.');
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 메시지 표시 함수
function showMessage(message, type = 'success') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        transform: translateX(100%);
        transition: all 0.3s ease;
        ${type === 'success' ? 'background-color: #28a745;' : 'background-color: #dc3545;'}
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    // 슬라이드 인 애니메이션
    setTimeout(() => {
        messageDiv.style.transform = 'translateX(0)';
    }, 10);
    
    // 3초 후 자동 제거
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateX(100%)';
        setTimeout(() => messageDiv.remove(), 300);
    }, 3000);
}

// 부서 폼 AJAX 처리
document.addEventListener('DOMContentLoaded', function() {
    const deptForms = document.querySelectorAll('form[action*="department"]');
    
    deptForms.forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnContent = submitBtn.querySelector('.btn-content');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            // 로딩 상태 시작
            if (btnContent && btnLoading) {
                btnContent.style.display = 'none';
                btnLoading.style.display = 'inline-flex';
            }
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(form);
                
                const response = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const isCreate = form.action.includes('create');
                        const successMsg = isCreate ? '부서가 성공적으로 생성되었습니다!' : '부서 정보가 성공적으로 수정되었습니다!';
                        showMessage(successMsg);
                        
                        // 1초 후 페이지 새로고침
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        throw new Error(result.error || '부서 처리 중 오류가 발생했습니다.');
                    }
                } else {
                    const errorText = await response.text();
                    throw new Error(`서버 오류 (${response.status}): ${errorText}`);
                }
            } catch (error) {
                console.error('부서 처리 오류:', error);
                showMessage(error.message || '부서 처리 중 오류가 발생했습니다.', 'error');
            } finally {
                // 로딩 상태 종료
                if (btnContent && btnLoading) {
                    btnContent.style.display = 'inline-flex';
                    btnLoading.style.display = 'none';
                }
                submitBtn.disabled = false;
            }
        });
    });
});

// 로딩 스피너 스타일 추가
const style = document.createElement('style');
style.textContent = `
.loading-spinner {
    width: 12px;
    height: 12px;
    border: 2px solid #ffffff33;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 5px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.btn-loading {
    display: inline-flex;
    align-items: center;
}
`;
document.head.appendChild(style);
</script>
{% endblock %}