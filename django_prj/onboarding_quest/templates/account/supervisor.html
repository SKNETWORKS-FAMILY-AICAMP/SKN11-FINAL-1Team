{% extends 'base.html' %}
{% load static %}

{% block title %}관리자 계정관리{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/account/supervisor.css' %}">
{% endblock %}

{% block content %}
  <h2>관리자 계정관리</h2>

<<<<<<< Updated upstream
  <div class="top-bar">
    <a href="/account/user_add_modify/" class="add-user-btn">+ 신규 유저 등록</a>
  </div>

  <table>
    <thead>
      <tr>
        <th>이름</th>
        <th>입사일</th>
        <th>직급</th>
        <th>부서</th>
        <th>액션</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>김하늘</td>
        <td>2022-03-15</td>
        <td>대리</td>
        <td>개발팀</td>
        <td>
          <a href="/account/user_add_modify/" class="edit-link">수정</a> |
          <a href="/account/change_pwd/" class="edit-link">비밀번호 변경</a> |
          <a href="#" class="delete-link">삭제</a>
        </td>
      </tr>
      <tr>
        <td>이준석</td>
        <td>2023-07-01</td>
        <td>사원</td>
        <td>마케팅팀</td>
        <td>
          <a href="/account/user_add_modify/" class="edit-link">수정</a> |
          <a href="/account/change_pwd/" class="edit-link">비밀번호 변경</a> |
          <a href="#" class="delete-link">삭제</a>
        </td>
      </tr>
      <tr>
        <td>박소영</td>
        <td>2021-11-25</td>
        <td>과장</td>
        <td>인사팀</td>
        <td>
          <a href="/account/user_add_modify/" class="edit-link">수정</a> |
          <a href="/account/change_pwd/" class="edit-link">비밀번호 변경</a> |
          <a href="#" class="delete-link">삭제</a>
        </td>
      </tr>
      <tr>
        <td>정지훈</td>
        <td>2024-01-10</td>
        <td>사원</td>
        <td>디자인팀</td>
        <td>
          <a href="/account/user_add_modify/" class="edit-link">수정</a> |
          <a href="/account/change_pwd/" class="edit-link">비밀번호 변경</a> |
          <a href="#" class="delete-link">삭제</a>
        </td>
      </tr>
      <tr>
        <td>최유진</td>
        <td>2020-05-30</td>
        <td>차장</td>
        <td>영업팀</td>
        <td>
          <a href="/account/user_add_modify/" class="edit-link">수정</a> |
          <a href="/account/change_pwd/" class="edit-link">비밀번호 변경</a> |
          <a href="#" class="delete-link">삭제</a>
        </td>
      </tr>
    </tbody>
  </table>
=======
        <!-- =================== 부서 등록/수정 폼 =================== -->
        <div id="dept-form-box" style="margin-top:24px; background:#f8f8f8; border-radius:10px; padding:18px 16px;">
            <h2>부서 정보</h2>
            {% if selected_department_id and dept_detail %}
            <!-- 선택된 부서 정보 표시 -->
            <div style="margin-bottom:14px; background:#f0f6ff; border-radius:8px; padding:12px 14px; border:1px solid #b6d4fe;">
                <b>부서명:</b> {{ dept_detail.department_name|default:"-" }}<br>
                <b>설명:</b> {{ dept_detail.description|default:"-" }}<br>
            </div>
            <!-- 부서 수정 폼 -->
            <form method="post" action="{% url 'account:department_update' dept_detail.department_id %}" style="margin-bottom:0;">
                {% csrf_token %}
                <div style="margin-bottom:12px;">
                    <label for="id_department_name">부서명</label><br>
                    <input type="text" id="id_department_name" name="department_name" value="{{ dept_form.department_name }}" required style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
                </div>
                <div style="margin-bottom:12px;">
                    <label for="id_description">설명</label><br>
                    <textarea id="id_description" name="description" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; height:80px;">{{ dept_form.description }}</textarea>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button type="submit" class="icon-btn" title="수정 저장" style="background:#2563eb; border:none; padding:6px 10px; border-radius:5px; color:#fff; display:flex; align-items:center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6.536-6.536a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-2.828 0L5.232 11.232a2 2 0 010-2.828L9 13z"/></svg>
                    </button>
                    <a href="{% url 'account:department_delete' dept_detail.department_id %}" class="icon-btn" title="삭제" style="background:#f87171; border:none; padding:6px 10px; border-radius:5px; color:#fff; display:flex; align-items:center;" onclick="return confirm('정말 삭제하시겠습니까?');">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </a>
                </div>
            </form>
            {% else %}
            <!-- 부서 등록 폼 -->
            <form method="post" action="{% url 'account:department_create' %}">
                {% csrf_token %}
                <div style="margin-bottom:12px;">
                    <label for="id_department_name">부서명</label><br>
                    <input type="text" id="id_department_name" name="department_name" placeholder="부서명을 입력하세요" required style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
                </div>
                <div style="margin-bottom:12px;">
                    <label for="id_description">설명</label><br>
                    <textarea id="id_description" name="description" placeholder="부서 설명을 입력하세요" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; height:80px;"></textarea>
                </div>
                <button type="submit" class="icon-btn" title="등록" style="background:#2563eb; border:none; padding:6px 10px; border-radius:5px; color:#fff; display:flex; align-items:center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                </button>
            </form>
            {% endif %}
        </div>
    </div>
    <!-- =================== 유저 관리 영역 =================== -->
    <div style="flex:2; min-width:340px;">
        {# 유저 상단바 #}
        <div class="top-bar" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <!-- 검색 및 필터 영역 -->
            <div class="search-filters" style="display:flex; gap:10px; align-items:center;">
                <form method="get" style="display:flex; gap:10px; align-items:center;">
                    <input type="text" name="search" placeholder="사번, 이름, 이메일 검색" value="{{ search_query }}" 
                           style="padding:6px 12px; border:1px solid #ddd; border-radius:4px; width:200px;">
                    
                    <select name="position" style="padding:6px 12px; border:1px solid #ddd; border-radius:4px;">
                        <option value="">전체 직급</option>
                        {% for position in positions %}
                        <option value="{{ position }}" {% if position == position_filter %}selected{% endif %}>{{ position }}</option>
                        {% endfor %}
                    </select>
                    
                    {% if selected_department_id %}
                    <input type="hidden" name="dept" value="{{ selected_department_id }}">
                    {% endif %}
                    
                    <button type="submit" class="btn" style="padding:6px 12px; background:#2563eb; color:white; border:none; border-radius:4px; cursor:pointer;">검색</button>
                    <a href="{% url 'account:supervisor' %}" class="btn" style="padding:6px 12px; background:#6b7280; color:white; text-decoration:none; border-radius:4px;">초기화</a>
                </form>
            </div>
            
            <button onclick="toggleUserForm()" class="btn" style="padding:6px 12px; background:#10b981; color:white; border:none; border-radius:4px; cursor:pointer;">+ 신규 유저 등록</button>
        </div>
        
        <!-- 사용자 생성 폼 -->
        <div id="user-create-form" style="display:none; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:20px; margin-bottom:16px;">
            <h3 style="margin-bottom:16px; color:#374151;">신규 사용자 등록</h3>
            <form method="post" action="{% url 'account:user_create' %}" style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                {% csrf_token %}
                <div>
                    <label style="display:block; margin-bottom:4px; font-weight:600; color:#374151;">이메일 (필수)</label>
                    <input type="email" name="email" required style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:4px; font-weight:600; color:#374151;">사번 (필수)</label>
                    <input type="number" name="employee_number" required style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:4px; font-weight:600; color:#374151;">성 (필수)</label>
                    <input type="text" name="last_name" required style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:4px; font-weight:600; color:#374151;">이름 (필수)</label>
                    <input type="text" name="first_name" required style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:4px; font-weight:600; color:#374151;">부서</label>
                    <select name="department_id" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
                        <option value="">부서 선택</option>
                        {% for dept in departments %}
                        <option value="{{ dept.department_id }}">{{ dept.department_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label style="display:block; margin-bottom:4px; font-weight:600; color:#374151;">직급</label>
                    <input type="text" name="position" placeholder="예: 주임, 대리, 과장" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:4px; font-weight:600; color:#374151;">직무</label>
                    <input type="text" name="job_part" placeholder="예: 개발, 기획, 디자인" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:4px; font-weight:600; color:#374151;">역할</label>
                    <select name="role" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
                        <option value="mentee">멘티</option>
                        <option value="mentor">멘토</option>
                    </select>
                </div>
                <div style="grid-column:span 2; display:flex; gap:8px; justify-content:flex-end;">
                    <button type="button" onclick="toggleUserForm()" style="padding:8px 16px; background:#6b7280; color:white; border:none; border-radius:4px; cursor:pointer;">취소</button>
                    <button type="submit" style="padding:8px 16px; background:#10b981; color:white; border:none; border-radius:4px; cursor:pointer;">등록</button>
                </div>
            </form>
        </div>
        
        <!-- js, css는 별도 파일로 분리 -->
        {# 유저 리스트 테이블 #}
        <table>
            <thead>
                <tr>
                    <th>사번</th>
                    <th>이름</th>
                    <th>이메일</th>
                    <th>부서</th>
                    <th>직급</th>
                    <th>입사일</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ u.employee_number }}</td>
                    <td>{{ u.last_name }}{{ u.first_name }}</td>
                    <td>{{ u.email }}</td>
                    <td>{{ u.department.department_name }}</td>
                    <td>{{ u.position }}</td>
                    <td>{{ u.join_date|date:"Y-m-d" }}</td>
                    <td>
                        <a href="{% url 'account:user_update' u.pk %}" class="edit-link action-link" title="수정" style="margin-right:6px; display:inline-block; vertical-align:middle;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6.536-6.536a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-2.828 0L5.232 11.232a2 2 0 010-2.828L9 13z"/></svg>
                        </a>
                        <button onclick="resetPassword({{ u.user_id }})" class="password-reset-btn action-link" title="비밀번호 초기화" style="margin-right:6px; display:inline-block; vertical-align:middle; background:none; border:none; color:#f59e0b; cursor:pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m0 0a2 2 0 01-2 2m2-2h3M9 7H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-5m-9-9L12 3l4 4"/></svg>
                        </button>
                        <a href="{% url 'account:user_delete' u.pk %}" class="delete-link action-link" title="삭제" onclick="return confirm('정말 삭제하시겠습니까?');" style="display:inline-block; vertical-align:middle;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="vertical-align:middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7">등록된 직원이 없습니다.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function resetPassword(userId) {
    if (confirm('이 사용자의 비밀번호를 초기화하시겠습니까? (초기화 후 비밀번호: 123)')) {
        fetch(`/account/user/${userId}/password_reset/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('비밀번호 초기화 중 오류가 발생했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('비밀번호 초기화 중 오류가 발생했습니다.');
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleUserForm() {
    const form = document.getElementById('user-create-form');
    if (form.style.display === 'none' || form.style.display === '') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
}
</script>
>>>>>>> Stashed changes
{% endblock %}